<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.67" />
    <meta name="theme" content="VuePress Theme Hope" />
    <title>Spring Cloud Ribbon 源码解析 | -_- !</title><meta name="description" content="good night !">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-f4247c06.css" as="style"><link rel="stylesheet" href="/assets/style-f4247c06.css">
    <link rel="modulepreload" href="/assets/app-9aa256ea.js"><link rel="modulepreload" href="/assets/spring-cloud-ribbon.html-d8a62676.js"><link rel="modulepreload" href="/assets/spring-cloud-ribbon.html-e86d0416.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js"><link rel="prefetch" href="/assets/index.html-130ecd90.js" as="script"><link rel="prefetch" href="/assets/database-overview.html-03717758.js" as="script"><link rel="prefetch" href="/assets/new-concept-2.html-4471fd4d.js" as="script"><link rel="prefetch" href="/assets/java-overview.html-49f1be9c.js" as="script"><link rel="prefetch" href="/assets/middleware-overview.html-be4fdd51.js" as="script"><link rel="prefetch" href="/assets/quality-overview.html-a8e9bda4.js" as="script"><link rel="prefetch" href="/assets/spring-cloud-overview.html-eb7abca7.js" as="script"><link rel="prefetch" href="/assets/gitbook.html-f2319ef4.js" as="script"><link rel="prefetch" href="/assets/tools-overview.html-cf0e5bf6.js" as="script"><link rel="prefetch" href="/assets/mongo.html-2ab52e79.js" as="script"><link rel="prefetch" href="/assets/mysql-advance.html-b13e5f8a.js" as="script"><link rel="prefetch" href="/assets/mysql-apply.html-a6b2d1c2.js" as="script"><link rel="prefetch" href="/assets/mysql-base.html-3cf280af.js" as="script"><link rel="prefetch" href="/assets/mysql-devops.html-f2c73032.js" as="script"><link rel="prefetch" href="/assets/redis-action.html-a3045ac9.js" as="script"><link rel="prefetch" href="/assets/redis-base.html-65a1be1c.js" as="script"><link rel="prefetch" href="/assets/redis-cluster.html-dd5a3b3e.js" as="script"><link rel="prefetch" href="/assets/redis-overview.html-4a3dba49.js" as="script"><link rel="prefetch" href="/assets/java-annotation.html-ef20db56.js" as="script"><link rel="prefetch" href="/assets/java-base.html-ed910b21.js" as="script"><link rel="prefetch" href="/assets/java-enum.html-afe8aeb1.js" as="script"><link rel="prefetch" href="/assets/java-reflect.html-0178e6e8.js" as="script"><link rel="prefetch" href="/assets/java-regex.html-ea5302f5.js" as="script"><link rel="prefetch" href="/assets/java-sql.html-f3768bbb.js" as="script"><link rel="prefetch" href="/assets/java-time.html-2c855f9e.js" as="script"><link rel="prefetch" href="/assets/java-version-feature.html-0514c3a5.js" as="script"><link rel="prefetch" href="/assets/java-collection-list.html-fbfca1ef.js" as="script"><link rel="prefetch" href="/assets/java-collection-map.html-15307947.js" as="script"><link rel="prefetch" href="/assets/heima-concurrent-base.html-764658bc.js" as="script"><link rel="prefetch" href="/assets/java-concurrent-base.html-527f93a9.js" as="script"><link rel="prefetch" href="/assets/Java-concurrent-container.html-9e302a0b.js" as="script"><link rel="prefetch" href="/assets/java-concurrent-interview.html-bbc0a621.js" as="script"><link rel="prefetch" href="/assets/java-concurrent-lock.html-41f5cb73.js" as="script"><link rel="prefetch" href="/assets/java-concurrent-pool.html-05c10061.js" as="script"><link rel="prefetch" href="/assets/java-concurrent-tools.html-01a740a1.js" as="script"><link rel="prefetch" href="/assets/java-bio.html-ee55c8f8.js" as="script"><link rel="prefetch" href="/assets/java-io.html-7f9ff9da.js" as="script"><link rel="prefetch" href="/assets/java-nio.html-46b166f9.js" as="script"><link rel="prefetch" href="/assets/java-memory-model.html-7958112b.js" as="script"><link rel="prefetch" href="/assets/jvm-class-file-structure.html-c097e686.js" as="script"><link rel="prefetch" href="/assets/jvm-class-loader.html-d0382e33.js" as="script"><link rel="prefetch" href="/assets/jvm-garbage-collection.html-ad2dc850.js" as="script"><link rel="prefetch" href="/assets/jvm-memory-structure.html-e31bda30.js" as="script"><link rel="prefetch" href="/assets/JVM概览.html-eda595c7.js" as="script"><link rel="prefetch" href="/assets/JVM调优.html-d0f59301.js" as="script"><link rel="prefetch" href="/assets/java-servlet.html-654d0068.js" as="script"><link rel="prefetch" href="/assets/java-lambda.html-c21b5e3b.js" as="script"><link rel="prefetch" href="/assets/java-stream.html-797890ef.js" as="script"><link rel="prefetch" href="/assets/HikariCP-base.html-ec5c9222.js" as="script"><link rel="prefetch" href="/assets/HikariCP-source.html-71542b59.js" as="script"><link rel="prefetch" href="/assets/jackson-overview.html-15f61ae4.js" as="script"><link rel="prefetch" href="/assets/kafka-broker.html-f3939976.js" as="script"><link rel="prefetch" href="/assets/kafka-consumer.html-f5b2d049.js" as="script"><link rel="prefetch" href="/assets/kafka-old.html-18104567.js" as="script"><link rel="prefetch" href="/assets/kafka-overview.html-0029d53e.js" as="script"><link rel="prefetch" href="/assets/kafka-producer.html-94380090.js" as="script"><link rel="prefetch" href="/assets/spring-kafka.html-bc75ec45.js" as="script"><link rel="prefetch" href="/assets/log-framework.html-1135605f.js" as="script"><link rel="prefetch" href="/assets/1.Hello World.html-44c17b24.js" as="script"><link rel="prefetch" href="/assets/2.Global Config.html-c6cf8642.js" as="script"><link rel="prefetch" href="/assets/mybatis-plus.html-47dc6415.js" as="script"><link rel="prefetch" href="/assets/index.html-91838e99.js" as="script"><link rel="prefetch" href="/assets/nginx.html-482342f3.js" as="script"><link rel="prefetch" href="/assets/sharding-sphere.html-5419590f.js" as="script"><link rel="prefetch" href="/assets/data-structure-dynamic.html-4f7b0965.js" as="script"><link rel="prefetch" href="/assets/data-structure-list.html-a268df29.js" as="script"><link rel="prefetch" href="/assets/data-structure-overview.html-85d0b05a.js" as="script"><link rel="prefetch" href="/assets/data-structure-tree.html-6f24b217.js" as="script"><link rel="prefetch" href="/assets/shiro-overview.html-e42cf658.js" as="script"><link rel="prefetch" href="/assets/tomcat.html-eb4a9dda.js" as="script"><link rel="prefetch" href="/assets/xxl-job.html-134d207a.js" as="script"><link rel="prefetch" href="/assets/design-adapter.html-3e892dc7.js" as="script"><link rel="prefetch" href="/assets/design-bridge.html-91b363b8.js" as="script"><link rel="prefetch" href="/assets/design-builder.html-6fd2408c.js" as="script"><link rel="prefetch" href="/assets/design-chain.html-73c4f586.js" as="script"><link rel="prefetch" href="/assets/design-command.html-d6dfccee.js" as="script"><link rel="prefetch" href="/assets/design-composite.html-057a7bcf.js" as="script"><link rel="prefetch" href="/assets/design-decorator.html-1955d9ac.js" as="script"><link rel="prefetch" href="/assets/design-facade.html-c34c2259.js" as="script"><link rel="prefetch" href="/assets/design-factory.html-89999af1.js" as="script"><link rel="prefetch" href="/assets/design-flyweight.html-f4f2afe1.js" as="script"><link rel="prefetch" href="/assets/design-interpreter.html-982ac126.js" as="script"><link rel="prefetch" href="/assets/design-iterator.html-59b9d18b.js" as="script"><link rel="prefetch" href="/assets/design-mediator.html-a73e3179.js" as="script"><link rel="prefetch" href="/assets/design-memento.html-495efbd1.js" as="script"><link rel="prefetch" href="/assets/design-observer.html-fbadf9f5.js" as="script"><link rel="prefetch" href="/assets/design-overview.html-fb49535c.js" as="script"><link rel="prefetch" href="/assets/design-prototype.html-5e661e49.js" as="script"><link rel="prefetch" href="/assets/design-proxy.html-c743cc9c.js" as="script"><link rel="prefetch" href="/assets/design-singleton.html-a594ad7a.js" as="script"><link rel="prefetch" href="/assets/design-state.html-b91f3529.js" as="script"><link rel="prefetch" href="/assets/design-strategy.html-586d3ac2.js" as="script"><link rel="prefetch" href="/assets/design-template.html-12aa47cf.js" as="script"><link rel="prefetch" href="/assets/design-visitor.html-51d45c95.js" as="script"><link rel="prefetch" href="/assets/docker.html-2f412609.js" as="script"><link rel="prefetch" href="/assets/linux-command.html-db80ac58.js" as="script"><link rel="prefetch" href="/assets/linux-core.html-3f065eb0.js" as="script"><link rel="prefetch" href="/assets/linux-overview.html-7f61946a.js" as="script"><link rel="prefetch" href="/assets/temp.html-733f02e6.js" as="script"><link rel="prefetch" href="/assets/滑动窗口.html-2903c1b6.js" as="script"><link rel="prefetch" href="/assets/encoding.html-3b631fc3.js" as="script"><link rel="prefetch" href="/assets/encryption-algorithm.html-bf387256.js" as="script"><link rel="prefetch" href="/assets/network.html-279991aa.js" as="script"><link rel="prefetch" href="/assets/spring-batch.html-7466d243.js" as="script"><link rel="prefetch" href="/assets/BeanPostProcessor-base.html-a46b20f9.js" as="script"><link rel="prefetch" href="/assets/BeanPostProcessor-ConfigurationClassPostProcessor.html-d4e7a5e5.js" as="script"><link rel="prefetch" href="/assets/spring-framework-overview.html-49552513.js" as="script"><link rel="prefetch" href="/assets/spring-source-overview.html-3ac2c8f4.js" as="script"><link rel="prefetch" href="/assets/spring-boot-condition.html-f38f1a16.js" as="script"><link rel="prefetch" href="/assets/spring-cloud-commons.html-b2df0b2e.js" as="script"><link rel="prefetch" href="/assets/spring-cloud-gateway.html-79d8ca10.js" as="script"><link rel="prefetch" href="/assets/spring-cloud-loadbalancer.html-182fff59.js" as="script"><link rel="prefetch" href="/assets/cloud-openfeign-action.html-6173210d.js" as="script"><link rel="prefetch" href="/assets/spring-cloud-openfeign.html-9dd99fbf.js" as="script"><link rel="prefetch" href="/assets/nacos-client-discovery.html-43257632.js" as="script"><link rel="prefetch" href="/assets/nacos-naming-source-service-register.html-f2d19ed3.js" as="script"><link rel="prefetch" href="/assets/nacos-overview.html-d85018d2.js" as="script"><link rel="prefetch" href="/assets/spring-cloud-alibaba-seate.html-f62e5a6b.js" as="script"><link rel="prefetch" href="/assets/git.html-476f511a.js" as="script"><link rel="prefetch" href="/assets/sentinel-source.html-e706b7a6.js" as="script"><link rel="prefetch" href="/assets/spring-cloud-sentinel.html-031a7566.js" as="script"><link rel="prefetch" href="/assets/gitlab.html-af9cead7.js" as="script"><link rel="prefetch" href="/assets/junit4.html-7674a247.js" as="script"><link rel="prefetch" href="/assets/junit5.html-5d65839e.js" as="script"><link rel="prefetch" href="/assets/maven.html-be6f6316.js" as="script"><link rel="prefetch" href="/assets/reactor.html-b7f3a608.js" as="script"><link rel="prefetch" href="/assets/1.tcp-id-model.html-763c065d.js" as="script"><link rel="prefetch" href="/assets/2.what_happen_url.html-ed893ab5.js" as="script"><link rel="prefetch" href="/assets/3.how_os_deal_network_package.html-003c9378.js" as="script"><link rel="prefetch" href="/assets/1.http_interview.html-81e5ff34.js" as="script"><link rel="prefetch" href="/assets/2.http_optimize.html-c31dc84d.js" as="script"><link rel="prefetch" href="/assets/3_https_rsa.html-d8314292.js" as="script"><link rel="prefetch" href="/assets/4_https_ecdhe.html-5333ed6a.js" as="script"><link rel="prefetch" href="/assets/5_https_optimize.html-1b5cb67c.js" as="script"><link rel="prefetch" href="/assets/6_http2.html-f5c4545f.js" as="script"><link rel="prefetch" href="/assets/7_http3.html-22194a12.js" as="script"><link rel="prefetch" href="/assets/1_tcp_interview.html-80022c5b.js" as="script"><link rel="prefetch" href="/assets/2_tcp_feature.html-a38fb885.js" as="script"><link rel="prefetch" href="/assets/3_tcp_tcpdump.html-7fa54232.js" as="script"><link rel="prefetch" href="/assets/1_ip_base.html-0a16f0d2.js" as="script"><link rel="prefetch" href="/assets/2_ping.html-31b5dbb5.js" as="script"><link rel="prefetch" href="/assets/3_ping_lo.html-4c54a1d5.js" as="script"><link rel="prefetch" href="/assets/1.how-cpu-run.html-230d707d.js" as="script"><link rel="prefetch" href="/assets/2.storage.html-189910cd.js" as="script"><link rel="prefetch" href="/assets/3.how-make-cpu-run-faster.html-4051d2c2.js" as="script"><link rel="prefetch" href="/assets/4.cpu-mesi.html-07cf201e.js" as="script"><link rel="prefetch" href="/assets/5.how-cup-deal-task.html-0e3ee3df.js" as="script"><link rel="prefetch" href="/assets/6.soft-interrupt.html-1bea4976.js" as="script"><link rel="prefetch" href="/assets/7.float.html-92f8ff81.js" as="script"><link rel="prefetch" href="/assets/linux-vs-windows.html-d0be38b1.js" as="script"><link rel="prefetch" href="/assets/1.vmem.html-b282b546.js" as="script"><link rel="prefetch" href="/assets/2.malloc.html-350861f0.js" as="script"><link rel="prefetch" href="/assets/3.mem-reclaim.html-ee770ad0.js" as="script"><link rel="prefetch" href="/assets/4.alloc-mem.html-541cad7b.js" as="script"><link rel="prefetch" href="/assets/5.cache-lru.html-6e272aa2.js" as="script"><link rel="prefetch" href="/assets/6.linux-mem.html-7d761356.js" as="script"><link rel="prefetch" href="/assets/7.linux-mem-2.html-25dc77c0.js" as="script"><link rel="prefetch" href="/assets/spring-collection-annotation.html-7395ab82.js" as="script"><link rel="prefetch" href="/assets/application-context.html-8ef65b1e.js" as="script"><link rel="prefetch" href="/assets/bean-factory-post-processor.html-a2e97494.js" as="script"><link rel="prefetch" href="/assets/bean-factory.html-982a8ae7.js" as="script"><link rel="prefetch" href="/assets/bean-post-processor.html-a79c4714.js" as="script"><link rel="prefetch" href="/assets/i18n-and-event.html-bad25ca9.js" as="script"><link rel="prefetch" href="/assets/package-scan.html-3652f543.js" as="script"><link rel="prefetch" href="/assets/spring-bean-create.html-a1f3b825.js" as="script"><link rel="prefetch" href="/assets/starting-finished.html-20e89aec.js" as="script"><link rel="prefetch" href="/assets/starting-overview.html-9a415d8c.js" as="script"><link rel="prefetch" href="/assets/starting-prepare.html-f22dce60.js" as="script"><link rel="prefetch" href="/assets/starting-summary.html-f0b9950a.js" as="script"><link rel="prefetch" href="/assets/spring-source-web-init.html-7095a9cc.js" as="script"><link rel="prefetch" href="/assets/spring-source-web-listener.html-8020b96c.js" as="script"><link rel="prefetch" href="/assets/404.html-f04ced3e.js" as="script"><link rel="prefetch" href="/assets/index.html-79ea5b2c.js" as="script"><link rel="prefetch" href="/assets/index.html-c2745466.js" as="script"><link rel="prefetch" href="/assets/index.html-e7a2b372.js" as="script"><link rel="prefetch" href="/assets/index.html-c7a0896e.js" as="script"><link rel="prefetch" href="/assets/index.html-44e4fbd1.js" as="script"><link rel="prefetch" href="/assets/index.html-deb73f95.js" as="script"><link rel="prefetch" href="/assets/index.html-9923d923.js" as="script"><link rel="prefetch" href="/assets/index.html-f8852d02.js" as="script"><link rel="prefetch" href="/assets/index.html-ebc6e775.js" as="script"><link rel="prefetch" href="/assets/index.html-5391a96f.js" as="script"><link rel="prefetch" href="/assets/index.html-7f9a590b.js" as="script"><link rel="prefetch" href="/assets/index.html-bdfce464.js" as="script"><link rel="prefetch" href="/assets/index.html-7bc2e619.js" as="script"><link rel="prefetch" href="/assets/index.html-19a53cb3.js" as="script"><link rel="prefetch" href="/assets/index.html-2dbf58c9.js" as="script"><link rel="prefetch" href="/assets/index.html-5135c839.js" as="script"><link rel="prefetch" href="/assets/index.html-493839dd.js" as="script"><link rel="prefetch" href="/assets/index.html-ceb8d736.js" as="script"><link rel="prefetch" href="/assets/index.html-e7623640.js" as="script"><link rel="prefetch" href="/assets/index.html-09445423.js" as="script"><link rel="prefetch" href="/assets/index.html-4228b788.js" as="script"><link rel="prefetch" href="/assets/index.html-ae4432a1.js" as="script"><link rel="prefetch" href="/assets/index.html-db047aee.js" as="script"><link rel="prefetch" href="/assets/index.html-6afc1b6b.js" as="script"><link rel="prefetch" href="/assets/index.html-36ab6168.js" as="script"><link rel="prefetch" href="/assets/index.html-844edecf.js" as="script"><link rel="prefetch" href="/assets/index.html-0bee4d7c.js" as="script"><link rel="prefetch" href="/assets/index.html-e48a03aa.js" as="script"><link rel="prefetch" href="/assets/index.html-1bcb9a21.js" as="script"><link rel="prefetch" href="/assets/index.html-6bad5551.js" as="script"><link rel="prefetch" href="/assets/index.html-b674839b.js" as="script"><link rel="prefetch" href="/assets/index.html-a2aeccdb.js" as="script"><link rel="prefetch" href="/assets/index.html-d2431a2d.js" as="script"><link rel="prefetch" href="/assets/index.html-8196e289.js" as="script"><link rel="prefetch" href="/assets/index.html-915f74ea.js" as="script"><link rel="prefetch" href="/assets/index.html-83711a9e.js" as="script"><link rel="prefetch" href="/assets/index.html-9df5b5ad.js" as="script"><link rel="prefetch" href="/assets/index.html-57c02b1b.js" as="script"><link rel="prefetch" href="/assets/index.html-10287dda.js" as="script"><link rel="prefetch" href="/assets/index.html-63a7add0.js" as="script"><link rel="prefetch" href="/assets/index.html-c84f755d.js" as="script"><link rel="prefetch" href="/assets/index.html-2e53f4cf.js" as="script"><link rel="prefetch" href="/assets/index.html-df942fbe.js" as="script"><link rel="prefetch" href="/assets/index.html-aa4a854c.js" as="script"><link rel="prefetch" href="/assets/index.html-420a9f57.js" as="script"><link rel="prefetch" href="/assets/index.html-27efb3f0.js" as="script"><link rel="prefetch" href="/assets/index.html-ca596762.js" as="script"><link rel="prefetch" href="/assets/index.html-9ba7568f.js" as="script"><link rel="prefetch" href="/assets/index.html-385adf3b.js" as="script"><link rel="prefetch" href="/assets/index.html-95b73732.js" as="script"><link rel="prefetch" href="/assets/index.html-74bd633c.js" as="script"><link rel="prefetch" href="/assets/index.html-b480d660.js" as="script"><link rel="prefetch" href="/assets/index.html-9b56ea57.js" as="script"><link rel="prefetch" href="/assets/index.html-2cc6561e.js" as="script"><link rel="prefetch" href="/assets/index.html-5e502638.js" as="script"><link rel="prefetch" href="/assets/index.html-2cbc0496.js" as="script"><link rel="prefetch" href="/assets/index.html-60de7f02.js" as="script"><link rel="prefetch" href="/assets/index.html-c6491f7f.js" as="script"><link rel="prefetch" href="/assets/index.html-cd02df7a.js" as="script"><link rel="prefetch" href="/assets/index.html-7cb87159.js" as="script"><link rel="prefetch" href="/assets/index.html-3454e09f.js" as="script"><link rel="prefetch" href="/assets/index.html-91025ccb.js" as="script"><link rel="prefetch" href="/assets/index.html-5477af0e.js" as="script"><link rel="prefetch" href="/assets/index.html-0a65ea49.js" as="script"><link rel="prefetch" href="/assets/index.html-88930a72.js" as="script"><link rel="prefetch" href="/assets/index.html-19de02d9.js" as="script"><link rel="prefetch" href="/assets/index.html-2e547c56.js" as="script"><link rel="prefetch" href="/assets/index.html-71fc6e23.js" as="script"><link rel="prefetch" href="/assets/index.html-b8bdf50b.js" as="script"><link rel="prefetch" href="/assets/index.html-982f8e31.js" as="script"><link rel="prefetch" href="/assets/index.html-4fe1b55c.js" as="script"><link rel="prefetch" href="/assets/index.html-a680cb33.js" as="script"><link rel="prefetch" href="/assets/index.html-148fdd8d.js" as="script"><link rel="prefetch" href="/assets/index.html-e50ac7ec.js" as="script"><link rel="prefetch" href="/assets/index.html-e31220f1.js" as="script"><link rel="prefetch" href="/assets/index.html-66f2582a.js" as="script"><link rel="prefetch" href="/assets/database-overview.html-81bf24af.js" as="script"><link rel="prefetch" href="/assets/new-concept-2.html-ff88e3ae.js" as="script"><link rel="prefetch" href="/assets/java-overview.html-d0b73528.js" as="script"><link rel="prefetch" href="/assets/middleware-overview.html-70e35558.js" as="script"><link rel="prefetch" href="/assets/quality-overview.html-c9aab1ec.js" as="script"><link rel="prefetch" href="/assets/spring-cloud-overview.html-74916449.js" as="script"><link rel="prefetch" href="/assets/gitbook.html-acdf5e93.js" as="script"><link rel="prefetch" href="/assets/tools-overview.html-f1afa529.js" as="script"><link rel="prefetch" href="/assets/mongo.html-a86d5a53.js" as="script"><link rel="prefetch" href="/assets/mysql-advance.html-a3921c1d.js" as="script"><link rel="prefetch" href="/assets/mysql-apply.html-3175b849.js" as="script"><link rel="prefetch" href="/assets/mysql-base.html-95c718f9.js" as="script"><link rel="prefetch" href="/assets/mysql-devops.html-21d35d02.js" as="script"><link rel="prefetch" href="/assets/redis-action.html-418d5ab2.js" as="script"><link rel="prefetch" href="/assets/redis-base.html-da98e929.js" as="script"><link rel="prefetch" href="/assets/redis-cluster.html-9dcb005a.js" as="script"><link rel="prefetch" href="/assets/redis-overview.html-b28d9cb7.js" as="script"><link rel="prefetch" href="/assets/java-annotation.html-30013231.js" as="script"><link rel="prefetch" href="/assets/java-base.html-45dd8871.js" as="script"><link rel="prefetch" href="/assets/java-enum.html-87cc3275.js" as="script"><link rel="prefetch" href="/assets/java-reflect.html-87ed91ce.js" as="script"><link rel="prefetch" href="/assets/java-regex.html-49dfa7ed.js" as="script"><link rel="prefetch" href="/assets/java-sql.html-cac00060.js" as="script"><link rel="prefetch" href="/assets/java-time.html-fdfe2ea1.js" as="script"><link rel="prefetch" href="/assets/java-version-feature.html-a868ac52.js" as="script"><link rel="prefetch" href="/assets/java-collection-list.html-b2030247.js" as="script"><link rel="prefetch" href="/assets/java-collection-map.html-c516a252.js" as="script"><link rel="prefetch" href="/assets/heima-concurrent-base.html-0d37e29a.js" as="script"><link rel="prefetch" href="/assets/java-concurrent-base.html-8030155e.js" as="script"><link rel="prefetch" href="/assets/Java-concurrent-container.html-811f4aab.js" as="script"><link rel="prefetch" href="/assets/java-concurrent-interview.html-c13ea47a.js" as="script"><link rel="prefetch" href="/assets/java-concurrent-lock.html-8ce687e8.js" as="script"><link rel="prefetch" href="/assets/java-concurrent-pool.html-c9f0f175.js" as="script"><link rel="prefetch" href="/assets/java-concurrent-tools.html-cce9bcca.js" as="script"><link rel="prefetch" href="/assets/java-bio.html-c75f1345.js" as="script"><link rel="prefetch" href="/assets/java-io.html-0e2cf5e0.js" as="script"><link rel="prefetch" href="/assets/java-nio.html-934e8907.js" as="script"><link rel="prefetch" href="/assets/java-memory-model.html-263a2e85.js" as="script"><link rel="prefetch" href="/assets/jvm-class-file-structure.html-34c3bce9.js" as="script"><link rel="prefetch" href="/assets/jvm-class-loader.html-9185fd00.js" as="script"><link rel="prefetch" href="/assets/jvm-garbage-collection.html-7859578e.js" as="script"><link rel="prefetch" href="/assets/jvm-memory-structure.html-fe44534c.js" as="script"><link rel="prefetch" href="/assets/JVM概览.html-4c5d2e30.js" as="script"><link rel="prefetch" href="/assets/JVM调优.html-72c2eb98.js" as="script"><link rel="prefetch" href="/assets/java-servlet.html-94bdbc40.js" as="script"><link rel="prefetch" href="/assets/java-lambda.html-7174e34d.js" as="script"><link rel="prefetch" href="/assets/java-stream.html-0016d70b.js" as="script"><link rel="prefetch" href="/assets/HikariCP-base.html-61148ceb.js" as="script"><link rel="prefetch" href="/assets/HikariCP-source.html-4b401a26.js" as="script"><link rel="prefetch" href="/assets/jackson-overview.html-cd6a6a9d.js" as="script"><link rel="prefetch" href="/assets/kafka-broker.html-824fc781.js" as="script"><link rel="prefetch" href="/assets/kafka-consumer.html-acb94ec6.js" as="script"><link rel="prefetch" href="/assets/kafka-old.html-e508f49c.js" as="script"><link rel="prefetch" href="/assets/kafka-overview.html-e594f96f.js" as="script"><link rel="prefetch" href="/assets/kafka-producer.html-fc3214cf.js" as="script"><link rel="prefetch" href="/assets/spring-kafka.html-c37f0556.js" as="script"><link rel="prefetch" href="/assets/log-framework.html-3e5b2aea.js" as="script"><link rel="prefetch" href="/assets/1.Hello World.html-05f026e2.js" as="script"><link rel="prefetch" href="/assets/2.Global Config.html-f70c177c.js" as="script"><link rel="prefetch" href="/assets/mybatis-plus.html-411a764f.js" as="script"><link rel="prefetch" href="/assets/index.html-8eece89e.js" as="script"><link rel="prefetch" href="/assets/nginx.html-da20fd8e.js" as="script"><link rel="prefetch" href="/assets/sharding-sphere.html-78203d55.js" as="script"><link rel="prefetch" href="/assets/data-structure-dynamic.html-19bb7a14.js" as="script"><link rel="prefetch" href="/assets/data-structure-list.html-6dc538c5.js" as="script"><link rel="prefetch" href="/assets/data-structure-overview.html-4782ed36.js" as="script"><link rel="prefetch" href="/assets/data-structure-tree.html-8b761e52.js" as="script"><link rel="prefetch" href="/assets/shiro-overview.html-0b349d07.js" as="script"><link rel="prefetch" href="/assets/tomcat.html-1dadbec4.js" as="script"><link rel="prefetch" href="/assets/xxl-job.html-47bd0cc3.js" as="script"><link rel="prefetch" href="/assets/design-adapter.html-4db66971.js" as="script"><link rel="prefetch" href="/assets/design-bridge.html-c70e3526.js" as="script"><link rel="prefetch" href="/assets/design-builder.html-95262ea6.js" as="script"><link rel="prefetch" href="/assets/design-chain.html-8bff25bf.js" as="script"><link rel="prefetch" href="/assets/design-command.html-d7d2ffd7.js" as="script"><link rel="prefetch" href="/assets/design-composite.html-137b1bb3.js" as="script"><link rel="prefetch" href="/assets/design-decorator.html-56744b7a.js" as="script"><link rel="prefetch" href="/assets/design-facade.html-9f6d20c6.js" as="script"><link rel="prefetch" href="/assets/design-factory.html-f98890be.js" as="script"><link rel="prefetch" href="/assets/design-flyweight.html-19b297be.js" as="script"><link rel="prefetch" href="/assets/design-interpreter.html-1e85617c.js" as="script"><link rel="prefetch" href="/assets/design-iterator.html-6da75cee.js" as="script"><link rel="prefetch" href="/assets/design-mediator.html-c3901bcc.js" as="script"><link rel="prefetch" href="/assets/design-memento.html-33f18b31.js" as="script"><link rel="prefetch" href="/assets/design-observer.html-061ef3cc.js" as="script"><link rel="prefetch" href="/assets/design-overview.html-31bda9ae.js" as="script"><link rel="prefetch" href="/assets/design-prototype.html-e9f7590f.js" as="script"><link rel="prefetch" href="/assets/design-proxy.html-979ddc5a.js" as="script"><link rel="prefetch" href="/assets/design-singleton.html-7c329043.js" as="script"><link rel="prefetch" href="/assets/design-state.html-be475fa6.js" as="script"><link rel="prefetch" href="/assets/design-strategy.html-54993b2b.js" as="script"><link rel="prefetch" href="/assets/design-template.html-2890a82a.js" as="script"><link rel="prefetch" href="/assets/design-visitor.html-86d27f60.js" as="script"><link rel="prefetch" href="/assets/docker.html-348fe9d4.js" as="script"><link rel="prefetch" href="/assets/linux-command.html-afa2fdc0.js" as="script"><link rel="prefetch" href="/assets/linux-core.html-34afd11f.js" as="script"><link rel="prefetch" href="/assets/linux-overview.html-76e7efda.js" as="script"><link rel="prefetch" href="/assets/temp.html-555d9383.js" as="script"><link rel="prefetch" href="/assets/滑动窗口.html-4a0742d9.js" as="script"><link rel="prefetch" href="/assets/encoding.html-cbfd0d77.js" as="script"><link rel="prefetch" href="/assets/encryption-algorithm.html-8e07492a.js" as="script"><link rel="prefetch" href="/assets/network.html-44c0d77f.js" as="script"><link rel="prefetch" href="/assets/spring-batch.html-3ef72f7b.js" as="script"><link rel="prefetch" href="/assets/BeanPostProcessor-base.html-98b0202d.js" as="script"><link rel="prefetch" href="/assets/BeanPostProcessor-ConfigurationClassPostProcessor.html-229400aa.js" as="script"><link rel="prefetch" href="/assets/spring-framework-overview.html-0bd1b3bd.js" as="script"><link rel="prefetch" href="/assets/spring-source-overview.html-bc3f8003.js" as="script"><link rel="prefetch" href="/assets/spring-boot-condition.html-6ff26285.js" as="script"><link rel="prefetch" href="/assets/spring-cloud-commons.html-f0cbc043.js" as="script"><link rel="prefetch" href="/assets/spring-cloud-gateway.html-aee90359.js" as="script"><link rel="prefetch" href="/assets/spring-cloud-loadbalancer.html-a9814120.js" as="script"><link rel="prefetch" href="/assets/cloud-openfeign-action.html-54387674.js" as="script"><link rel="prefetch" href="/assets/spring-cloud-openfeign.html-8f692d94.js" as="script"><link rel="prefetch" href="/assets/nacos-client-discovery.html-4e22e868.js" as="script"><link rel="prefetch" href="/assets/nacos-naming-source-service-register.html-46598061.js" as="script"><link rel="prefetch" href="/assets/nacos-overview.html-71fd26b0.js" as="script"><link rel="prefetch" href="/assets/spring-cloud-alibaba-seate.html-f60b19e5.js" as="script"><link rel="prefetch" href="/assets/git.html-956c9cf1.js" as="script"><link rel="prefetch" href="/assets/sentinel-source.html-ff88b99f.js" as="script"><link rel="prefetch" href="/assets/spring-cloud-sentinel.html-8db3b8ca.js" as="script"><link rel="prefetch" href="/assets/gitlab.html-6b192049.js" as="script"><link rel="prefetch" href="/assets/junit4.html-c792240f.js" as="script"><link rel="prefetch" href="/assets/junit5.html-3727c3db.js" as="script"><link rel="prefetch" href="/assets/maven.html-e13c8f26.js" as="script"><link rel="prefetch" href="/assets/reactor.html-f0f4cd13.js" as="script"><link rel="prefetch" href="/assets/1.tcp-id-model.html-fbdc585c.js" as="script"><link rel="prefetch" href="/assets/2.what_happen_url.html-11ff9eab.js" as="script"><link rel="prefetch" href="/assets/3.how_os_deal_network_package.html-b92c6457.js" as="script"><link rel="prefetch" href="/assets/1.http_interview.html-f9516b19.js" as="script"><link rel="prefetch" href="/assets/2.http_optimize.html-c74a6f87.js" as="script"><link rel="prefetch" href="/assets/3_https_rsa.html-034f973b.js" as="script"><link rel="prefetch" href="/assets/4_https_ecdhe.html-b0a9c59f.js" as="script"><link rel="prefetch" href="/assets/5_https_optimize.html-fe06e481.js" as="script"><link rel="prefetch" href="/assets/6_http2.html-d305c873.js" as="script"><link rel="prefetch" href="/assets/7_http3.html-97b70a2a.js" as="script"><link rel="prefetch" href="/assets/1_tcp_interview.html-60729441.js" as="script"><link rel="prefetch" href="/assets/2_tcp_feature.html-25b828cf.js" as="script"><link rel="prefetch" href="/assets/3_tcp_tcpdump.html-5491f690.js" as="script"><link rel="prefetch" href="/assets/1_ip_base.html-d712d902.js" as="script"><link rel="prefetch" href="/assets/2_ping.html-eec452ed.js" as="script"><link rel="prefetch" href="/assets/3_ping_lo.html-8dcb5a9a.js" as="script"><link rel="prefetch" href="/assets/1.how-cpu-run.html-d99149b0.js" as="script"><link rel="prefetch" href="/assets/2.storage.html-774e3e4d.js" as="script"><link rel="prefetch" href="/assets/3.how-make-cpu-run-faster.html-8e014b54.js" as="script"><link rel="prefetch" href="/assets/4.cpu-mesi.html-7e5c37ae.js" as="script"><link rel="prefetch" href="/assets/5.how-cup-deal-task.html-b2f2d081.js" as="script"><link rel="prefetch" href="/assets/6.soft-interrupt.html-889975b4.js" as="script"><link rel="prefetch" href="/assets/7.float.html-bffa75ff.js" as="script"><link rel="prefetch" href="/assets/linux-vs-windows.html-915715df.js" as="script"><link rel="prefetch" href="/assets/1.vmem.html-4064416a.js" as="script"><link rel="prefetch" href="/assets/2.malloc.html-32197d01.js" as="script"><link rel="prefetch" href="/assets/3.mem-reclaim.html-6209f085.js" as="script"><link rel="prefetch" href="/assets/4.alloc-mem.html-911ee7b0.js" as="script"><link rel="prefetch" href="/assets/5.cache-lru.html-b747920f.js" as="script"><link rel="prefetch" href="/assets/6.linux-mem.html-80432afb.js" as="script"><link rel="prefetch" href="/assets/7.linux-mem-2.html-f3db7807.js" as="script"><link rel="prefetch" href="/assets/spring-collection-annotation.html-29798feb.js" as="script"><link rel="prefetch" href="/assets/application-context.html-9bee65ed.js" as="script"><link rel="prefetch" href="/assets/bean-factory-post-processor.html-f10ec0a6.js" as="script"><link rel="prefetch" href="/assets/bean-factory.html-842232a8.js" as="script"><link rel="prefetch" href="/assets/bean-post-processor.html-1368dfdc.js" as="script"><link rel="prefetch" href="/assets/i18n-and-event.html-8fdbd04c.js" as="script"><link rel="prefetch" href="/assets/package-scan.html-b58ae430.js" as="script"><link rel="prefetch" href="/assets/spring-bean-create.html-92e356c0.js" as="script"><link rel="prefetch" href="/assets/starting-finished.html-5e1a1000.js" as="script"><link rel="prefetch" href="/assets/starting-overview.html-c747f251.js" as="script"><link rel="prefetch" href="/assets/starting-prepare.html-de7f2f97.js" as="script"><link rel="prefetch" href="/assets/starting-summary.html-56702e3e.js" as="script"><link rel="prefetch" href="/assets/spring-source-web-init.html-7dc40dc5.js" as="script"><link rel="prefetch" href="/assets/spring-source-web-listener.html-3ab151a2.js" as="script"><link rel="prefetch" href="/assets/404.html-4482f428.js" as="script"><link rel="prefetch" href="/assets/index.html-087cd9cf.js" as="script"><link rel="prefetch" href="/assets/index.html-9e123f15.js" as="script"><link rel="prefetch" href="/assets/index.html-c8c0595b.js" as="script"><link rel="prefetch" href="/assets/index.html-3dec91e0.js" as="script"><link rel="prefetch" href="/assets/index.html-dac4fb5e.js" as="script"><link rel="prefetch" href="/assets/index.html-57ca67ca.js" as="script"><link rel="prefetch" href="/assets/index.html-47aa26a2.js" as="script"><link rel="prefetch" href="/assets/index.html-6228255c.js" as="script"><link rel="prefetch" href="/assets/index.html-e5821b2c.js" as="script"><link rel="prefetch" href="/assets/index.html-5b406c8c.js" as="script"><link rel="prefetch" href="/assets/index.html-69303c44.js" as="script"><link rel="prefetch" href="/assets/index.html-57908ff6.js" as="script"><link rel="prefetch" href="/assets/index.html-5bfef271.js" as="script"><link rel="prefetch" href="/assets/index.html-e812711e.js" as="script"><link rel="prefetch" href="/assets/index.html-0cd59e6c.js" as="script"><link rel="prefetch" href="/assets/index.html-af3557c8.js" as="script"><link rel="prefetch" href="/assets/index.html-400416c1.js" as="script"><link rel="prefetch" href="/assets/index.html-aeb21a5e.js" as="script"><link rel="prefetch" href="/assets/index.html-e603f649.js" as="script"><link rel="prefetch" href="/assets/index.html-8099f8b7.js" as="script"><link rel="prefetch" href="/assets/index.html-e657d222.js" as="script"><link rel="prefetch" href="/assets/index.html-b72e665b.js" as="script"><link rel="prefetch" href="/assets/index.html-8850e34b.js" as="script"><link rel="prefetch" href="/assets/index.html-1c0c2a2a.js" as="script"><link rel="prefetch" href="/assets/index.html-3a56156a.js" as="script"><link rel="prefetch" href="/assets/index.html-62180c4b.js" as="script"><link rel="prefetch" href="/assets/index.html-4dce3ab3.js" as="script"><link rel="prefetch" href="/assets/index.html-72c49b04.js" as="script"><link rel="prefetch" href="/assets/index.html-4c98ed7e.js" as="script"><link rel="prefetch" href="/assets/index.html-cfb35331.js" as="script"><link rel="prefetch" href="/assets/index.html-85c25e01.js" as="script"><link rel="prefetch" href="/assets/index.html-e9165360.js" as="script"><link rel="prefetch" href="/assets/index.html-c5c6ccd9.js" as="script"><link rel="prefetch" href="/assets/index.html-b1a95e7f.js" as="script"><link rel="prefetch" href="/assets/index.html-0aed9f44.js" as="script"><link rel="prefetch" href="/assets/index.html-6309b593.js" as="script"><link rel="prefetch" href="/assets/index.html-53f4ae61.js" as="script"><link rel="prefetch" href="/assets/index.html-be453128.js" as="script"><link rel="prefetch" href="/assets/index.html-b6d2e0cf.js" as="script"><link rel="prefetch" href="/assets/index.html-d96fb28a.js" as="script"><link rel="prefetch" href="/assets/index.html-0dd8fad8.js" as="script"><link rel="prefetch" href="/assets/index.html-a1eaa0a7.js" as="script"><link rel="prefetch" href="/assets/index.html-e51738f2.js" as="script"><link rel="prefetch" href="/assets/index.html-8c102982.js" as="script"><link rel="prefetch" href="/assets/index.html-1f9cdd35.js" as="script"><link rel="prefetch" href="/assets/index.html-63fbd907.js" as="script"><link rel="prefetch" href="/assets/index.html-3190c6a3.js" as="script"><link rel="prefetch" href="/assets/index.html-1aa7fee5.js" as="script"><link rel="prefetch" href="/assets/index.html-483697fa.js" as="script"><link rel="prefetch" href="/assets/index.html-ab65ac33.js" as="script"><link rel="prefetch" href="/assets/index.html-2d7a9565.js" as="script"><link rel="prefetch" href="/assets/index.html-b838c603.js" as="script"><link rel="prefetch" href="/assets/index.html-de3b7914.js" as="script"><link rel="prefetch" href="/assets/index.html-74fbbd3a.js" as="script"><link rel="prefetch" href="/assets/index.html-a7de50d0.js" as="script"><link rel="prefetch" href="/assets/index.html-b3af77c3.js" as="script"><link rel="prefetch" href="/assets/index.html-681a7978.js" as="script"><link rel="prefetch" href="/assets/index.html-4984d8c7.js" as="script"><link rel="prefetch" href="/assets/index.html-26accc77.js" as="script"><link rel="prefetch" href="/assets/index.html-183a4964.js" as="script"><link rel="prefetch" href="/assets/index.html-dfe1bab4.js" as="script"><link rel="prefetch" href="/assets/index.html-5cad09e8.js" as="script"><link rel="prefetch" href="/assets/index.html-74aefd26.js" as="script"><link rel="prefetch" href="/assets/index.html-65cf5278.js" as="script"><link rel="prefetch" href="/assets/index.html-e08b1bac.js" as="script"><link rel="prefetch" href="/assets/index.html-1a618372.js" as="script"><link rel="prefetch" href="/assets/index.html-63cba565.js" as="script"><link rel="prefetch" href="/assets/index.html-1d599a81.js" as="script"><link rel="prefetch" href="/assets/index.html-279180e7.js" as="script"><link rel="prefetch" href="/assets/index.html-69dbe9f0.js" as="script"><link rel="prefetch" href="/assets/index.html-e701b05c.js" as="script"><link rel="prefetch" href="/assets/index.html-cf8785e3.js" as="script"><link rel="prefetch" href="/assets/index.html-9eea119d.js" as="script"><link rel="prefetch" href="/assets/index.html-bd64f0b5.js" as="script"><link rel="prefetch" href="/assets/index.html-aecf24f6.js" as="script"><link rel="prefetch" href="/assets/mermaid.core-a1726b7b.js" as="script"><link rel="prefetch" href="/assets/pageview-4c1e2df7.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand vp-brand" href="/"><!----><!----><span class="vp-site-name">-_- !</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a aria-label="Java 笔记" class="vp-link nav-link nav-link" href="/java/java-overview.html"><!---->Java 笔记<!----></a></div><div class="nav-item hide-in-mobile"><a aria-label="SpringFramwork" class="vp-link nav-link nav-link" href="/spring/spring-framework/spring-framework-overview.html"><!---->SpringFramwork<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="Spring Cloud"><span class="title"><!---->Spring Cloud</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a aria-label="Spring Cloud Overview" class="vp-link nav-link nav-link" href="/spring-cloud/spring-cloud-overview.html"><!---->Spring Cloud Overview<!----></a></li><li class="dropdown-item"><a aria-label="Spring Cloud Nacos" class="vp-link nav-link nav-link" href="/spring-cloud/spring-cloud-alibaba-nacos.html"><!---->Spring Cloud Nacos<!----></a></li><li class="dropdown-item"><a aria-label="Spring Cloud Sentinel" class="vp-link nav-link nav-link" href="/spring-cloud/spring-cloud-alibaba-sentinel.html"><!---->Spring Cloud Sentinel<!----></a></li><li class="dropdown-item"><a aria-label="Spring Cloud Seate" class="vp-link nav-link nav-link" href="/spring-cloud/spring-cloud-alibaba-seate.html"><!---->Spring Cloud Seate<!----></a></li><li class="dropdown-item"><a aria-label="Spring Cloud Ribbon" class="vp-link nav-link active nav-link active" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html"><!---->Spring Cloud Ribbon<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a aria-label="数据库" class="vp-link nav-link nav-link" href="/database/database-overview.html"><!---->数据库<!----></a></div><div class="nav-item hide-in-mobile"><a aria-label="自我修养" class="vp-link nav-link nav-link" href="/quality/quality-overview.html"><!---->自我修养<!----></a></div><div class="nav-item hide-in-mobile"><a aria-label="中间件" class="vp-link nav-link nav-link" href="/middleware/middleware-overview.html"><!---->中间件<!----></a></div><div class="nav-item hide-in-mobile"><a aria-label="工具包" class="vp-link nav-link nav-link" href="/tools/tools-overview.html"><!---->工具包<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><!----><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><p class="vp-sidebar-heading"><!----><span class="vp-sidebar-title">微服务架构</span><!----></p><ul class="vp-sidebar-links"><li><!--[--><a aria-label="Spring Cloud" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/spring-cloud/spring-cloud-overview.html"><!---->Spring Cloud<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="Nacos服务注册发现原理" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/spring-cloud/spring-cloud-nacos/nacos-client-discovery.html"><!---->Nacos服务注册发现原理<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="Nacos" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/spring-cloud/spring-cloud-nacos/nacos-overview.html"><!---->Nacos<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="Sentinel 源码分析" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/spring-cloud/spring-cloud-sentinel/sentinel-source.html"><!---->Sentinel 源码分析<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="/spring-cloud/spring-cloud-alibaba-seate.html" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/spring-cloud/spring-cloud-alibaba-seate.html"><!---->/spring-cloud/spring-cloud-alibaba-seate.html<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="Spring Cloud Gateway" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/spring-cloud/spring-cloud-gateway/spring-cloud-gateway.html"><!---->Spring Cloud Gateway<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-heading active"><!----><span class="vp-sidebar-title">常用组件</span><!----></p><ul class="vp-sidebar-links"><li><!--[--><a aria-label="Spring Cloud OpenFeign 源码解析" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/spring-cloud/spring-cloud-openfeign/spring-cloud-openfeign.html"><!---->Spring Cloud OpenFeign 源码解析<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="Spring Cloud Ribbon 源码解析" class="vp-link nav-link active vp-sidebar-link vp-sidebar-page active nav-link active vp-sidebar-link vp-sidebar-page active" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html"><!---->Spring Cloud Ribbon 源码解析<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="负载均衡简介" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#负载均衡简介"><!---->负载均衡简介<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="服务器端负载均衡器" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#服务器端负载均衡器"><!---->服务器端负载均衡器<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="客户端负载均衡器" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#客户端负载均衡器"><!---->客户端负载均衡器<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="Spring Cloud Ribbon 简介" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbon-简介"><!---->Spring Cloud Ribbon 简介<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="Spring Cloud Ribbon中的关键组件" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbon中的关键组件"><!---->Spring Cloud Ribbon中的关键组件<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="Spring Cloud Ribbon简单使用" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbon简单使用"><!---->Spring Cloud Ribbon简单使用<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="Spring Cloud Ribbon的负载均衡策略" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbon的负载均衡策略"><!---->Spring Cloud Ribbon的负载均衡策略<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="负载均衡策略概述" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#负载均衡策略概述"><!---->负载均衡策略概述<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="RandomRule" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#randomrule"><!---->RandomRule<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="RoundRobinRule" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#roundrobinrule"><!---->RoundRobinRule<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="RetryRule" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#retryrule"><!---->RetryRule<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="ClientConfigEnabledRoundRobinRule" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#clientconfigenabledroundrobinrule"><!---->ClientConfigEnabledRoundRobinRule<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="WeightedResponseTimeRule" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#weightedresponsetimerule"><!---->WeightedResponseTimeRule<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="BestAvailableRule" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#bestavailablerule"><!---->BestAvailableRule<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="ZoneAvoidanceRule" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#zoneavoidancerule"><!---->ZoneAvoidanceRule<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="Spring Cloud Ribbon的心跳检测机制" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbon的心跳检测机制"><!---->Spring Cloud Ribbon的心跳检测机制<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="NoOpPing" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#noopping"><!---->NoOpPing<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="PingUrl" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#pingurl"><!---->PingUrl<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="PingConstant" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#pingconstant"><!---->PingConstant<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="DummyPing" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#dummyping"><!---->DummyPing<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="Spring Cloud Ribbon的服务列表" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbon的服务列表"><!---->Spring Cloud Ribbon的服务列表<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="StaticServerList" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#staticserverlist"><!---->StaticServerList<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="ConfigurationBasedServerList" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#configurationbasedserverlist"><!---->ConfigurationBasedServerList<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="NacosServerList" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#nacosserverlist"><!---->NacosServerList<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="Spring Cloud Ribbon的服务列表过滤" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbon的服务列表过滤"><!---->Spring Cloud Ribbon的服务列表过滤<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="ZoneAffinityServerListFilter" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#zoneaffinityserverlistfilter"><!---->ZoneAffinityServerListFilter<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="ServerListSubsetFilter" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#serverlistsubsetfilter"><!---->ServerListSubsetFilter<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="ZonePreferenceServerListFilter" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#zonepreferenceserverlistfilter"><!---->ZonePreferenceServerListFilter<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="Spring Cloud Ribbon的服务列表更新" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbon的服务列表更新"><!---->Spring Cloud Ribbon的服务列表更新<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="PollingServerListUpdater" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#pollingserverlistupdater"><!---->PollingServerListUpdater<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="Spring Cloud Ribbon的负载均衡器" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbon的负载均衡器"><!---->Spring Cloud Ribbon的负载均衡器<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="NoOpLoadBalancer" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#nooploadbalancer"><!---->NoOpLoadBalancer<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="BaseLoadBalancer" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#baseloadbalancer"><!---->BaseLoadBalancer<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="DynamicServerListLoadBalancer" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#dynamicserverlistloadbalancer"><!---->DynamicServerListLoadBalancer<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="ZoneAwareLoadBalancer" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#zoneawareloadbalancer"><!---->ZoneAwareLoadBalancer<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="Spring Cloud Ribbon自动装配" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbon自动装配"><!---->Spring Cloud Ribbon自动装配<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="RibbonAutoConfiguration上的注解" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#ribbonautoconfiguration上的注解"><!---->RibbonAutoConfiguration上的注解<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="RibbonAutoConfiguration" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#ribbonautoconfiguration"><!---->RibbonAutoConfiguration<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="LoadBalancerAutoConfiguration" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#loadbalancerautoconfiguration"><!---->LoadBalancerAutoConfiguration<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="Spring Cloud Ribbon中重要的组件" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbon中重要的组件"><!---->Spring Cloud Ribbon中重要的组件<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="IClientConfig" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#iclientconfig"><!---->IClientConfig<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="LoadBalancerStatus" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#loadbalancerstatus"><!---->LoadBalancerStatus<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="Spring Cloud Ribbon中的监控组件" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbon中的监控组件"><!---->Spring Cloud Ribbon中的监控组件<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="基础工具包" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#基础工具包"><!---->基础工具包<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="ServerStats" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#serverstats"><!---->ServerStats<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="LoadBalancerStats" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#loadbalancerstats"><!---->LoadBalancerStats<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="Spring Cloud Ribbon 配置总结" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbon-配置总结"><!---->Spring Cloud Ribbon 配置总结<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->Spring Cloud Ribbon 源码解析</h1><div class="page-info"><!----><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2022-06-11T14:36:26.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 39 分钟</span><meta property="timeRequired" content="PT39M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#负载均衡简介">负载均衡简介</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#服务器端负载均衡器">服务器端负载均衡器</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#客户端负载均衡器">客户端负载均衡器</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#spring-cloud-ribbon-简介">Spring Cloud Ribbon 简介</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#spring-cloud-ribbon中的关键组件">Spring Cloud Ribbon中的关键组件</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#spring-cloud-ribbon简单使用">Spring Cloud Ribbon简单使用</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#spring-cloud-ribbon的负载均衡策略">Spring Cloud Ribbon的负载均衡策略</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#负载均衡策略概述">负载均衡策略概述</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#randomrule">RandomRule</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#roundrobinrule">RoundRobinRule</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#retryrule">RetryRule</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#clientconfigenabledroundrobinrule">ClientConfigEnabledRoundRobinRule</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#weightedresponsetimerule">WeightedResponseTimeRule</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#bestavailablerule">BestAvailableRule</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#zoneavoidancerule">ZoneAvoidanceRule</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#spring-cloud-ribbon的心跳检测机制">Spring Cloud Ribbon的心跳检测机制</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#noopping">NoOpPing</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#pingurl">PingUrl</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#pingconstant">PingConstant</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#dummyping">DummyPing</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#spring-cloud-ribbon的服务列表">Spring Cloud Ribbon的服务列表</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#staticserverlist">StaticServerList</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#configurationbasedserverlist">ConfigurationBasedServerList</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#nacosserverlist">NacosServerList</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#spring-cloud-ribbon的服务列表过滤">Spring Cloud Ribbon的服务列表过滤</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#zoneaffinityserverlistfilter">ZoneAffinityServerListFilter</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#serverlistsubsetfilter">ServerListSubsetFilter</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#zonepreferenceserverlistfilter">ZonePreferenceServerListFilter</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#spring-cloud-ribbon的服务列表更新">Spring Cloud Ribbon的服务列表更新</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#pollingserverlistupdater">PollingServerListUpdater</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#spring-cloud-ribbon的负载均衡器">Spring Cloud Ribbon的负载均衡器</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#nooploadbalancer">NoOpLoadBalancer</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#baseloadbalancer">BaseLoadBalancer</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#dynamicserverlistloadbalancer">DynamicServerListLoadBalancer</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#zoneawareloadbalancer">ZoneAwareLoadBalancer</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#spring-cloud-ribbon自动装配">Spring Cloud Ribbon自动装配</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#ribbonautoconfiguration上的注解">RibbonAutoConfiguration上的注解</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#ribbonautoconfiguration">RibbonAutoConfiguration</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#loadbalancerautoconfiguration">LoadBalancerAutoConfiguration</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#spring-cloud-ribbon中重要的组件">Spring Cloud Ribbon中重要的组件</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#iclientconfig">IClientConfig</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#loadbalancerstatus">LoadBalancerStatus</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#spring-cloud-ribbon中的监控组件">Spring Cloud Ribbon中的监控组件</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#基础工具包">基础工具包</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#serverstats">ServerStats</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#loadbalancerstats">LoadBalancerStats</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#spring-cloud-ribbon-配置总结">Spring Cloud Ribbon 配置总结</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><h1 id="spring-cloud-ribbon-源码解析" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ribbon-源码解析" aria-hidden="true">#</a> Spring Cloud Ribbon 源码解析</h1><h2 id="负载均衡简介" tabindex="-1"><a class="header-anchor" href="#负载均衡简介" aria-hidden="true">#</a> 负载均衡简介</h2><p>负载均衡，英文名称为Load Balance，其含义就是指将负载（工作任务）进行平衡、分摊到多个操作单元上进行运行，例如FTP服务器、Web服务器、企业核心应用服务器和其它主要任务服务器等，从而协同完成工作任务。</p><p>负载均衡构建在原有网络结构之上，它提供了一种透明且廉价有效的方法扩展服务器和网络设备的带宽、加强网络数据处理能力、增加吞吐量、提高网络的可用性和灵活性。</p><h3 id="服务器端负载均衡器" tabindex="-1"><a class="header-anchor" href="#服务器端负载均衡器" aria-hidden="true">#</a> 服务器端负载均衡器</h3><p>传统上，Load Balancers（例如Nginx、F5）是放置在服务器端的组件。当请求来自 <strong>客户端</strong> 时，它们将转到负载均衡器，负载均衡器将为请求指定 <strong>服务器</strong>。负载均衡器使用的最简单的算法是随机指定。在这种情况下，大多数负载平衡器是用于控制负载平衡的硬件集成软件。</p><p><img src="/assets/v2-056f3af3ae6ad842d6b57671f78ca1d5_b-ba69a707.webp" alt="动图"></p><p>重点：</p><ul><li>对客户端不透明，客户端不知道服务器端的服务列表，甚至不知道自己发送请求的目标地址存在负载均衡器。</li><li>服务器端维护负载均衡服务器，控制负载均衡策略和算法。</li></ul><h3 id="客户端负载均衡器" tabindex="-1"><a class="header-anchor" href="#客户端负载均衡器" aria-hidden="true">#</a> 客户端负载均衡器</h3><p>当负载均衡器位于 <strong>客户端</strong> 时，<strong>客户端</strong>得到可用的服务器列表然后按照特定的负载均衡策略,分发请求到不同的 <strong>服务器</strong> 。</p><p><img src="/assets/v2-0c112f54dcacfd2a6718a8b281b696c5_b-9b128df2.webp" alt="动图"></p><p>重点：</p><ul><li>对客户端透明，客户端需要知道服务器端的服务列表，需要自行决定请求要发送的目标地址。</li><li>客户端维护负载均衡服务器，控制负载均衡策略和算法。</li><li>目前单独提供的客户端实现比较少，大部分都是在框架内部自行实现。</li></ul><h2 id="spring-cloud-ribbon-简介" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ribbon-简介" aria-hidden="true">#</a> Spring Cloud Ribbon 简介</h2><p>Ribbon是Netflix公司开源的一个客户单负载均衡的项目，可以自动与 Eureka 进行交互。它提供下列特性：</p><ul><li>负载均衡</li><li>容错</li><li>以异步和反应式模型执行多协议 (HTTP, TCP, UDP)</li><li>缓存和批量</li></ul><h2 id="spring-cloud-ribbon中的关键组件" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ribbon中的关键组件" aria-hidden="true">#</a> Spring Cloud Ribbon中的关键组件</h2><p><img src="/assets/13587608-75ed41151f955860-c5960747.png" alt="img"></p><ul><li><p><strong>ServerList</strong>：可以响应客户端的特定服务的服务器列表。</p></li><li><p><strong>ServerListFilter</strong>：可以动态获得的具有所需特征的候选服务器列表的过滤器。</p></li><li><p><strong>ServerListUpdater</strong>：用于执行动态服务器列表更新。</p></li><li><p><strong>Rule</strong>：负载均衡策略，用于确定从服务器列表返回哪个服务器。</p></li><li><p><strong>Ping</strong>：客户端用于快速检查服务器当时是否处于活动状态。</p></li><li><p><strong>LoadBalancer</strong>：负载均衡器，负责负载均衡调度的管理。</p></li></ul><h2 id="spring-cloud-ribbon简单使用" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ribbon简单使用" aria-hidden="true">#</a> Spring Cloud Ribbon简单使用</h2><p>通常情况下，将RestTemplate和Ribbon结合使用，例如：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RibbonConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@LoadBalanced</span>
    <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>消费端调用服务端接口：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RibbonService</span> <span class="token punctuation">{</span>
	
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token annotation punctuation">@LoadBalanced</span>
    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hi</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">&quot;http://service-hi/hi?name=&quot;</span><span class="token operator">+</span>name<span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在自动注入时，只会将标注了<code>@LoadBalanced</code>注解的RestTemplate对象注入进来。那么<code>@LoadBalanced</code>是如何做到的呢？我们来看一下源码：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">FIELD</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">PARAMETER</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Inherited</span>
<span class="token annotation punctuation">@Qualifier</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">LoadBalanced</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到在LoadBalanced的定义上添加了<code>@Qualifier</code>注解，由此实现了对<code>RestTemplate</code>对象的标记。下面我们就来看看，Spring Cloud Ribbon是如何实现客户端的负载均衡的。</p><h2 id="spring-cloud-ribbon的负载均衡策略" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ribbon的负载均衡策略" aria-hidden="true">#</a> Spring Cloud Ribbon的负载均衡策略</h2><p>Ribbon中负载均衡策略的抽象接口定义为<code>IRule</code>，下面来看看接口定义：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IRule</span><span class="token punctuation">{</span>
    <span class="token comment">/*
     *根据key从存活的服务列表中选择一个
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置负载均衡器</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLoadBalancer</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取负载均衡器</span>
    <span class="token keyword">public</span> <span class="token class-name">ILoadBalancer</span> <span class="token function">getLoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接口<code>AbstractLoadBalancerRule</code>是IRule的直接抽象类实现</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractLoadBalancerRule</span> <span class="token keyword">implements</span> <span class="token class-name">IRule</span><span class="token punctuation">,</span> <span class="token class-name">IClientConfigAware</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLoadBalancer</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>lb <span class="token operator">=</span> lb<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ILoadBalancer</span> <span class="token function">getLoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> lb<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>      
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们可以看到，其除了实现了一个IClientConfigAware接口，以及实现了负载均衡器的存取外，并没有什么具体的实现。好了，下面来看看IRule接口有哪些具体的实现类：</p><p><img src="/assets/image-20220612215843204-41523c56.png" alt="image-20220612215843204"></p><h3 id="负载均衡策略概述" tabindex="-1"><a class="header-anchor" href="#负载均衡策略概述" aria-hidden="true">#</a> 负载均衡策略概述</h3><ul><li><strong>ClientConfigEnableRoundRobinRule</strong>： 轮询</li><li><strong>BestAvailableRule</strong>：选择具有最低并发请求的服务器。</li><li><strong>RandomRule</strong>：随机选择一个服务器。</li><li><strong>RoundRobinRule</strong>：轮询选择服务器。</li><li><strong>RetryRule</strong>：具备重试机制的轮询。</li><li><strong>WeightedResponseTimeRule</strong>：根据使用平均响应时间去分配一个weight（权重） ，weight越低，被选择的可能性就越低。</li><li><strong>ZoneAvoidanceRule</strong>：根据区域和可用性筛选，再轮询选择服务器。</li></ul><p>下面依次介绍没法负载均衡器的实现。</p><h3 id="randomrule" tabindex="-1"><a class="header-anchor" href="#randomrule" aria-hidden="true">#</a> RandomRule</h3><p>随机选择，这个策略在实现上比较简单，就是先获取服务列表，通过<code>ThreadLocalRandom</code>生成一个server数量以内的随机数，然后判断一下对应的server是否存活，如果存活，就直接返回。如果服务已经down掉了，就循环这个过程</p><p>下面来看一下核心源码实现：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RandomRule</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLoadBalancerRule</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/** 从存活的服务中随机选择一个 */</span>
    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lb <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Server</span> server <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 获取存活的服务列表</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> upList <span class="token operator">=</span> lb<span class="token punctuation">.</span><span class="token function">getReachableServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 获取所有服务列表</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> allList <span class="token operator">=</span> lb<span class="token punctuation">.</span><span class="token function">getAllServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">int</span> serverCount <span class="token operator">=</span> allList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>serverCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment">// 没有服务，返回null</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			<span class="token comment">// 产生一个随机数</span>
            <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token function">chooseRandomInt</span><span class="token punctuation">(</span>serverCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            server <span class="token operator">=</span> upList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/*server为空，可能是该服务已经不可用了，继续选择 */</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             	<span class="token comment">// server为存活状态，直接返回</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 到这里说明server已经不可打了，设置为null</span>
            server <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> server<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 用来产生随机数</span>
    <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">chooseRandomInt</span><span class="token punctuation">(</span><span class="token keyword">int</span> serverCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>serverCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="roundrobinrule" tabindex="-1"><a class="header-anchor" href="#roundrobinrule" aria-hidden="true">#</a> RoundRobinRule</h3><p>轮询模式，使用一个整数与server列表的长度进行取余，来完成轮询操作。轮询成功，对整数进行加1操作。下面来看一下源码实现：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RoundRobinRule</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLoadBalancerRule</span> <span class="token punctuation">{</span>
	<span class="token comment">// 通过这个变量自增，与server数量取模，来完成轮询逻辑</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> nextServerCyclicCounter<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RoundRobinRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nextServerCyclicCounter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">RoundRobinRule</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setLoadBalancer</span><span class="token punctuation">(</span>lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 这里是核心实现</span>
    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lb <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;no load balancer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Server</span> server <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> count<span class="token operator">++</span> <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获取可用的服务列表</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> reachableServers <span class="token operator">=</span> lb<span class="token punctuation">.</span><span class="token function">getReachableServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 获取全部服务列表</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> allServers <span class="token operator">=</span> lb<span class="token punctuation">.</span><span class="token function">getAllServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> upCount <span class="token operator">=</span> reachableServers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> serverCount <span class="token operator">=</span> allServers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 首先判断是否有可用的服务</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>upCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>serverCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;No up servers available from load balancer: &quot;</span> <span class="token operator">+</span> lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 通过自增取模，来获取下一个server</span>
            <span class="token keyword">int</span> nextServerIndex <span class="token operator">=</span> <span class="token function">incrementAndGetModulo</span><span class="token punctuation">(</span>serverCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            server <span class="token operator">=</span> allServers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>nextServerIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/* server 为null 说明该服务可能出问题了 */</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			<span class="token comment">// 检查server是否存活，并且为提供服务做好准备</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">isReadyToServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// server已死，置空</span>
            server <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 轮询大于10次打印一个warning日志。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;No available alive servers after 10 tries from load balancer: &quot;</span> <span class="token operator">+</span> lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> server<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 获取下一个server的index，这里使用CAS+死循环的方式保证并发安全。
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">incrementAndGetModulo</span><span class="token punctuation">(</span><span class="token keyword">int</span> modulo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> current <span class="token operator">=</span> nextServerCyclicCounter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> next <span class="token operator">=</span> <span class="token punctuation">(</span>current <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> modulo<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nextServerCyclicCounter<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> next<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="retryrule" tabindex="-1"><a class="header-anchor" href="#retryrule" aria-hidden="true">#</a> RetryRule</h3><p>重试策略，针对现有负载均衡策略，添加重试逻辑。该策略的默认负载逻辑是轮询，可以通过set方法或构造方法进行修改。在给定的时间内无限次重试。</p><p>下面来看看核心源码实现(省略了一下不重要的逻辑)：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RetryRule</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLoadBalancerRule</span> <span class="token punctuation">{</span>
    <span class="token comment">// 默认的级联策略是 轮询策略，该参数可以通过构造函数或set方法进行设置</span>
	<span class="token class-name">IRule</span> subRule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RoundRobinRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 最大重试毫秒数，当总的执行时间超过500毫秒后，停止重试。默认500毫秒</span>
	<span class="token keyword">long</span> maxRetryMillis <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>

	<span class="token comment">/* 选择一个server*/</span>
	<span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 重试开始时间</span>
		<span class="token keyword">long</span> requestTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 重试截止时间</span>
		<span class="token keyword">long</span> deadline <span class="token operator">=</span> requestTime <span class="token operator">+</span> maxRetryMillis<span class="token punctuation">;</span>

		<span class="token class-name">Server</span> answer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token comment">// 首先使用级联的策略选择负载策略</span>
		answer <span class="token operator">=</span> subRule<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 如果answer无效 并且 未到deadline，执行重试逻辑</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>answer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>answer<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> deadline<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">InterruptTask</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InterruptTask</span><span class="token punctuation">(</span>deadline <span class="token operator">-</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 只要执行时间为超过 maxRetryMillis, 就无限次重试。</span>
			<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				answer <span class="token operator">=</span> subRule<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>answer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>answer<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> deadline<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">/* 让出cpu */</span>
					<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			task<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>answer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>answer<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> answer<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="clientconfigenabledroundrobinrule" tabindex="-1"><a class="header-anchor" href="#clientconfigenabledroundrobinrule" aria-hidden="true">#</a> ClientConfigEnabledRoundRobinRule</h3><p>该负载均衡策略内部使用的是轮询策略。这里没什么好说的。这里使用了一个组合模式</p><p>下面看看源码实现：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClientConfigEnabledRoundRobinRule</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLoadBalancerRule</span> <span class="token punctuation">{</span>

    <span class="token class-name">RoundRobinRule</span> roundRobinRule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RoundRobinRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initWithNiwsConfig</span><span class="token punctuation">(</span><span class="token class-name">IClientConfig</span> clientConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        roundRobinRule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RoundRobinRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLoadBalancer</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setLoadBalancer</span><span class="token punctuation">(</span>lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	roundRobinRule<span class="token punctuation">.</span><span class="token function">setLoadBalancer</span><span class="token punctuation">(</span>lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>roundRobinRule <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> roundRobinRule<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;This class has not been initialized with the RoundRobinRule class&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="weightedresponsetimerule" tabindex="-1"><a class="header-anchor" href="#weightedresponsetimerule" aria-hidden="true">#</a> WeightedResponseTimeRule</h3><p>以响应时间作为权重，进行负载分配。这里先介绍一些算法的实现，然后在看代码就很好理解了。</p><p>假设有A、B、C、D第个实例，平均响应时间是10,20,30,50，相加得到的总响应时间是100。每个实例的权重是总响应时间-自身响应时间，可得如下：</p><ul><li>A：100 - 10 = 90；</li><li>B：90 + 100 - 20 = 170；</li><li>C：170 + 100 - 30 = 240；</li><li>D： 240 + 100 - 50 = 290；</li></ul><p>则每个实例的权重空间为：</p><ul><li>A：[0, 90]</li><li>B：[90, 170]</li><li>C：[170, 240]</li><li>D：[240, 290]</li></ul><p>在获取实例的时候，通过290乘以一个0到1直接的随机数，这个随机数落到那个区间，就选取那个实例。好了，下面我们来看一下计算权重的源码实现：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeightedResponseTimeRule</span> <span class="token keyword">extends</span> <span class="token class-name">RoundRobinRule</span> <span class="token punctuation">{</span>
	<span class="token comment">// 定时任务的默认间隔时间间隔时间</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_TIMER_INTERVAL</span> <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token comment">// 定时任务的时间间隔</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> serverWeightTaskTimerInterval <span class="token operator">=</span> <span class="token constant">DEFAULT_TIMER_INTERVAL</span><span class="token punctuation">;</span>
    <span class="token comment">// 定时任务调度器</span>
    <span class="token keyword">protected</span> <span class="token class-name">Timer</span> serverWeightTimer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 设置负载均衡器</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLoadBalancer</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setLoadBalancer</span><span class="token punctuation">(</span>lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lb <span class="token keyword">instanceof</span> <span class="token class-name">BaseLoadBalancer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            name <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BaseLoadBalancer</span><span class="token punctuation">)</span> lb<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">initialize</span><span class="token punctuation">(</span>lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>serverWeightTimer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            serverWeightTimer<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 初始化一个定时调度器</span>
        serverWeightTimer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Timer</span><span class="token punctuation">(</span><span class="token string">&quot;NFLoadBalancer-serverWeightTimer-&quot;</span> <span class="token operator">+</span> name<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 提交定时任务</span>
        serverWeightTimer<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DynamicServerWeightTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> serverWeightTaskTimerInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 初始化运行</span>
        <span class="token class-name">ServerWeight</span> sw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerWeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sw<span class="token punctuation">.</span><span class="token function">maintainWeights</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 停止任务的钩子方法</span>
        <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addShutdownHook</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Stopping NFLoadBalancer-serverWeightTimer-&quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                serverWeightTimer<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 定时任务类</span>
    <span class="token keyword">class</span> <span class="token class-name">DynamicServerWeightTask</span> <span class="token keyword">extends</span> <span class="token class-name">TimerTask</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ServerWeight</span> serverWeight <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerWeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                serverWeight<span class="token punctuation">.</span><span class="token function">maintainWeights</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error running DynamicServerWeightTask for {}&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 这里就是具体计算权重的类了。</span>
    <span class="token keyword">class</span> <span class="token class-name">ServerWeight</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">maintainWeights</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ILoadBalancer</span> lb <span class="token operator">=</span> <span class="token function">getLoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lb <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 通过cas来加锁</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>serverWeightAssignmentInProgress<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span> 
            <span class="token punctuation">}</span>
            
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">AbstractLoadBalancer</span> nlb <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AbstractLoadBalancer</span><span class="token punctuation">)</span> lb<span class="token punctuation">;</span>
                <span class="token class-name">LoadBalancerStats</span> stats <span class="token operator">=</span> nlb<span class="token punctuation">.</span><span class="token function">getLoadBalancerStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>stats <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">double</span> totalResponseTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token comment">// 对所有服务的平均响应时间求和</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Server</span> server <span class="token operator">:</span> nlb<span class="token punctuation">.</span><span class="token function">getAllServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">ServerStats</span> ss <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">getSingleServerStat</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    totalResponseTime <span class="token operator">+=</span> ss<span class="token punctuation">.</span><span class="token function">getResponseTimeAvg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">Double</span> weightSoFar <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
                <span class="token comment">// 计算权重</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> finalWeights <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Server</span> server <span class="token operator">:</span> nlb<span class="token punctuation">.</span><span class="token function">getAllServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">ServerStats</span> ss <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">getSingleServerStat</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">double</span> weight <span class="token operator">=</span> totalResponseTime <span class="token operator">-</span> ss<span class="token punctuation">.</span><span class="token function">getResponseTimeAvg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    weightSoFar <span class="token operator">+=</span> weight<span class="token punctuation">;</span>
                    finalWeights<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>weightSoFar<span class="token punctuation">)</span><span class="token punctuation">;</span>   
                <span class="token punctuation">}</span>
                <span class="token function">setWeights</span><span class="token punctuation">(</span>finalWeights<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error calculating server weights&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                serverWeightAssignmentInProgress<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面来看服务选择的源码实现：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeightedResponseTimeRule</span> <span class="token keyword">extends</span> <span class="token class-name">RoundRobinRule</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lb <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Server</span> server <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 定时任务计算出的权重列表</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> currentWeights <span class="token operator">=</span> accumulatedWeights<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> allList <span class="token operator">=</span> lb<span class="token punctuation">.</span><span class="token function">getAllServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> serverCount <span class="token operator">=</span> allList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>serverCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">int</span> serverIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment">// 获取到权重的最大值</span>
            <span class="token keyword">double</span> maxTotalWeight <span class="token operator">=</span> currentWeights<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> currentWeights<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>currentWeights<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token comment">// 判断权重是否有效，</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>maxTotalWeight <span class="token operator">&lt;</span> <span class="token number">0.001d</span> <span class="token operator">||</span> serverCount <span class="token operator">!=</span> currentWeights<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果权重不可用的话，这里选择轮询策略</span>
                server <span class="token operator">=</span>  <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span><span class="token function">getLoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> server<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 这里计算权重，使用最大数乘以一个0到1直接的随机值，结果落到那个区间，就选取区间对应的实例</span>
                <span class="token keyword">double</span> randomWeight <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> maxTotalWeight<span class="token punctuation">;</span>
                <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Double</span> d <span class="token operator">:</span> currentWeights<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>d <span class="token operator">&gt;=</span> randomWeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        serverIndex <span class="token operator">=</span> n<span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        n<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                server <span class="token operator">=</span> allList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>serverIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			<span class="token comment">// 老套路，如果server 为null 就再来一遍</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 如果server 存活着，直接返回</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 到这里，说明server已经死了。设为null</span>
            server <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> server<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>   
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="bestavailablerule" tabindex="-1"><a class="header-anchor" href="#bestavailablerule" aria-hidden="true">#</a> BestAvailableRule</h3><p>该策略会选择一个响应最快的server返回。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BestAvailableRule</span> <span class="token keyword">extends</span> <span class="token class-name">ClientConfigEnabledRoundRobinRule</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">LoadBalancerStats</span> loadBalancerStats<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loadBalancerStats <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> serverList <span class="token operator">=</span> <span class="token function">getLoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAllServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> minimalConcurrentConnections <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> currentTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Server</span> chosen <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Server</span> server<span class="token operator">:</span> serverList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ServerStats</span> serverStats <span class="token operator">=</span> loadBalancerStats<span class="token punctuation">.</span><span class="token function">getSingleServerStat</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>serverStats<span class="token punctuation">.</span><span class="token function">isCircuitBreakerTripped</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> concurrentConnections <span class="token operator">=</span> serverStats<span class="token punctuation">.</span><span class="token function">getActiveRequestsCount</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>concurrentConnections <span class="token operator">&lt;</span> minimalConcurrentConnections<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    minimalConcurrentConnections <span class="token operator">=</span> concurrentConnections<span class="token punctuation">;</span>
                    chosen <span class="token operator">=</span> server<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>chosen <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> chosen<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLoadBalancer</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setLoadBalancer</span><span class="token punctuation">(</span>lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lb <span class="token keyword">instanceof</span> <span class="token class-name">AbstractLoadBalancer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            loadBalancerStats <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractLoadBalancer</span><span class="token punctuation">)</span> lb<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLoadBalancerStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="zoneavoidancerule" tabindex="-1"><a class="header-anchor" href="#zoneavoidancerule" aria-hidden="true">#</a> ZoneAvoidanceRule</h3><p>这个是Ribbon中最重要的一个负载均衡策略，该策略是Spring Cloud自动装配是的默认选项。</p><p>该类继承自<code>PredicateBasedRule</code>，老规矩，先来看看父类的定义：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">PredicateBasedRule</span> <span class="token keyword">extends</span> <span class="token class-name">ClientConfigEnabledRoundRobinRule</span> <span class="token punctuation">{</span>
   
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">AbstractServerPredicate</span> <span class="token function">getPredicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ILoadBalancer</span> lb <span class="token operator">=</span> <span class="token function">getLoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 注意 getPredicate() 是一个抽象方法</span>
        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> server <span class="token operator">=</span> <span class="token function">getPredicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chooseRoundRobinAfterFiltering</span><span class="token punctuation">(</span>lb<span class="token punctuation">.</span><span class="token function">getAllServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> server<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>       
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>该类重写了choose方法，在方法中调用了<code>AbstractServerPredicate#chooseRoundRobinAfterFiltering</code>方法，来看看这个源码：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// AbstractServerPredicate#chooseRoundRobinAfterFiltering</span>
<span class="token keyword">public</span> <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token function">chooseRoundRobinAfterFiltering</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> servers<span class="token punctuation">,</span> <span class="token class-name">Object</span> loadBalancerKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取符合条件的server集合</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> eligible <span class="token operator">=</span> <span class="token function">getEligibleServers</span><span class="token punctuation">(</span>servers<span class="token punctuation">,</span> loadBalancerKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>eligible<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">absent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 这里实现了一个轮询功能</span>
    <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>eligible<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token function">incrementAndGetModulo</span><span class="token punctuation">(</span>eligible<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 轮询的具体实现</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">incrementAndGetModulo</span><span class="token punctuation">(</span><span class="token keyword">int</span> modulo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> current <span class="token operator">=</span> nextIndex<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> next <span class="token operator">=</span> <span class="token punctuation">(</span>current <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> modulo<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextIndex<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> current <span class="token operator">&lt;</span> modulo<span class="token punctuation">)</span>
            <span class="token keyword">return</span> current<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到该方法首先调用<code>getEligibleServers</code>方法过滤出合适的server列表，然后通过一个简单的轮询来选择了一个server进行返回，那么这个符合条件的server集合是如何选出的呢？下面来看看代码：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// AbstractServerPredicate#getEligibleServers</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> serverOnlyPredicate <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Server</span> input<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    
        <span class="token keyword">return</span> <span class="token class-name">AbstractServerPredicate</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PredicateKey</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token function">getEligibleServers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> servers<span class="token punctuation">,</span> <span class="token class-name">Object</span> loadBalancerKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>loadBalancerKey <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ImmutableList</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span><span class="token class-name">Iterables</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>servers<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getServerOnlyPredicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> results <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Server</span> server<span class="token operator">:</span> servers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PredicateKey</span><span class="token punctuation">(</span>loadBalancerKey<span class="token punctuation">,</span> server<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                results<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> results<span class="token punctuation">;</span>            
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token function">getServerOnlyPredicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> serverOnlyPredicate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>观察上面的方法，不管loadBalancerKey是否为null，最后都是把server封装到PredicateKey的实例中(区别在于如果loadBalancerKey不为null的话，会把loadBalancerKey也封装到PredicateKey中)，然后调用this.apply()方法进行判断，但是apply方法，在这个类中并没有实现，所以这个任务就落到子类中。下面来看看AbstractServerPredicate的实现类图：</p><p><img src="/assets/image-20220706102437731-5db46389.png" alt="image-20220706102437731"></p><p>这里就不卖关子了，在ZoneAvoidanceRule中，使用了ZoneAvoidancePredicate和AvailabilityPredicate两个实现类，另外也使用了一个在AbstractServerPredicate内部实现的内部类。</p><p>CompositePredicate是一个组合模式的实现</p><p>ZoneAffinityPredicate在服务列表过滤器中有使用到，具体的信息可以参考过滤器ZoneAffinityServerListFilter。</p><p>下面我们就来看看ZoneAvoidanceRule是如何使用Predicate的。首先来看看构造函数以及抽象实现方法：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZoneAvoidanceRule</span> <span class="token keyword">extends</span> <span class="token class-name">PredicateBasedRule</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">// 组合模式</span>
    <span class="token keyword">private</span> <span class="token class-name">CompositePredicate</span> compositePredicate<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">ZoneAvoidanceRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ZoneAvoidancePredicate</span> zonePredicate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZoneAvoidancePredicate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AvailabilityPredicate</span> availabilityPredicate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AvailabilityPredicate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        compositePredicate <span class="token operator">=</span> <span class="token function">createCompositePredicate</span><span class="token punctuation">(</span>zonePredicate<span class="token punctuation">,</span> availabilityPredicate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token class-name">CompositePredicate</span> <span class="token function">createCompositePredicate</span><span class="token punctuation">(</span><span class="token class-name">ZoneAvoidancePredicate</span> p1<span class="token punctuation">,</span> <span class="token class-name">AvailabilityPredicate</span> p2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 在这里构造成最终使用的Predicate</span>
        <span class="token keyword">return</span> <span class="token class-name">CompositePredicate</span><span class="token punctuation">.</span><span class="token function">withPredicates</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">)</span>
                             <span class="token punctuation">.</span><span class="token function">addFallbackPredicate</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span>
                             <span class="token punctuation">.</span><span class="token function">addFallbackPredicate</span><span class="token punctuation">(</span><span class="token class-name">AbstractServerPredicate</span><span class="token punctuation">.</span><span class="token function">alwaysTrue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                             <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">AbstractServerPredicate</span> <span class="token function">getPredicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> compositePredicate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再来看看CompositePredicate的核心代码实现：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CompositePredicate</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractServerPredicate</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">AbstractServerPredicate</span> delegate<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractServerPredicate</span><span class="token punctuation">&gt;</span></span> fallbacks <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token keyword">private</span> <span class="token keyword">int</span> minimalFilteredServers <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">float</span> minimalFilteredPercentage <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">PredicateKey</span> input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> delegate<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token function">getEligibleServers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> servers<span class="token punctuation">,</span> <span class="token class-name">Object</span> loadBalancerKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getEligibleServers</span><span class="token punctuation">(</span>servers<span class="token punctuation">,</span> loadBalancerKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractServerPredicate</span><span class="token punctuation">&gt;</span></span> i <span class="token operator">=</span> fallbacks<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> minimalFilteredServers <span class="token operator">&amp;&amp;</span> result<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>servers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> minimalFilteredPercentage<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> i<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">AbstractServerPredicate</span> predicate <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> predicate<span class="token punctuation">.</span><span class="token function">getEligibleServers</span><span class="token punctuation">(</span>servers<span class="token punctuation">,</span> loadBalancerKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>到这里ZoneAvoidanceRule的实现流程大致就清晰了。首先调用服务选择会从chose方法进入，在chose方法中有这样一条语句，<code>getPredicate().chooseRoundRobinAfterFiltering(lb.getAllServers(), key);</code>，这里会返回CompositePredicate对象，里面组合了两个Predicate，分别是ZoneAvoidancePredicate和AvailabilityPredicate，然后调用CompositePredicate中的过滤方法，最终会通过这两个Predicate中的apply方法进行判定。</p><p>下面我们就正式来分析过滤逻辑</p><p><strong>ZoneAvoidancePredicate</strong></p><p><strong>AvailabilityPredicate</strong></p><h2 id="spring-cloud-ribbon的心跳检测机制" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ribbon的心跳检测机制" aria-hidden="true">#</a> Spring Cloud Ribbon的心跳检测机制</h2><p><code>IPing</code>是心跳检测的顶级定义接口，下面先看看接口定义：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IPing</span> <span class="token punctuation">{</span>   
    <span class="token doc-comment comment">/** 检查给定的服务是否处于存活状态，即在负载平衡时将其视为候选对象 */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token class-name">Server</span> server<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里的定义也很简单，就是检查给定的服务是否存活。下面来看看类的实现类图：</p><img src="/assets/image-20220628151228285-69b0d791.png" alt="image-20220628151228285" style="zoom:67%;"><ul><li>NoOpPing： 什么都不做</li><li>PingConstant：通过配置参数设置服务存活状态</li><li>DummyPing： 总是认为存活</li><li>PingUrl：使用HttpClient构造一个HttpRequest，发起一个Get调用，如果成功，证明服务存活</li></ul><p>下面就开始一一解析</p><h3 id="noopping" tabindex="-1"><a class="header-anchor" href="#noopping" aria-hidden="true">#</a> NoOpPing</h3><p>从字面上理解，no operation ping ，就是不做任何操作。这个是Ribbon中最简单的实现，基本上没什么用。代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NoOpPing</span> <span class="token keyword">implements</span> <span class="token class-name">IPing</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token class-name">Server</span> server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="pingurl" tabindex="-1"><a class="header-anchor" href="#pingurl" aria-hidden="true">#</a> PingUrl</h3><p>这个实现也比较简单，对给定的服务发起一个Get请求，然后判断响应是否为200，响应的结果是否服务预期。如果都符合，则服务为存活状态。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PingUrl</span> <span class="token keyword">implements</span> <span class="token class-name">IPing</span> <span class="token punctuation">{</span>

    <span class="token class-name">String</span> pingAppendString <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
	<span class="token comment">// 标识是否是https协议，有get/set方法，这里省略了</span>
    <span class="token keyword">boolean</span> isSecure <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token comment">// 预期的响应结果，有get/set方法，这里省略了</span>
    <span class="token class-name">String</span> expectedContent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">PingUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">PingUrl</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isSecure<span class="token punctuation">,</span> <span class="token class-name">String</span> pingAppendString<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isSecure <span class="token operator">=</span> isSecure<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pingAppendString <span class="token operator">=</span> <span class="token punctuation">(</span>pingAppendString <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> pingAppendString <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 核心实现就在这里了</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token class-name">Server</span> server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 判断协议类型，拼接url</span>
        <span class="token class-name">String</span> urlStr   <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isSecure<span class="token punctuation">)</span><span class="token punctuation">{</span>
            urlStr <span class="token operator">=</span> <span class="token string">&quot;https://&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            urlStr <span class="token operator">=</span> <span class="token string">&quot;http://&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        urlStr <span class="token operator">+=</span> server<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        urlStr <span class="token operator">+=</span> <span class="token function">getPingAppendString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> isAlive <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token comment">// 构造HttpRequest， 并发起请求</span>
        <span class="token class-name">HttpClient</span> httpClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HttpUriRequest</span> getRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpGet</span><span class="token punctuation">(</span>urlStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> content<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">HttpResponse</span> response <span class="token operator">=</span> httpClient<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>getRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            content <span class="token operator">=</span> <span class="token class-name">EntityUtils</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 判断响应码是否为 200</span>
            isAlive <span class="token operator">=</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStatusLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getExpectedContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;content:&quot;</span> <span class="token operator">+</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>content <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    isAlive <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                    <span class="token comment">// 判断响应结果是否和预期一致</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token function">getExpectedContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        isAlive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                        isAlive <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span><span class="token punctuation">{</span>
            <span class="token comment">// Release the connection.</span>
            getRequest<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> isAlive<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="pingconstant" tabindex="-1"><a class="header-anchor" href="#pingconstant" aria-hidden="true">#</a> PingConstant</h3><p>基于配置的实现。不知道为什么要有这么个实现。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PingConstant</span> <span class="token keyword">implements</span> <span class="token class-name">IPing</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这个用来标识是否存活， 通过代码设置</span>
    <span class="token keyword">boolean</span> constant <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token comment">// 设置存活状态</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setConstant</span><span class="token punctuation">(</span><span class="token class-name">String</span> constantStr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        constant <span class="token operator">=</span> <span class="token punctuation">(</span>constantStr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>constantStr<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 设置存活状态</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setConstant</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> constant<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>constant <span class="token operator">=</span> constant<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token class-name">Server</span> server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> constant<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="dummyping" tabindex="-1"><a class="header-anchor" href="#dummyping" aria-hidden="true">#</a> DummyPing</h3><p>该接口继承自AbstractLoadBalancerPing， 其实现也很简单，认为服务总是存活状态。首先看一下父类的实现：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractLoadBalancerPing</span> <span class="token keyword">implements</span> <span class="token class-name">IPing</span><span class="token punctuation">,</span> <span class="token class-name">IClientConfigAware</span><span class="token punctuation">{</span>
    <span class="token class-name">AbstractLoadBalancer</span> lb<span class="token punctuation">;</span>   
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token class-name">Server</span> server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLoadBalancer</span><span class="token punctuation">(</span><span class="token class-name">AbstractLoadBalancer</span> lb<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>lb <span class="token operator">=</span> lb<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>    
    <span class="token keyword">public</span> <span class="token class-name">AbstractLoadBalancer</span> <span class="token function">getLoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> lb<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再来看看该类的实现：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DummyPing</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLoadBalancerPing</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">DummyPing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
	<span class="token comment">// 默认返回true，即所有的服务都存活</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token class-name">Server</span> server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initWithNiwsConfig</span><span class="token punctuation">(</span><span class="token class-name">IClientConfig</span> clientConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="spring-cloud-ribbon的服务列表" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ribbon的服务列表" aria-hidden="true">#</a> Spring Cloud Ribbon的服务列表</h2><p>该组件主要提供获取服务列表的功能。<code>ServerList</code>是服务列表组件的顶级接口定义，里边只定义了两个方法，包括获取原始的服务列表，以及更新后的服务列表。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ServerList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/** 返回初试的服务列表 */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getInitialListOfServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/** 返回更新后的服务列表 */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUpdatedListOfServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其实现的类图如下</p><img src="/assets/image-20220614170722800-3670d6bc.png" alt="image-20220614170722800" style="zoom:67%;"><ul><li><p><strong>StaticServerList</strong>： 静态的服务列表维护类。说白了就是写死的。</p></li><li><p><strong>ConfigurationBasedServerList:</strong> 基于读取Archaius配置文件来维护ServerList</p></li><li><p><strong>NacosServerList：</strong></p></li></ul><p>这里边StaticServerList是Spring Cloud提供的一个实现，NacosServerList是Nacos提供的实现。而ConfigurationBasedServerList是Ribbon提供的实现。下面我们来一一讲解。</p><h3 id="staticserverlist" tabindex="-1"><a class="header-anchor" href="#staticserverlist" aria-hidden="true">#</a> StaticServerList</h3><p>静态服务列表，见名知意，这个服务列表在配置完成后，就不会有变动了。说白了就是基于配置固定的。实现如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StaticServerList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">ServerList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> servers<span class="token punctuation">;</span>
	<span class="token keyword">public</span> <span class="token class-name">StaticServerList</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> servers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>servers <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>servers<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getInitialListOfServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> servers<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUpdatedListOfServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> servers<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="configurationbasedserverlist" tabindex="-1"><a class="header-anchor" href="#configurationbasedserverlist" aria-hidden="true">#</a> ConfigurationBasedServerList</h3><p>这个服务管理类是Ribbon提供的服务管理类。由继承关系可知，ConfigurationBasedServerList继承自AbstractServerList，而AbstractServerList由实现了ServerList接口，下面我们就来看看AbstractServerList类扩展了那些功能：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractServerList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">ServerList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">IClientConfigAware</span> <span class="token punctuation">{</span>   
    <span class="token keyword">public</span> <span class="token class-name">AbstractServerListFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getFilterImpl</span><span class="token punctuation">(</span><span class="token class-name">IClientConfig</span> niwsClientConfig<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClientException</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> niwsServerListFilterClassName <span class="token operator">=</span> niwsClientConfig
                    <span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>
                            <span class="token class-name">CommonClientConfigKey<span class="token punctuation">.</span>NIWSServerListFilterClassName</span><span class="token punctuation">,</span>
                            <span class="token class-name">ZoneAffinityServerListFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">AbstractServerListFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> abstractNIWSServerListFilter <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AbstractServerListFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> 
                <span class="token class-name">ClientFactory</span><span class="token punctuation">.</span><span class="token function">instantiateInstanceWithClientConfig</span><span class="token punctuation">(</span>niwsServerListFilterClassName<span class="token punctuation">,</span> niwsClientConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> abstractNIWSServerListFilter<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>首先，该类实现了<code>IClientConfigAware</code>接口，说明他具有获取<code>IClientConfig</code>的能力。另外，他还提供了一个<code>getFilterImpl</code>方法，该方法用来获取服务列表过滤器，如果不配置，默认使用的是<code>ZoneAffinityServerListFilter</code>，如果需要配置指定的过滤器可以使用如下配置：</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">&lt;clientName&gt;.&lt;nameSpace&gt;.NIWSServerListFilterClassName</span><span class="token punctuation">=</span><span class="token value attr-value">className</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>看完了父类，咱们接着看本类的实现</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigurationBasedServerList</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractServerList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span>  <span class="token punctuation">{</span>

	<span class="token keyword">private</span> <span class="token class-name">IClientConfig</span> clientConfig<span class="token punctuation">;</span>
		
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token function">getInitialListOfServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token keyword">return</span> <span class="token function">getUpdatedListOfServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUpdatedListOfServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> listOfServers <span class="token operator">=</span> clientConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">CommonClientConfigKey<span class="token punctuation">.</span>ListOfServers</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">derive</span><span class="token punctuation">(</span>listOfServers<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initWithNiwsConfig</span><span class="token punctuation">(</span><span class="token class-name">IClientConfig</span> clientConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token keyword">this</span><span class="token punctuation">.</span>clientConfig <span class="token operator">=</span> clientConfig<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">protected</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token function">derive</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Strings</span><span class="token punctuation">.</span><span class="token function">isNullOrEmpty</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token operator">:</span> value<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Server</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
        <span class="token keyword">return</span> list<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实现也很简单，可以看到<code>getInitialListOfServers()</code>方法调用的是<code>getUpdatedListOfServers()</code>方法，而<code>getUpdatedListOfServers()</code>直接从客户端配置中加载配置的服务列表。可以使用如下方法配置服务列表：</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">&lt;clientName&gt;.&lt;nameSpace&gt;.listOfServers</span><span class="token punctuation">=</span> <span class="token value attr-value">host1:port1,host2:port2</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="nacosserverlist" tabindex="-1"><a class="header-anchor" href="#nacosserverlist" aria-hidden="true">#</a> NacosServerList</h3><p>略</p><h2 id="spring-cloud-ribbon的服务列表过滤" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ribbon的服务列表过滤" aria-hidden="true">#</a> Spring Cloud Ribbon的服务列表过滤</h2><p>服务实例过滤器（ServerListFilter）为负载均衡器（Loadbalancer）提供从服务实例列表（ServerList）获取的服务实例过滤出符合要求的服务实例。</p><p>负载均衡器（Loadbalancer）通过服务实例列表(ServerList)从注册中心(register)或者配置文件（yaml或properties）上读取全部服务实例(server)，然后以服务实例过滤器(ServerListFilter)的过滤方式进行筛选留下满足条件的服务实例，进而借助负载均衡策略(IRule)选择出一个合适的服务实例。</p><p>首先来看接口定义：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ServerListFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
	<span class="token comment">// 获取过滤后的服务列表</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getFilteredListOfServers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> servers<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个接口定义特别简单，就一个方法，返回过滤后的接口信息。</p><p>下面来看一下接口的抽象实现：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractServerListFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">ServerListFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">LoadBalancerStats</span> stats<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLoadBalancerStats</span><span class="token punctuation">(</span><span class="token class-name">LoadBalancerStats</span> stats<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stats <span class="token operator">=</span> stats<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token class-name">LoadBalancerStats</span> <span class="token function">getLoadBalancerStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> stats<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面来看一下类图：</p><img src="/assets/image-20220615094039643-8fb7fb47.png" alt="image-20220615094039643" style="zoom:60%;"><ul><li>ZoneAffinityServerListFilter:</li></ul><p>这里面ZonePreferenceServerListFilter是SpringCloud的实现，其余为Ribbon内部的实现。下面就来看实现源码。</p><h3 id="zoneaffinityserverlistfilter" tabindex="-1"><a class="header-anchor" href="#zoneaffinityserverlistfilter" aria-hidden="true">#</a> ZoneAffinityServerListFilter</h3><p>区域相关性筛选过滤</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZoneAffinityServerListFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span>
        <span class="token class-name">AbstractServerListFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">IClientConfigAware</span> <span class="token punctuation">{</span>
	<span class="token comment">// 区域亲和性， 默认false</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> zoneAffinity <span class="token operator">=</span> <span class="token class-name">DefaultClientConfigImpl</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_ENABLE_ZONE_AFFINITY</span><span class="token punctuation">;</span>
    <span class="token comment">// 区域排除， 默认false</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> zoneExclusive <span class="token operator">=</span> <span class="token class-name">DefaultClientConfigImpl</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_ENABLE_ZONE_EXCLUSIVITY</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getFilteredListOfServers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> servers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>zone <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>zoneAffinity <span class="token operator">||</span> zoneExclusive<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> servers <span class="token operator">!=</span><span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> servers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// 这里调用过滤条件</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> filteredServers <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token class-name">Iterables</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
                    servers<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zoneAffinityPredicate<span class="token punctuation">.</span><span class="token function">getServerOnlyPredicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 判断是否需要进行区域亲和性过滤</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldEnableZoneAffinity</span><span class="token punctuation">(</span>filteredServers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> filteredServers<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>zoneAffinity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                overrideCounter<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> servers<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>          
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，这里首先调用ZoneAffinityPredicate.getServerOnlyPredicate()方法进行过滤，然后调用shouldEnableZoneAffinity()方法判断是否真的需要返回过滤的数据</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZoneAffinityPredicate</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractServerPredicate</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> zone <span class="token operator">=</span> <span class="token class-name">ConfigurationManager</span><span class="token punctuation">.</span><span class="token function">getDeploymentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token class-name">ContextKey</span><span class="token punctuation">.</span>zone<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">PredicateKey</span> input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Server</span> s <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">getServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> az <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">getZone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>az <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> zone <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> az<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>zone<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在ZoneAffinityPredicate里会对server的zone进行判断，只有相同的zone才会被选出来。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">shouldEnableZoneAffinity</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> filtered<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>zoneAffinity <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>zoneExclusive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>zoneExclusive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">LoadBalancerStats</span> stats <span class="token operator">=</span> <span class="token function">getLoadBalancerStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stats <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> zoneAffinity<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">ZoneSnapshot</span> snapshot <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">getZoneSnapshot</span><span class="token punctuation">(</span>filtered<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> loadPerServer <span class="token operator">=</span> snapshot<span class="token punctuation">.</span><span class="token function">getLoadPerServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> instanceCount <span class="token operator">=</span> snapshot<span class="token punctuation">.</span><span class="token function">getInstanceCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            
        <span class="token keyword">int</span> circuitBreakerTrippedCount <span class="token operator">=</span> snapshot<span class="token punctuation">.</span><span class="token function">getCircuitTrippedCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> circuitBreakerTrippedCount<span class="token punctuation">)</span><span class="token operator">/</span>instanceCount<span class="token operator">&gt;=</span>blackOutServerPercentageThreshold<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
            <span class="token operator">||</span> loadPerServer <span class="token operator">&gt;=</span> activeReqeustsPerServerThreshold<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">||</span> <span class="token punctuation">(</span>instanceCount <span class="token operator">-</span> circuitBreakerTrippedCount<span class="token punctuation">)</span> <span class="token operator">&lt;</span> availableServersThreshold<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在这个方法中主要是对一些统计数据进行判定，如果目标zone的server统计数据不太好，达到断路的标准，则不会返回该zone的server。</p><h3 id="serverlistsubsetfilter" tabindex="-1"><a class="header-anchor" href="#serverlistsubsetfilter" aria-hidden="true">#</a> ServerListSubsetFilter</h3><p>对于过滤后的服务器列表，在这里会进行进一步的过滤，包括剔除一些不健康的服务列表，只保留下最稳定的服务器列表，如：</p><ul><li><p>并发连接计数超过客户端配置的服务列表，配置项为 <code>&lt;clientName&gt;.&lt;nameSpace&gt;.ServerListSubsetFilter.eliminationConnectionThresold</code></p></li><li><p>服务故障计数超过客户端配置的列表，配置项为：<code>&lt;clientName&gt;.&lt;nameSpace&gt;.ServerListSubsetFilter.eliminationFailureThresold</code></p></li><li><p>如果前两部剔除的列表小于配置的剔除比例，其余服务按运行状况排序，强制末位剔除。配置项为：</p><p><code>&lt;clientName&gt;.&lt;nameSpace&gt;.ServerListSubsetFilter.forceEliminatePercent</code></p></li></ul><p>下面来看代码实现：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServerListSubsetFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">ZoneAffinityServerListFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">IClientConfigAware</span><span class="token punctuation">,</span> <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> currentSubset <span class="token operator">=</span> <span class="token class-name">Sets</span><span class="token punctuation">.</span><span class="token function">newHashSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

        
    <span class="token doc-comment comment">/** 过滤服务列表 */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getFilteredListOfServers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> servers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 首先调用父类的方法进行过滤</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> zoneAffinityFiltered <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getFilteredListOfServers</span><span class="token punctuation">(</span>servers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> candidates <span class="token operator">=</span> <span class="token class-name">Sets</span><span class="token punctuation">.</span><span class="token function">newHashSet</span><span class="token punctuation">(</span>zoneAffinityFiltered<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> newSubSet <span class="token operator">=</span> <span class="token class-name">Sets</span><span class="token punctuation">.</span><span class="token function">newHashSet</span><span class="token punctuation">(</span>currentSubset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取统计信息</span>
        <span class="token class-name">LoadBalancerStats</span> lbStats <span class="token operator">=</span> <span class="token function">getLoadBalancerStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">T</span> server<span class="token operator">:</span> currentSubset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 剔除可能已经下线的server</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>candidates<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                newSubSet<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">ServerStats</span> stats <span class="token operator">=</span> lbStats<span class="token punctuation">.</span><span class="token function">getSingleServerStat</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 判断，如果并发连接数或故障数大于客户端配置的数量，予以剔除</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span><span class="token function">getActiveRequestsCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> eliminationConnectionCountThreshold<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token operator">||</span> stats<span class="token punctuation">.</span><span class="token function">getFailureCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> eliminationFailureCountThreshold<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    newSubSet<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    candidates<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 计算需要剔除的数量</span>
        <span class="token keyword">int</span> targetedListSize <span class="token operator">=</span> sizeProp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// sizeProp 默认20</span>
        <span class="token keyword">int</span> numEliminated <span class="token operator">=</span> currentSubset<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> newSubSet<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> minElimination <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>targetedListSize <span class="token operator">*</span> eliminationPercent<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> numToForceEliminate <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>targetedListSize <span class="token operator">&lt;</span> newSubSet<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// size is shrinking</span>
            numToForceEliminate <span class="token operator">=</span> newSubSet<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> targetedListSize<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>minElimination <span class="token operator">&gt;</span> numEliminated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            numToForceEliminate <span class="token operator">=</span> minElimination <span class="token operator">-</span> numEliminated<span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>numToForceEliminate <span class="token operator">&gt;</span> newSubSet<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            numToForceEliminate <span class="token operator">=</span> newSubSet<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 如果需要剔除的数量大于0， 执行剔除</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>numToForceEliminate <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> sortedSubSet <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>newSubSet<span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token comment">// 排序，末尾淘汰</span>
            <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>sortedSubSet<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> forceEliminated <span class="token operator">=</span> sortedSubSet<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> numToForceEliminate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            newSubSet<span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span>forceEliminated<span class="token punctuation">)</span><span class="token punctuation">;</span>
            candidates<span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span>forceEliminated<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 在剔除不健康的服务和强制剔除后，如果剩余的服务数量小于目标集合数量(默认20)，则从原始服务列表中随机加过来一些。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newSubSet<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> targetedListSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 计算需要选择的数量</span>
            <span class="token keyword">int</span> numToChoose <span class="token operator">=</span> targetedListSize <span class="token operator">-</span> newSubSet<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            candidates<span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span>newSubSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>numToChoose <span class="token operator">&gt;</span> candidates<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Not enough healthy instances to choose, fallback to use the</span>
                <span class="token comment">// total server pool</span>
                candidates <span class="token operator">=</span> <span class="token class-name">Sets</span><span class="token punctuation">.</span><span class="token function">newHashSet</span><span class="token punctuation">(</span>zoneAffinityFiltered<span class="token punctuation">)</span><span class="token punctuation">;</span>
                candidates<span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span>newSubSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 选择指定数量的列表</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> chosen <span class="token operator">=</span> <span class="token function">randomChoose</span><span class="token punctuation">(</span><span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>candidates<span class="token punctuation">)</span><span class="token punctuation">,</span> numToChoose<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">T</span> server<span class="token operator">:</span> chosen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 添加到目标集合中</span>
                newSubSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        currentSubset <span class="token operator">=</span> newSubSet<span class="token punctuation">;</span>
        <span class="token comment">// 返回过滤后的结果</span>
        <span class="token keyword">return</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>newSubSet<span class="token punctuation">)</span><span class="token punctuation">;</span>            
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** 选择指定数量的服务列表 */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">randomChoose</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> servers<span class="token punctuation">,</span> <span class="token keyword">int</span> toChoose<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> size <span class="token operator">=</span> servers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>toChoose <span class="token operator">&gt;=</span> size <span class="token operator">||</span> toChoose <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> servers<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> toChoose<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 生成一个随机数，并与i做交换</span>
            <span class="token keyword">int</span> index <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">T</span> tmp <span class="token operator">=</span> servers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            servers<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> servers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            servers<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> servers<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> toChoose<span class="token punctuation">)</span><span class="token punctuation">;</span>        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="zonepreferenceserverlistfilter" tabindex="-1"><a class="header-anchor" href="#zonepreferenceserverlistfilter" aria-hidden="true">#</a> ZonePreferenceServerListFilter</h3><p>该过滤器是Spring Cloud中的实现，该类继承了ZoneAffinityServerListFilter，并重写了getFilteredListOfServers方法。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZonePreferenceServerListFilter</span> <span class="token keyword">extends</span> <span class="token class-name">ZoneAffinityServerListFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

	<span class="token keyword">private</span> <span class="token class-name">String</span> zone<span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token function">getFilteredListOfServers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> servers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> output <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getFilteredListOfServers</span><span class="token punctuation">(</span>servers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果size相同，则认为服务可能没有执行过滤</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>zone <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> output<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> servers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> local <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Server</span> server <span class="token operator">:</span> output<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>zone<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">getZone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					local<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>local<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> local<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> output<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里会对父类过滤出来的结果记性判断，如果父类返回的结果没有按区域进行亲和性过滤，那么这里会在过滤一次，如果过滤后的结果为空，则返回父类的结果，否则返回原始结果。</p><h2 id="spring-cloud-ribbon的服务列表更新" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ribbon的服务列表更新" aria-hidden="true">#</a> Spring Cloud Ribbon的服务列表更新</h2><p>该组件主要提供对服务列表的更新操作。</p><p>该组件的顶级接口为<code>ServerListUpdater</code>，下面来看看该接口定义了那些方法：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ServerListUpdater</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/** 一个内部接口，实际用来执行服务列表更新的操作 */</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UpdateAction</span> <span class="token punctuation">{</span>
        <span class="token keyword">void</span> <span class="token function">doUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     *开始服务列表更新的动作，这个接口是幂等的
     */</span>
    <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token class-name">UpdateAction</span> updateAction<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 停止服务列表更新的动作
     */</span>
    <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 返回最后更新的时间
     */</span>
    <span class="token class-name">String</span> <span class="token function">getLastUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 距最后一次更新，过去了多少毫秒
     */</span>
    <span class="token keyword">long</span> <span class="token function">getDurationSinceLastUpdateMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 返回丢失的更新周期数
     */</span>
    <span class="token keyword">int</span> <span class="token function">getNumberMissedCycles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 返回使用的线程数
     */</span>
    <span class="token keyword">int</span> <span class="token function">getCoreThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里比较重要的方法只有两个，即<code>UpdateAction</code>和<code>start</code>方法</p><p>在Ribbon中， ServerListUpdater的实现只有一个，即<code>PollingServerListUpdater</code>，这里就不在给出类图了，在们直接看它的实现。</p><h3 id="pollingserverlistupdater" tabindex="-1"><a class="header-anchor" href="#pollingserverlistupdater" aria-hidden="true">#</a> PollingServerListUpdater</h3><p>首先来看看构造函数及内部类的实现，对PollingServerListUpdater有一个简单的了解</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PollingServerListUpdater</span> <span class="token keyword">implements</span> <span class="token class-name">ServerListUpdater</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token constant">LISTOFSERVERS_CACHE_UPDATE_DELAY</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token comment">// msecs;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token constant">LISTOFSERVERS_CACHE_REPEAT_INTERVAL</span> <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token comment">// msecs;</span>
	<span class="token comment">// 该属性表示更新任务是否在运行中</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicBoolean</span> isActive <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicBoolean</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 记录最后一次更新服务的时间</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> lastUpdated <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 定时任务首次执行的延迟时间</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> initialDelayMs<span class="token punctuation">;</span>
    <span class="token comment">// 一次执行终止和下一次执行开始之间的延迟</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> refreshIntervalMs<span class="token punctuation">;</span>
    <span class="token comment">// 定时任务的返回值类型</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> scheduledFuture<span class="token punctuation">;</span>
    
    <span class="token comment">// 默认的延迟时间及间隔时间</span>
    <span class="token keyword">public</span> <span class="token class-name">PollingServerListUpdater</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token constant">LISTOFSERVERS_CACHE_UPDATE_DELAY</span><span class="token punctuation">,</span> <span class="token constant">LISTOFSERVERS_CACHE_REPEAT_INTERVAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 默认的延迟时间，配置的间隔时间</span>
    <span class="token keyword">public</span> <span class="token class-name">PollingServerListUpdater</span><span class="token punctuation">(</span><span class="token class-name">IClientConfig</span> clientConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token constant">LISTOFSERVERS_CACHE_UPDATE_DELAY</span><span class="token punctuation">,</span> <span class="token function">getRefreshIntervalMs</span><span class="token punctuation">(</span>clientConfig<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">PollingServerListUpdater</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> initialDelayMs<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> refreshIntervalMs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>initialDelayMs <span class="token operator">=</span> initialDelayMs<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>refreshIntervalMs <span class="token operator">=</span> refreshIntervalMs<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 这个内部类主要用来配置定时任务的线程池，及结束任务的方法</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">LazyHolder</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">CORE_THREAD</span> <span class="token operator">=</span> <span class="token string">&quot;DynamicServerListLoadBalancer.ThreadPoolSize&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">DynamicIntProperty</span> poolSizeProp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DynamicIntProperty</span><span class="token punctuation">(</span><span class="token constant">CORE_THREAD</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Thread</span> _shutdownThread<span class="token punctuation">;</span>

        <span class="token keyword">static</span> <span class="token class-name">ScheduledThreadPoolExecutor</span> _serverListRefreshExecutor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">static</span> <span class="token punctuation">{</span>
            <span class="token comment">// 核心线程数</span>
            <span class="token keyword">int</span> coreSize <span class="token operator">=</span> poolSizeProp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 自定义工厂</span>
            <span class="token class-name">ThreadFactory</span> factory <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span><span class="token string">&quot;PollingServerListUpdater-%d&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 初始化线程池</span>
            _serverListRefreshExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScheduledThreadPoolExecutor</span><span class="token punctuation">(</span>coreSize<span class="token punctuation">,</span> factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            poolSizeProp<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    _serverListRefreshExecutor<span class="token punctuation">.</span><span class="token function">setCorePoolSize</span><span class="token punctuation">(</span>poolSizeProp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 暂停线程</span>
            _shutdownThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Shutting down the Executor Pool for PollingServerListUpdater&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">shutdownExecutorPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addShutdownHook</span><span class="token punctuation">(</span>_shutdownThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">shutdownExecutorPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_serverListRefreshExecutor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                _serverListRefreshExecutor<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>_shutdownThread <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeShutdownHook</span><span class="token punctuation">(</span>_shutdownThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalStateException</span> ise<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// NOPMD</span>
                       
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>首先来看start方法的实现</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PollingServerListUpdater</span> <span class="token keyword">implements</span> <span class="token class-name">ServerListUpdater</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token constant">LISTOFSERVERS_CACHE_UPDATE_DELAY</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token comment">// msecs;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token constant">LISTOFSERVERS_CACHE_REPEAT_INTERVAL</span> <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token comment">// msecs;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicBoolean</span> isActive <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicBoolean</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> scheduledFuture<span class="token punctuation">;</span>
    
    
    <span class="token keyword">public</span> <span class="token class-name">PollingServerListUpdater</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token constant">LISTOFSERVERS_CACHE_UPDATE_DELAY</span><span class="token punctuation">,</span> <span class="token constant">LISTOFSERVERS_CACHE_REPEAT_INTERVAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">PollingServerListUpdater</span><span class="token punctuation">(</span><span class="token class-name">IClientConfig</span> clientConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token constant">LISTOFSERVERS_CACHE_UPDATE_DELAY</span><span class="token punctuation">,</span> <span class="token function">getRefreshIntervalMs</span><span class="token punctuation">(</span>clientConfig<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">PollingServerListUpdater</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> initialDelayMs<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> refreshIntervalMs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>initialDelayMs <span class="token operator">=</span> initialDelayMs<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>refreshIntervalMs <span class="token operator">=</span> refreshIntervalMs<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">UpdateAction</span> updateAction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isActive<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">Runnable</span> wrapperRunnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isActive<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduledFuture <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            scheduledFuture<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        updateAction<span class="token punctuation">.</span><span class="token function">doUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        lastUpdated <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Failed one update cycle&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            scheduledFuture <span class="token operator">=</span> <span class="token function">getRefreshExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleWithFixedDelay</span><span class="token punctuation">(</span>
                    wrapperRunnable<span class="token punctuation">,</span>
                    initialDelayMs<span class="token punctuation">,</span>
                    refreshIntervalMs<span class="token punctuation">,</span>
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Already active, no-op&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>    
    
    
    
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="spring-cloud-ribbon的负载均衡器" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ribbon的负载均衡器" aria-hidden="true">#</a> Spring Cloud Ribbon的负载均衡器</h2><p>负载均衡器的作用就是协调其他组件，完成负载均衡的调度管理功能。而如何协调组件，完成对server列表的获取、更新、维护、心跳检测、选择等功能，便成为了这个组件的主要工作，接下来就看看Ribbon是如何实现的。首先来看看Ribbon中负载均衡器的顶级接口定义<code>ILoadBalancer</code>，该接口提供了对服务器操作的一组方法，包括添加、选择、标记以及获取server列表。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ILoadBalancer</span> <span class="token punctuation">{</span>
	<span class="token doc-comment comment">/**
	 * 添加新的服务列表
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addServers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> newServers<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token doc-comment comment">/**
	 * 根据key通过负载均衡器选个一个服务，通常情况下是委托给IRule组件
	 */</span>
	<span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">chooseServer</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token doc-comment comment">/**
	 * 由客户端回调，用来标记某个服务下线
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">markServerDown</span><span class="token punctuation">(</span><span class="token class-name">Server</span> server<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token doc-comment comment">/**
	 * 获取可用的服务列表
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token function">getReachableServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 获取所有服务列表，包含可用和不可用
     */</span>
	<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAllServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其直接抽象实现为<code>AbstractLoadBalancer</code>，只是定义了两个新的方法，并没有什么具体的实现。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractLoadBalancer</span> <span class="token keyword">implements</span> <span class="token class-name">ILoadBalancer</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">ServerGroup</span><span class="token punctuation">{</span>
        <span class="token constant">ALL</span><span class="token punctuation">,</span>
        <span class="token constant">STATUS_UP</span><span class="token punctuation">,</span>
        <span class="token constant">STATUS_NOT_UP</span>        
    <span class="token punctuation">}</span>
        
    <span class="token doc-comment comment">/**
     * 定义一个空参数的chooseServer()
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">chooseServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token keyword">return</span> <span class="token function">chooseServer</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 根据服务分组获取服务列表
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token function">getServerList</span><span class="token punctuation">(</span><span class="token class-name">ServerGroup</span> serverGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token doc-comment comment">/**
     * 获取loadBalancer的统计信息
     * 子类可以根据server的健康状态来获取健康的server
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">LoadBalancerStats</span> <span class="token function">getLoadBalancerStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面来看看LoadBalancer的实现类图：</p><img src="/assets/image-20220613100308276-6eb86e19.png" alt="image-20220613100308276" style="zoom:60%;"><h3 id="nooploadbalancer" tabindex="-1"><a class="header-anchor" href="#nooploadbalancer" aria-hidden="true">#</a> NoOpLoadBalancer</h3><p>这个就是未做任何实现的实现，方法返回的不是null，就是空列表。没什么实际的使用场景，源码就不在这里粘了。</p><h3 id="baseloadbalancer" tabindex="-1"><a class="header-anchor" href="#baseloadbalancer" aria-hidden="true">#</a> BaseLoadBalancer</h3><p>这个负载均衡器是Ribbon中最基础的一个负载均衡器，提供了负载均衡的基本能力。其他的负载均衡器都是在此基础上进行扩展的。</p><p>首先来看看该负载均衡器中的一些基础属性：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 默认的负载均衡规则，轮询</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">IRule</span> <span class="token constant">DEFAULT_RULE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RoundRobinRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 默认的心跳检查策略， 串行ping</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">SerialPingStrategy</span> <span class="token constant">DEFAULT_PING_STRATEGY</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SerialPingStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEFAULT_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;default&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PREFIX</span> <span class="token operator">=</span> <span class="token string">&quot;LoadBalancer_&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// 负载均衡规则</span>
<span class="token keyword">protected</span> <span class="token class-name">IRule</span> rule <span class="token operator">=</span> <span class="token constant">DEFAULT_RULE</span><span class="token punctuation">;</span>
<span class="token comment">// 心跳检查策略</span>
<span class="token keyword">protected</span> <span class="token class-name">IPingStrategy</span> pingStrategy <span class="token operator">=</span> <span class="token constant">DEFAULT_PING_STRATEGY</span><span class="token punctuation">;</span>
<span class="token comment">// 心跳检查</span>
<span class="token keyword">protected</span> <span class="token class-name">IPing</span> ping <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token comment">// 所有 server 列表</span>
<span class="token keyword">protected</span> <span class="token keyword">volatile</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> allServerList <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">synchronizedList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 可用的 server 列表</span>
<span class="token keyword">protected</span> <span class="token keyword">volatile</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> upServerList <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">synchronizedList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">protected</span> <span class="token class-name">ReadWriteLock</span> allServerLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">protected</span> <span class="token class-name">ReadWriteLock</span> upServerLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 负载均衡器的名称，一般情况下为ClientName，若没指定为default</span>
<span class="token keyword">protected</span> <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token constant">DEFAULT_NAME</span><span class="token punctuation">;</span>
<span class="token comment">// 定时器，用于启动心跳任务</span>
<span class="token keyword">protected</span> <span class="token class-name">Timer</span> lbTimer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token comment">// ping 间隔时间，可以通过配置修改，&lt;clientName&gt;.&lt;nameSpace&gt;.NFLoadBalancerPingInterval</span>
<span class="token keyword">protected</span> <span class="token keyword">int</span> pingIntervalSeconds <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token comment">// 每次ping的最长时间，可通过配置修改，&lt;clientName&gt;.&lt;nameSpace&gt;.NFLoadBalancerMaxTotalPingTime</span>
<span class="token keyword">protected</span> <span class="token keyword">int</span> maxTotalPingTimeSeconds <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token comment">// 按照server的id排序</span>
<span class="token keyword">protected</span> <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> serverComparator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerComparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 表示Ping 是否正在进行</span>
<span class="token keyword">protected</span> <span class="token class-name">AtomicBoolean</span> pingInProgress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicBoolean</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 统计信息</span>
<span class="token keyword">protected</span> <span class="token class-name">LoadBalancerStats</span> lbStats<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">Counter</span> counter <span class="token operator">=</span> <span class="token class-name">Monitors</span><span class="token punctuation">.</span><span class="token function">newCounter</span><span class="token punctuation">(</span><span class="token string">&quot;LoadBalancer_ChooseServer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 初始链接检查， 用于检查初始检测Server的readyToServer 是否能够提供服务。</span>
<span class="token keyword">private</span> <span class="token class-name">PrimeConnections</span> primeConnections<span class="token punctuation">;</span>
<span class="token comment">// 初始检测的开关</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> enablePrimingConnections <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">IClientConfig</span> config<span class="token punctuation">;</span>
<span class="token comment">// 一个监听器列表，到allServerList里面的内容发生变化，会触发此监听器</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerListChangeListener</span><span class="token punctuation">&gt;</span></span> changeListeners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerListChangeListener</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 当server的isAlive状态发生变化时，触发词监听器。</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerStatusChangeListener</span><span class="token punctuation">&gt;</span></span> serverStatusListeners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerStatusChangeListener</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="dynamicserverlistloadbalancer" tabindex="-1"><a class="header-anchor" href="#dynamicserverlistloadbalancer" aria-hidden="true">#</a> DynamicServerListLoadBalancer</h3><h3 id="zoneawareloadbalancer" tabindex="-1"><a class="header-anchor" href="#zoneawareloadbalancer" aria-hidden="true">#</a> ZoneAwareLoadBalancer</h3><h2 id="spring-cloud-ribbon自动装配" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ribbon自动装配" aria-hidden="true">#</a> Spring Cloud Ribbon自动装配</h2><p>根据Spring Boot的自动装配原则，我们直接去查看spring-cloud-netflix-ribbon-2.2.9.RELEASE.jar包下的META_INF目录中的spring.factories文件：</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span><span class="token punctuation">=</span><span class="token value attr-value">\
org.springframework.cloud.netflix.ribbon.RibbonAutoConfiguration</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，Ribbon的自动装配类为<code>RibbonAutoConfiguration</code>，下面我们来看一下<code>RibbonAutoConfiguration</code>的定义：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Conditional</span><span class="token punctuation">(</span><span class="token class-name">RibbonAutoConfiguration<span class="token punctuation">.</span>RibbonClassesConditions</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RibbonClients</span>
<span class="token annotation punctuation">@AutoConfigureAfter</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;org.springframework.cloud.netflix.eureka.EurekaClientAutoConfiguration&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@AutoConfigureBefore</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">LoadBalancerAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">AsyncLoadBalancerAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">RibbonEagerLoadProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">ServerIntrospectorProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;spring.cloud.loadbalancer.ribbon.enabled&quot;</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">,</span> matchIfMissing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RibbonAutoConfiguration</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ribbonautoconfiguration上的注解" tabindex="-1"><a class="header-anchor" href="#ribbonautoconfiguration上的注解" aria-hidden="true">#</a> RibbonAutoConfiguration上的注解</h3><p>下面来挨个分析这个自动装配类上标记的注解：</p><h4 id="configuration" tabindex="-1"><a class="header-anchor" href="#configuration" aria-hidden="true">#</a> @Configuration：</h4><p>标明这个一个配置类</p><h4 id="conditional" tabindex="-1"><a class="header-anchor" href="#conditional" aria-hidden="true">#</a> @Conditional</h4><p>自动装配的条件，条件类为<code>RibbonAutoConfiguration.RibbonClassesConditions.class</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">RibbonClassesConditions</span> <span class="token keyword">extends</span> <span class="token class-name">AllNestedConditions</span> <span class="token punctuation">{</span>
    <span class="token class-name">RibbonClassesConditions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 该参数表示解析该注解的时机是在向容器中注入bean的时候记性解析。</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationPhase</span><span class="token punctuation">.</span><span class="token constant">PARSE_CONFIGURATION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">IClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">IClientPresent</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">RestTemplate</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">RestTemplatePresent</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;deprecation&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">AsyncRestTemplate</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">AsyncRestTemplatePresent</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">Ribbon</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">RibbonPresent</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>该条件装配类继承自<code>AllNestedConditions</code>，表示该类定义的所有内部类的条件注解都必须满足。即当前环境必须存在这几个类：IClient、RestTemplate、AsyncRestTemplate、Ribbon。</p><h4 id="ribbonclients" tabindex="-1"><a class="header-anchor" href="#ribbonclients" aria-hidden="true">#</a> @RibbonClients</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token class-name">RibbonClientConfigurationRegistrar</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">RibbonClients</span> <span class="token punctuation">{</span>
	<span class="token class-name">RibbonClient</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">defaultConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>该注解引入了<code>RibbonClientConfigurationRegistrar.class</code>类，该类负责对<code>@RibbonClients</code>及<code>@RibbonClient</code>两种注解的解析。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RibbonClientConfigurationRegistrar</span> <span class="token keyword">implements</span> <span class="token class-name">ImportBeanDefinitionRegistrar</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span> metadata<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 解析@RibbonClients</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> attrs <span class="token operator">=</span> metadata<span class="token punctuation">.</span><span class="token function">getAnnotationAttributes</span><span class="token punctuation">(</span><span class="token class-name">RibbonClients</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>attrs <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> attrs<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">AnnotationAttributes</span><span class="token punctuation">[</span><span class="token punctuation">]</span> clients <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AnnotationAttributes</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> attrs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AnnotationAttributes</span> client <span class="token operator">:</span> clients<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">registerClientConfiguration</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> <span class="token function">getClientName</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;configuration&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>attrs <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> attrs<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">&quot;defaultConfiguration&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">String</span> name<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">.</span><span class="token function">hasEnclosingClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				name <span class="token operator">=</span> <span class="token string">&quot;default.&quot;</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">getEnclosingClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				name <span class="token operator">=</span> <span class="token string">&quot;default.&quot;</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">registerClientConfiguration</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> name<span class="token punctuation">,</span> attrs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;defaultConfiguration&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
        <span class="token comment">// 解析@RibbonClients</span>
		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> client <span class="token operator">=</span> metadata<span class="token punctuation">.</span><span class="token function">getAnnotationAttributes</span><span class="token punctuation">(</span><span class="token class-name">RibbonClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token function">getClientName</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 注册客户端配置</span>
			<span class="token function">registerClientConfiguration</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> name<span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;configuration&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getClientName</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> client<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>client <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token class-name">String</span> value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> value<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Either &#39;name&#39; or &#39;value&#39; must be provided in @RibbonClient&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">registerClientConfiguration</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">,</span> <span class="token class-name">Object</span> name<span class="token punctuation">,</span>
			<span class="token class-name">Object</span> configuration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">BeanDefinitionBuilder</span> builder <span class="token operator">=</span> <span class="token class-name">BeanDefinitionBuilder</span><span class="token punctuation">.</span><span class="token function">genericBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">RibbonClientSpecification</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		builder<span class="token punctuation">.</span><span class="token function">addConstructorArgValue</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
		builder<span class="token punctuation">.</span><span class="token function">addConstructorArgValue</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
		registry<span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">&quot;.RibbonClientSpecification&quot;</span><span class="token punctuation">,</span> builder<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从上面的代码可以看到，最后注册的bean的类型都是<code>RibbonClientSpecification</code>类型。</p><h4 id="autoconfigureafter" tabindex="-1"><a class="header-anchor" href="#autoconfigureafter" aria-hidden="true">#</a> @AutoConfigureAfter</h4><p>这个注解是用来控制自动装配类的加载顺序的，先加载该注解中引入的自动配置类，在加载当前的自动配置类。该注解中引入的自动装配类<code>EurekaClientAutoConfiguration</code>是用来自动装配Eureka的，目前没有用到。</p><h4 id="autoconfigurebefore" tabindex="-1"><a class="header-anchor" href="#autoconfigurebefore" aria-hidden="true">#</a> @AutoConfigureBefore</h4><p>控制自动装配类的加载顺序，在加载完当前自动装配类后在记载该注解中的自动装配类。该注解中引入的连个配置类LoadBalancerAutoConfiguration.class, AsyncLoadBalancerAutoConfiguration.class 后面在介绍。</p><h4 id="enableconfigurationproperties" tabindex="-1"><a class="header-anchor" href="#enableconfigurationproperties" aria-hidden="true">#</a> @EnableConfigurationProperties</h4><p>这个是用来启用配置项的。</p><h4 id="conditionalonproperty" tabindex="-1"><a class="header-anchor" href="#conditionalonproperty" aria-hidden="true">#</a> @ConditionalOnProperty</h4><p>启用条件，默认是启用的。</p><h3 id="ribbonautoconfiguration" tabindex="-1"><a class="header-anchor" href="#ribbonautoconfiguration" aria-hidden="true">#</a> RibbonAutoConfiguration</h3><p>上面讲解了一些自动动装配类<code>RibbonAutoConfiguration</code>上的条件注解，下面来看看这个自动装配类注入了那些bean。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RibbonClientSpecification</span><span class="token punctuation">&gt;</span></span> configurations <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">RibbonEagerLoadProperties</span> ribbonEagerLoadProperties<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这两个自动注入的属性是通过上面的注解加载的，configurations是在解析@RibbonClients注解时注入的bean，而ribbonEagerLoadProperties是激活的配置类。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span>
<span class="token keyword">public</span> <span class="token class-name">SpringClientFactory</span> <span class="token function">springClientFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SpringClientFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpringClientFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    factory<span class="token punctuation">.</span><span class="token function">setConfigurations</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>configurations<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> factory<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>TODO</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token class-name">LoadBalancerClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">LoadBalancerClient</span> <span class="token function">loadBalancerClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RibbonLoadBalancerClient</span><span class="token punctuation">(</span><span class="token function">springClientFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里加载LoadBalancerClient的实例，默认实现为<code>RibbonLoadBalancerClient</code></p><p>注入RestTemplate的定制器，</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">HttpRequest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnRibbonRestClient</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">RibbonClientHttpRequestFactoryConfiguration</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SpringClientFactory</span> springClientFactory<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplateCustomizer</span> <span class="token function">restTemplateCustomizer</span><span class="token punctuation">(</span>
        <span class="token keyword">final</span> <span class="token class-name">RibbonClientHttpRequestFactory</span> ribbonClientHttpRequestFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> restTemplate <span class="token operator">-&gt;</span> restTemplate
            <span class="token punctuation">.</span><span class="token function">setRequestFactory</span><span class="token punctuation">(</span>ribbonClientHttpRequestFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RibbonClientHttpRequestFactory</span> <span class="token function">ribbonClientHttpRequestFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RibbonClientHttpRequestFactory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>springClientFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注入PropertiesFactory</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span>
<span class="token keyword">public</span> <span class="token class-name">PropertiesFactory</span> <span class="token function">propertiesFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PropertiesFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="loadbalancerautoconfiguration" tabindex="-1"><a class="header-anchor" href="#loadbalancerautoconfiguration" aria-hidden="true">#</a> LoadBalancerAutoConfiguration</h3><h2 id="spring-cloud-ribbon中重要的组件" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ribbon中重要的组件" aria-hidden="true">#</a> Spring Cloud Ribbon中重要的组件</h2><h3 id="iclientconfig" tabindex="-1"><a class="header-anchor" href="#iclientconfig" aria-hidden="true">#</a> IClientConfig</h3><p>客户端配置</p><h3 id="loadbalancerstatus" tabindex="-1"><a class="header-anchor" href="#loadbalancerstatus" aria-hidden="true">#</a> LoadBalancerStatus</h3><p>服务相关数据统计</p><h2 id="spring-cloud-ribbon中的监控组件" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ribbon中的监控组件" aria-hidden="true">#</a> Spring Cloud Ribbon中的监控组件</h2><p>在Ribbon中，一些负载均衡策略在做负载时，需要根据一些统计信息来做判断，例如平均响应时间，累计失败次数，熔断控制等。基于此，ribbon重实现了一个简版的监控系统，包含如下一些组件，如ribbon-statisticds包，ServerStats以及LoadBalancerStats。接下来逐个击破。</p><h3 id="基础工具包" tabindex="-1"><a class="header-anchor" href="#基础工具包" aria-hidden="true">#</a> 基础工具包</h3><p>在netflix-statistics包中，ribbon为我们提供了一些基础工具类，该工具包的设计目的时为了简化指标数据收集、逻辑计算等。在该工具包中仅有十个类定义，我们先来看一下整体的类图：</p><p><img src="/assets/image-20220707151731227-52b6282c.png" alt="image-20220707151731227"></p><p>这里边基础功能接口基本都是在DataCollector这个分支，在DistributionMBean这个分支定义的都是获取数据的接口。</p><h4 id="datacollector" tabindex="-1"><a class="header-anchor" href="#datacollector" aria-hidden="true">#</a> DataCollector</h4><p>数据收集，以增量的方式收集数据。该接口非常简单，仅一个增量收集数据的方法。他是数据的唯一来源，其他一切为围绕该接口进行展开。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">DataCollector</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 向收集的数据中添加一个值
     */</span>
    <span class="token keyword">void</span> <span class="token function">noteValue</span><span class="token punctuation">(</span><span class="token keyword">double</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="distributionmbean" tabindex="-1"><a class="header-anchor" href="#distributionmbean" aria-hidden="true">#</a> DistributionMBean</h4><p>该接口定义了一些获取数据的方式</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">DistributionMBean</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**  清楚数据 */</span>
    <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** 获取次数 */</span>
    <span class="token keyword">long</span> <span class="token function">getNumValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** 获取平均值 */</span>
    <span class="token keyword">double</span> <span class="token function">getMean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** 获取方差 */</span>
    <span class="token keyword">double</span> <span class="token function">getVariance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** 获取标准差 */</span>
    <span class="token keyword">double</span> <span class="token function">getStdDev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** 获取最小值 */</span>
    <span class="token keyword">double</span> <span class="token function">getMinimum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** 获取最大值 */</span>
    <span class="token keyword">double</span> <span class="token function">getMaximum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="distribution" tabindex="-1"><a class="header-anchor" href="#distribution" aria-hidden="true">#</a> Distribution</h4><p>分布式系统的累加器，提供了对多维度的数据统计。以增量的方式产生观测值。该组件除了实现了DataCollector以外，还实现了DistributionMBean接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Distribution</span> <span class="token keyword">implements</span> <span class="token class-name">DistributionMBean</span><span class="token punctuation">,</span> <span class="token class-name">DataCollector</span> <span class="token punctuation">{</span>
	<span class="token comment">// 累加值的次数</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> numValues<span class="token punctuation">;</span>
    <span class="token comment">// 所有值得总和</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> sumValues<span class="token punctuation">;</span>
    <span class="token comment">// 值 平方的总和</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> sumSquareValues<span class="token punctuation">;</span>
    <span class="token comment">// 最大值</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> minValue<span class="token punctuation">;</span>
    <span class="token comment">// 最小值</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> maxValue<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** 构造函数，创建一个空实例 */</span>
    <span class="token keyword">public</span> <span class="token class-name">Distribution</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        numValues <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
        sumValues <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
        sumSquareValues <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
        minValue <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
        maxValue <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** 累加新值 */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">noteValue</span><span class="token punctuation">(</span><span class="token keyword">double</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        numValues<span class="token operator">++</span><span class="token punctuation">;</span>
        sumValues <span class="token operator">+=</span> val<span class="token punctuation">;</span>
        sumSquareValues <span class="token operator">+=</span> val <span class="token operator">*</span> val<span class="token punctuation">;</span>
        <span class="token comment">// 计算最大值、最小值</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>numValues <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            minValue <span class="token operator">=</span> val<span class="token punctuation">;</span>
            maxValue <span class="token operator">=</span> val<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">&lt;</span> minValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            minValue <span class="token operator">=</span> val<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">&gt;</span> maxValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            maxValue <span class="token operator">=</span> val<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 清楚数据</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** 次数 */</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getNumValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> numValues<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** 获取平均值 */</span>
    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">getMean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>numValues <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> sumValues <span class="token operator">/</span> numValues<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** 计算方差 */</span>
    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">getVariance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>numValues <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sumValues <span class="token operator">==</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">double</span> mean <span class="token operator">=</span> <span class="token function">getMean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>sumSquareValues <span class="token operator">/</span> numValues<span class="token punctuation">)</span> <span class="token operator">-</span> mean <span class="token operator">*</span> mean<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** 标准差 */</span>
    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">getStdDev</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token function">getVariance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** 最小值 */</span>
    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">getMinimum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> minValue<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** 最大值 */</span>
    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">getMaximum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> maxValue<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** 将两个Distribution相加  */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Distribution</span> anotherDistribution<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>anotherDistribution <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            numValues <span class="token operator">+=</span> anotherDistribution<span class="token punctuation">.</span>numValues<span class="token punctuation">;</span>
            sumValues <span class="token operator">+=</span> anotherDistribution<span class="token punctuation">.</span>sumValues<span class="token punctuation">;</span>
            sumSquareValues <span class="token operator">+=</span> anotherDistribution<span class="token punctuation">.</span>sumSquareValues<span class="token punctuation">;</span>
            minValue <span class="token operator">=</span> <span class="token punctuation">(</span>minValue <span class="token operator">&lt;</span> anotherDistribution<span class="token punctuation">.</span>minValue<span class="token punctuation">)</span> <span class="token operator">?</span> minValue
                    <span class="token operator">:</span> anotherDistribution<span class="token punctuation">.</span>minValue<span class="token punctuation">;</span>
            maxValue <span class="token operator">=</span> <span class="token punctuation">(</span>maxValue <span class="token operator">&gt;</span> anotherDistribution<span class="token punctuation">.</span>maxValue<span class="token punctuation">)</span> <span class="token operator">?</span> maxValue
                    <span class="token operator">:</span> anotherDistribution<span class="token punctuation">.</span>maxValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里需要注意到一点，该类是线程不安全的。</p><h4 id="databuffer" tabindex="-1"><a class="header-anchor" href="#databuffer" aria-hidden="true">#</a> DataBuffer</h4><p>该类是Distribution的子类 ，在父类的基础上增加了一个缓冲区，并配合startCollection和endCollection动作，完成对一个周期数据的收集。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataBuffer</span> <span class="token keyword">extends</span> <span class="token class-name">Distribution</span> <span class="token punctuation">{</span>
	<span class="token comment">// 锁</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Lock</span> lock<span class="token punctuation">;</span>
    <span class="token comment">// 缓冲区</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf<span class="token punctuation">;</span>
    <span class="token comment">// 周期开始时间戳</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> startMillis<span class="token punctuation">;</span>
    <span class="token comment">// 周期结束时间戳</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> endMillis<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> size<span class="token punctuation">;</span>
    <span class="token comment">// buf中当前写入的位置</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> insertPos<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** 构造函数，初始化 */</span>
    <span class="token keyword">public</span> <span class="token class-name">DataBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">double</span><span class="token punctuation">[</span>capacity<span class="token punctuation">]</span><span class="token punctuation">;</span>
        startMillis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        insertPos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

   <span class="token comment">// 获取锁</span>
    <span class="token keyword">public</span> <span class="token class-name">Lock</span> <span class="token function">getLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> lock<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** 获取缓冲区长度 */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> buf<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** 获取周期长度 */</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getSampleIntervalMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">(</span>endMillis <span class="token operator">-</span> startMillis<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** 获取size */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getSampleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> size<span class="token punctuation">;</span> <span class="token punctuation">}</span>
   
    <span class="token doc-comment comment">/** 清空数据 */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** 开始周期 */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        startMillis <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** 结束周期 */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">endCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        endMillis <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** 累加值 */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">noteValue</span><span class="token punctuation">(</span><span class="token keyword">double</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">noteValue</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        buf<span class="token punctuation">[</span>insertPos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
        <span class="token comment">// 这里当index大于缓冲区长度时，会重新set到0的位置</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>insertPos <span class="token operator">&gt;=</span> buf<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            insertPos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            size <span class="token operator">=</span> buf<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>insertPos <span class="token operator">&gt;</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            size <span class="token operator">=</span> insertPos<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** 计算分位数 */</span>
    <span class="token keyword">public</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getPercentiles</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> percents<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> percentiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> percents<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 计算百分比统计信息。比如若percents[i] = 50的话</span>
			<span class="token comment">// 就是计算buf缓冲区里中位数的值</span>
			<span class="token comment">// 90的话：计算90分位数的值（也就是该值比90%的数值都大）</span>
			<span class="token comment">// computePercentile是私有方法：根据当前窗口内收集到的数据进行计算分位数</span>
            percentiles<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">computePercentile</span><span class="token punctuation">(</span>percents<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> percentiles<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">double</span> <span class="token function">computePercentile</span><span class="token punctuation">(</span><span class="token keyword">double</span> percent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Some just-in-case edge cases</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>percent <span class="token operator">&lt;=</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>percent <span class="token operator">&gt;=</span> <span class="token number">100.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// SUPPRESS CHECKSTYLE MagicNumber</span>
            <span class="token keyword">return</span> buf<span class="token punctuation">[</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">double</span> index <span class="token operator">=</span> <span class="token punctuation">(</span>percent <span class="token operator">/</span> <span class="token number">100.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> size<span class="token punctuation">;</span> <span class="token comment">// SUPPRESS CHECKSTYLE MagicNumber</span>
        <span class="token keyword">int</span> iLow <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> iHigh <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> <span class="token number">0</span> <span class="token operator">&lt;=</span> iLow <span class="token operator">&amp;&amp;</span> iLow <span class="token operator">&lt;=</span> index <span class="token operator">&amp;&amp;</span> index <span class="token operator">&lt;=</span> iHigh <span class="token operator">&amp;&amp;</span> iHigh <span class="token operator">&lt;=</span> size<span class="token punctuation">;</span>
        <span class="token keyword">assert</span> <span class="token punctuation">(</span>iHigh <span class="token operator">-</span> iLow<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>iHigh <span class="token operator">&gt;=</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> buf<span class="token punctuation">[</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token comment">// Another edge case</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>iLow <span class="token operator">==</span> iHigh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> buf<span class="token punctuation">[</span>iLow<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Interpolate between the two bounding values</span>
            <span class="token keyword">return</span> buf<span class="token punctuation">[</span>iLow<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span>index <span class="token operator">-</span> iLow<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>buf<span class="token punctuation">[</span>iHigh<span class="token punctuation">]</span> <span class="token operator">-</span> buf<span class="token punctuation">[</span>iLow<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="histogram" tabindex="-1"><a class="header-anchor" href="#histogram" aria-hidden="true">#</a> Histogram</h4><p>histogram 是直方图的意思。他的作用就是把数据分桶，并提供一些统计方法。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="dataaccumulator" tabindex="-1"><a class="header-anchor" href="#dataaccumulator" aria-hidden="true">#</a> DataAccumulator</h4><p>数据累加器。该类是一个抽象类，内部使用了两个缓冲区。</p><ul><li>current：用于添加新数据</li><li>previous：用于存储上一个周期内换存储收集到的数据</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">DataAccumulator</span> <span class="token keyword">implements</span> <span class="token class-name">DataCollector</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">DataBuffer</span> current<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">DataBuffer</span> previous<span class="token punctuation">;</span>
    <span class="token comment">// swap锁，收集数据和交换数据是异步的。</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> swapLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token doc-comment comment">/** 构造方法
     *  这是唯一的构造方法，必须制定缓冲区的大小。
     *  他决定了缓冲区的数据承载量，比如设置了10， 那么即使有再多的数据过来，也只缓存最近的10条。 */</span>
    <span class="token keyword">public</span> <span class="token class-name">DataAccumulator</span><span class="token punctuation">(</span><span class="token keyword">int</span> bufferSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataBuffer</span><span class="token punctuation">(</span>bufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>previous <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataBuffer</span><span class="token punctuation">(</span>bufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** 收集数据的方法 */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">noteValue</span><span class="token punctuation">(</span><span class="token keyword">double</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>swapLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Lock</span> l <span class="token operator">=</span> current<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            l<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                current<span class="token punctuation">.</span><span class="token function">noteValue</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                l<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>剩下的就是数据交换了，这个功能也是该扩展的一个核心功能。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">publish</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DataBuffer</span> tmp <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">Lock</span> l <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>swapLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 交换缓冲区</span>
        tmp <span class="token operator">=</span> current<span class="token punctuation">;</span>
        current <span class="token operator">=</span> previous<span class="token punctuation">;</span>
        previous <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
        <span class="token comment">// 开区新的收集周期</span>
        l <span class="token operator">=</span> current<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        l<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            current<span class="token punctuation">.</span><span class="token function">startCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            l<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 获取老缓冲区的锁</span>
        l <span class="token operator">=</span> tmp<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        l<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 在处理老数据之前释放锁</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        tmp<span class="token punctuation">.</span><span class="token function">endCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 这个是抽象方法，由子类实现。</span>
        <span class="token function">publish</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        l<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>该方法的主要作用就是对新老缓冲区做一个交换，当然，交换之前需要加锁。交换完成之后，把老的缓冲区中的数据拿去做计算。计算的方法是一个抽象方法，在子类中实现。</p><h4 id="datadistribution" tabindex="-1"><a class="header-anchor" href="#datadistribution" aria-hidden="true">#</a> DataDistribution</h4><p>该类就是DataAccumulator的实现类了，实现了具体的计算逻辑。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataDistribution</span> <span class="token keyword">extends</span> <span class="token class-name">DataAccumulator</span> <span class="token keyword">implements</span> <span class="token class-name">DataDistributionMBean</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">long</span> numValues <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> mean <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> variance <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> stddev <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> min <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> max <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> ts <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> interval <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> percents<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> percentiles<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** 构造函数 */</span>
    <span class="token keyword">public</span> <span class="token class-name">DataDistribution</span><span class="token punctuation">(</span><span class="token keyword">int</span> bufferSize<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> percents<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>bufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 简单的校验</span>
        <span class="token keyword">assert</span> <span class="token function">percentsOK</span><span class="token punctuation">(</span>percents<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>percents <span class="token operator">=</span> percents<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>percentiles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">double</span><span class="token punctuation">[</span>percents<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        
    <span class="token doc-comment comment">/** 计算逻辑 */</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">publish</span><span class="token punctuation">(</span><span class="token class-name">DataBuffer</span> buf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ts <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        numValues <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">getNumValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mean <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">getMean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        variance <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">getVariance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stddev <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">getStdDev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        min <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">getMinimum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        max <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">getMaximum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        interval <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">getSampleIntervalMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        size <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">getSampleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        buf<span class="token punctuation">.</span><span class="token function">getPercentiles</span><span class="token punctuation">(</span>percents<span class="token punctuation">,</span> percentiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** 清理数据 */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>publish</code>一次产生<strong>一批新值</strong>，这个时候你若把它持久化下来以后就能参考喽。然后进入到<strong>下一轮</strong>的数据收集，所以说publish的调用节奏决定了它的数据收集的时间窗口。</p><h4 id="datapublisher" tabindex="-1"><a class="header-anchor" href="#datapublisher" aria-hidden="true">#</a> DataPublisher</h4><p>这是一个现成的类，他会启动一个定时任务，周期性的调用publish方法。</p><p>首先来看看属性和构造方法：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataPublisher</span> <span class="token punctuation">{</span>
	<span class="token comment">// 常量，制定线程名</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">THREAD_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;DataPublisher&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// Demo线程</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token constant">DAEMON_THREADS</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">// 执行任务的线程池</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ScheduledExecutorService</span> sharedExecutor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token comment">// 数据累加器</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DataAccumulator</span> accumulator<span class="token punctuation">;</span>
    <span class="token comment">// 执行任务的时间间隔</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> delayMillis<span class="token punctuation">;</span>
    <span class="token comment">// 任务的返回结果</span>
    <span class="token keyword">private</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** 构造方法 ，需要指定累加器和线程的执行周期 */</span>
    <span class="token keyword">public</span> <span class="token class-name">DataPublisher</span><span class="token punctuation">(</span><span class="token class-name">DataAccumulator</span> accumulator<span class="token punctuation">,</span> <span class="token keyword">long</span> delayMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator <span class="token operator">=</span> accumulator<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>delayMillis <span class="token operator">=</span> delayMillis<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面是开启定时任务：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 启动定时任务</span>
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>future <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Runnable</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    accumulator<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">handleException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        future <span class="token operator">=</span> <span class="token function">getExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleWithFixedDelay</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> delayMillis<span class="token punctuation">,</span> delayMillis<span class="token punctuation">,</span>  
                                                      <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/** 创建一个线程池 */</span>
<span class="token keyword">protected</span> <span class="token keyword">synchronized</span> <span class="token class-name">ScheduledExecutorService</span> <span class="token function">getExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sharedExecutor <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sharedExecutor <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">PublishThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> sharedExecutor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 线程工厂</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">PublishThreadFactory</span> <span class="token keyword">implements</span> <span class="token class-name">ThreadFactory</span> <span class="token punctuation">{</span>
    <span class="token class-name">PublishThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">Thread</span> <span class="token function">newThread</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token constant">THREAD_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token constant">DAEMON_THREADS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> t<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="一个简单的使用案例" tabindex="-1"><a class="header-anchor" href="#一个简单的使用案例" aria-hidden="true">#</a> 一个简单的使用案例</h4><p>略</p><h3 id="serverstats" tabindex="-1"><a class="header-anchor" href="#serverstats" aria-hidden="true">#</a> ServerStats</h3><p><strong>服务状态</strong>。在LoadBalancer中捕获每个服务器(节点)的各种状态，每个Server就对应着一个<code>ServerStats</code>实例。ServerStats表示一台Server的状态，各种纬度的统计数据才能使得你最终挑选出一个<strong>最适合</strong>的Server供以使用，以及计算其当前访问压力（并发数）、成功数、失败数、是否熔断、熔断了多久等等。</p><h4 id="统计数据-属性" tabindex="-1"><a class="header-anchor" href="#统计数据-属性" aria-hidden="true">#</a> 统计数据/属性</h4><p>到底统计了哪些数据呢？对Server进行<strong>多维度</strong>的数据统计，均体现在它的成员属性上：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServerStats</span> <span class="token punctuation">{</span>
    <span class="token comment">// 默认60s（1分钟）publish一次数据</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_PUBLISH_INTERVAL</span> <span class="token operator">=</span>  <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span> 
    <span class="token comment">// 缓冲区大小。这个默认大小可谓非常大呀，就算你QPS是1000，也能抗1分钟</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_BUFFER_SIZE</span> <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span> 
    <span class="token comment">// 接连失败的阈值，默认值3，超过就熔断</span>
    <span class="token comment">// 默认配置 niws.loadbalancer.default.connectionFailureCountThreshold，默认值3</span>
    <span class="token comment">// 自定义配置：niws.loadbalancer.&lt;c&gt;.connectionFailureCountThreshold</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CachedDynamicIntProperty</span> connectionFailureThreshold<span class="token punctuation">;</span>
    <span class="token comment">// 断路器超时因子，默认10秒</span>
    <span class="token comment">// 默认配置 niws.loadbalancer.default.circuitTripTimeoutFactorSeconds</span>
    <span class="token comment">// 自定义配置： niws.loadbalancer.&lt;clientName&gt;.circuitTripTimeoutFactorSeconds</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CachedDynamicIntProperty</span> circuitTrippedTimeoutFactor<span class="token punctuation">;</span>
    <span class="token comment">// 断路器最大超时秒数， 默认30s</span>
    <span class="token comment">// 默认配置：niws.loadbalancer.default.circuitTripMaxTimeoutSeconds</span>
    <span class="token comment">// 自定义配置：niws.loadbalancer.&lt;clientName&gt;.circuitTripMaxTimeoutSeconds </span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CachedDynamicIntProperty</span> maxCircuitTrippedTimeout<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">DynamicIntProperty</span> activeRequestsCountTimeout <span class="token operator">=</span> 
        <span class="token class-name">DynamicPropertyFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">getIntProperty</span><span class="token punctuation">(</span><span class="token string">&quot;niws.loadbalancer.serverStats.activeRequestsCount.effectiveWindowSeconds&quot;</span><span class="token punctuation">,</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">PERCENTS</span> <span class="token operator">=</span> <span class="token function">makePercentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token class-name">DataDistribution</span> dataDist <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataDistribution</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">PERCENTS</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// in case</span>
    <span class="token keyword">private</span> <span class="token class-name">DataPublisher</span> publisher <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Distribution</span> responseTimeDist <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Distribution</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">int</span> bufferSize <span class="token operator">=</span> <span class="token constant">DEFAULT_BUFFER_SIZE</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> publishInterval <span class="token operator">=</span> <span class="token constant">DEFAULT_PUBLISH_INTERVAL</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 失败次数统计时间窗。默认值1000ms</span>
    <span class="token keyword">long</span> failureCountSlidingWindowInterval <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span> 
    <span class="token comment">// 上一秒失败次数（上一秒是因为failureCountSlidingWindowInterval默认自是1000ms)</span>
    <span class="token keyword">private</span> <span class="token class-name">MeasuredRate</span> serverFailureCounts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MeasuredRate</span><span class="token punctuation">(</span>failureCountSlidingWindowInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 一个窗口期内的请求总数，窗口期默认为5分钟（300秒） </span>
    <span class="token keyword">private</span> <span class="token class-name">MeasuredRate</span> requestCountInWindow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MeasuredRate</span><span class="token punctuation">(</span><span class="token number">300000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">Server</span> server<span class="token punctuation">;</span>
    <span class="token comment">// 总的请求数量，每次请求结束/错误时就会+1。</span>
    <span class="token class-name">AtomicLong</span> totalRequests <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 连续（successive）请求异常数量（这个连续发生在Retry重试期间）。</span>
    <span class="token comment">// 在重试期间，但凡有一次成功了，就会把此参数置为0（失败的话此参数就一直加）</span>
	<span class="token comment">// 说明：只有在异常类型是callErrorHandler.isCircuitTrippingException(e)的时候，才会算作失败，才会+1 </span>
	<span class="token comment">// 默认情况下只有SocketException/SocketTimeoutException这两种异常才算失败哦~</span>
    <span class="token annotation punctuation">@VisibleForTesting</span>
    <span class="token class-name">AtomicInteger</span> successiveConnectionFailureCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 活跃请求数量（正在请求的数量，它能反应该Server的负载、压力）。 </span>
	<span class="token comment">// 但凡只要开始执行Sever了，就+1</span>
	<span class="token comment">// 但凡只要请求完成了/出错了，就-1</span>
	<span class="token comment">// 注意：它有时间窗口的概念，后面讲具体逻辑</span>
    <span class="token annotation punctuation">@VisibleForTesting</span>
    <span class="token class-name">AtomicInteger</span> activeRequestsCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@VisibleForTesting</span>
    <span class="token class-name">AtomicInteger</span> openConnectionsCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 最后一次失败的时间戳。至于什么叫失败，参考successiveConnectionFailureCount对失败的判断逻辑</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> lastConnectionFailedTimestamp<span class="token punctuation">;</span>
	<span class="token comment">// 简单的说就是activeRequestsCount的值最后变化的时间戳</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> lastActiveRequestsCountChangeTimestamp<span class="token punctuation">;</span>
    <span class="token comment">// 断路器断电总时长（连续失败&gt;=3次，增加20~30秒。具体增加多少秒，后面有计算逻辑）。</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicLong</span> totalCircuitBreakerBlackOutPeriod <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 最后访问时间戳。和lastActiveRequestsCountChangeTimestamp的区别是，它增/减都update一下，而lastAccessedTimestamp只有在增的时候才会update一下。</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> lastAccessedTimestamp<span class="token punctuation">;</span>
    <span class="token comment">// 首次连接时间戳，只会记录首次请求进来时的时间。</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> firstConnectionTimestamp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="loadbalancerstats" tabindex="-1"><a class="header-anchor" href="#loadbalancerstats" aria-hidden="true">#</a> LoadBalancerStats</h3><h2 id="spring-cloud-ribbon-配置总结" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ribbon-配置总结" aria-hidden="true">#</a> Spring Cloud Ribbon 配置总结</h2><p>https://www.jianshu.com/p/f3db11f045cc</p></div><!----><footer class="page-meta"><!----><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: 895252461@qq.com">诗人都藏在水底</span>,<!--]--><!--[--><span class="contributor" title="email: 895252461@qq.com">xuliang</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a aria-label="Spring Cloud OpenFeign 源码解析" class="vp-link nav-link prev nav-link prev" href="/spring-cloud/spring-cloud-openfeign/spring-cloud-openfeign.html"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><!---->Spring Cloud OpenFeign 源码解析</div></a><!----></nav><!----><!----><!--]--></main><!--]--><!----></div><!--]--><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-9aa256ea.js" defer></script>
  </body>
</html>
