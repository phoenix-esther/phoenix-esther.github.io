<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.57" />
    <meta name="theme" content="VuePress Theme Hope" />
    <title>Spring Cloud Ribbon æºç è§£æ | Java æˆç¥ä¹‹è·¯</title><meta name="description" content="è¿™æ˜¯æˆ‘çš„ç¬¬ä¸€ä¸ª VuePress ç«™ç‚¹">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-72ee67ce.css" as="style" /><link rel="stylesheet" href="/assets/style-72ee67ce.css" />
    <link rel="modulepreload" href="/assets/app-c593f505.js"><link rel="modulepreload" href="/assets/framework-4ec38622.js"><link rel="modulepreload" href="/assets/spring-cloud-ribbon.html-8669a44d.js"><link rel="modulepreload" href="/assets/spring-cloud-ribbon.html-a27e5c44.js"><link rel="prefetch" href="/assets/index.html-4e1da2c4.js" as="script" /><link rel="prefetch" href="/assets/spring-cloud-alibaba-seate.html-df701e40.js" as="script" /><link rel="prefetch" href="/assets/spring-cloud-overview.html-94372eca.js" as="script" /><link rel="prefetch" href="/assets/gitbook.html-432908fc.js" as="script" /><link rel="prefetch" href="/assets/mysql-advance.html-b6faea43.js" as="script" /><link rel="prefetch" href="/assets/mysql-apply.html-e0982e6c.js" as="script" /><link rel="prefetch" href="/assets/mysql-base.html-15774da0.js" as="script" /><link rel="prefetch" href="/assets/mysql-devops.html-5cee1349.js" as="script" /><link rel="prefetch" href="/assets/redis-base.html-e17677ed.js" as="script" /><link rel="prefetch" href="/assets/redis-cluster.html-8712f49e.js" as="script" /><link rel="prefetch" href="/assets/redis-overview.html-1fca9f7e.js" as="script" /><link rel="prefetch" href="/assets/java-base.html-ca97d2c7.js" as="script" /><link rel="prefetch" href="/assets/java-sql.html-bbe6c4c2.js" as="script" /><link rel="prefetch" href="/assets/java-time.html-ce7c9496.js" as="script" /><link rel="prefetch" href="/assets/java-collection-list.html-8bbef8fd.js" as="script" /><link rel="prefetch" href="/assets/java-collection-map.html-9ee599cf.js" as="script" /><link rel="prefetch" href="/assets/java-collection-overview.html-31570b40.js" as="script" /><link rel="prefetch" href="/assets/java-concurrent-base.html-2e26c5a1.js" as="script" /><link rel="prefetch" href="/assets/Java-concurrent-container.html-e5f75933.js" as="script" /><link rel="prefetch" href="/assets/java-concurrent-interview.html-d289133d.js" as="script" /><link rel="prefetch" href="/assets/java-concurrent-lock.html-cbd95e38.js" as="script" /><link rel="prefetch" href="/assets/java-concurrent-pool.html-a9ecee05.js" as="script" /><link rel="prefetch" href="/assets/java-concurrent-tools.html-76151b53.js" as="script" /><link rel="prefetch" href="/assets/java-bio.html-d706ae9b.js" as="script" /><link rel="prefetch" href="/assets/java-io-base.html-bb263882.js" as="script" /><link rel="prefetch" href="/assets/java-nio.html-2de47e3f.js" as="script" /><link rel="prefetch" href="/assets/Javaå†…å­˜æ¨¡å‹.html-0e76463e.js" as="script" /><link rel="prefetch" href="/assets/JVMå†…å­˜ç»“æ„.html-b17bcef0.js" as="script" /><link rel="prefetch" href="/assets/JVMåƒåœ¾å›æ”¶.html-ee219a34.js" as="script" /><link rel="prefetch" href="/assets/JVMæ¦‚è§ˆ.html-b4ce8fc6.js" as="script" /><link rel="prefetch" href="/assets/JVMç±»åŠ è½½å™¨.html-dd7f5a89.js" as="script" /><link rel="prefetch" href="/assets/JVMç±»æ–‡ä»¶ç»“æ„.html-8859cd08.js" as="script" /><link rel="prefetch" href="/assets/JVMè°ƒä¼˜.html-0d15b1ba.js" as="script" /><link rel="prefetch" href="/assets/java-servlet.html-c7a54ede.js" as="script" /><link rel="prefetch" href="/assets/java-lambda.html-56b847d2.js" as="script" /><link rel="prefetch" href="/assets/java-stream.html-6167e062.js" as="script" /><link rel="prefetch" href="/assets/HikariCP-base.html-f5a4e8e5.js" as="script" /><link rel="prefetch" href="/assets/HikariCP-source.html-7a2f3fac.js" as="script" /><link rel="prefetch" href="/assets/jackson-overview.html-57cfb768.js" as="script" /><link rel="prefetch" href="/assets/kafka-broker.html-a30f3377.js" as="script" /><link rel="prefetch" href="/assets/kafka-consumer.html-2a1327ac.js" as="script" /><link rel="prefetch" href="/assets/kafka-overview.html-698972bc.js" as="script" /><link rel="prefetch" href="/assets/kafka-producer.html-579ce0f8.js" as="script" /><link rel="prefetch" href="/assets/spring-kafka.html-b1a1e4d1.js" as="script" /><link rel="prefetch" href="/assets/log-framework.html-98a12691.js" as="script" /><link rel="prefetch" href="/assets/1.Hello World.html-4b77eac1.js" as="script" /><link rel="prefetch" href="/assets/2.Global Config.html-bd544474.js" as="script" /><link rel="prefetch" href="/assets/index.html-905c3f62.js" as="script" /><link rel="prefetch" href="/assets/sharding-sphere.html-a30db686.js" as="script" /><link rel="prefetch" href="/assets/shiro-overview.html-fa31ba73.js" as="script" /><link rel="prefetch" href="/assets/tomcat.html-4ad2c770.js" as="script" /><link rel="prefetch" href="/assets/data-structure-list.html-17b01002.js" as="script" /><link rel="prefetch" href="/assets/data-structure-overview.html-44ed6838.js" as="script" /><link rel="prefetch" href="/assets/data-structure-tree.html-c806dd3b.js" as="script" /><link rel="prefetch" href="/assets/design-adapter.html-0e9d816d.js" as="script" /><link rel="prefetch" href="/assets/design-chain.html-bb17cabc.js" as="script" /><link rel="prefetch" href="/assets/design-composite.html-1d475fbf.js" as="script" /><link rel="prefetch" href="/assets/design-decorator.html-4f27f10a.js" as="script" /><link rel="prefetch" href="/assets/design-overview.html-0a940fb3.js" as="script" /><link rel="prefetch" href="/assets/design-proxy.html-100e60b2.js" as="script" /><link rel="prefetch" href="/assets/design-strategy.html-a2df8a49.js" as="script" /><link rel="prefetch" href="/assets/æ»‘åŠ¨çª—å£.html-86771022.js" as="script" /><link rel="prefetch" href="/assets/linux-overview.html-2bd9af93.js" as="script" /><link rel="prefetch" href="/assets/encoding.html-304390cc.js" as="script" /><link rel="prefetch" href="/assets/encryption-algorithm.html-fb0becaa.js" as="script" /><link rel="prefetch" href="/assets/temp.html-ac4ce374.js" as="script" /><link rel="prefetch" href="/assets/BeanPostProcessor-base.html-c6481b26.js" as="script" /><link rel="prefetch" href="/assets/BeanPostProcessor-ConfigurationClassPostProcessor.html-ba0c8ae7.js" as="script" /><link rel="prefetch" href="/assets/spring-source-overview.html-9371e343.js" as="script" /><link rel="prefetch" href="/assets/spring-boot-condition.html-a415267e.js" as="script" /><link rel="prefetch" href="/assets/spring-cloud-commons-base.html-f75ee2c9.js" as="script" /><link rel="prefetch" href="/assets/spring-cloud-gateway.html-03291875.js" as="script" /><link rel="prefetch" href="/assets/spring-cloud-loadbalancer.html-ccdc0547.js" as="script" /><link rel="prefetch" href="/assets/nacos-client-discovery.html-17a81d03.js" as="script" /><link rel="prefetch" href="/assets/nacos-overview.html-539b7085.js" as="script" /><link rel="prefetch" href="/assets/cloud-openfeign-action.html-7761387f.js" as="script" /><link rel="prefetch" href="/assets/spring-cloud-openfeign.html-10212321.js" as="script" /><link rel="prefetch" href="/assets/sentinel-source.html-dc297934.js" as="script" /><link rel="prefetch" href="/assets/git.html-cb7e5449.js" as="script" /><link rel="prefetch" href="/assets/gitlab.html-eb2126d8.js" as="script" /><link rel="prefetch" href="/assets/junit4.html-6c786952.js" as="script" /><link rel="prefetch" href="/assets/junit5.html-e36d7d70.js" as="script" /><link rel="prefetch" href="/assets/maven.html-e0151a0f.js" as="script" /><link rel="prefetch" href="/assets/reactor.html-cd44ff8d.js" as="script" /><link rel="prefetch" href="/assets/spring-source-web-init.html-b8105d34.js" as="script" /><link rel="prefetch" href="/assets/spring-source-web-listener.html-7b8c6479.js" as="script" /><link rel="prefetch" href="/assets/404.html-f04ced3e.js" as="script" /><link rel="prefetch" href="/assets/index.html-62ca9f14.js" as="script" /><link rel="prefetch" href="/assets/index.html-fc52137e.js" as="script" /><link rel="prefetch" href="/assets/index.html-ee301928.js" as="script" /><link rel="prefetch" href="/assets/index.html-d0c5f0f0.js" as="script" /><link rel="prefetch" href="/assets/index.html-25bcd8c4.js" as="script" /><link rel="prefetch" href="/assets/index.html-37f2094a.js" as="script" /><link rel="prefetch" href="/assets/index.html-50de9de4.js" as="script" /><link rel="prefetch" href="/assets/index.html-a6bbb2fe.js" as="script" /><link rel="prefetch" href="/assets/index.html-afe963e2.js" as="script" /><link rel="prefetch" href="/assets/index.html-e1231d43.js" as="script" /><link rel="prefetch" href="/assets/index.html-c4d07d46.js" as="script" /><link rel="prefetch" href="/assets/index.html-19c8c7e9.js" as="script" /><link rel="prefetch" href="/assets/spring-cloud-alibaba-seate.html-b5da756c.js" as="script" /><link rel="prefetch" href="/assets/spring-cloud-overview.html-ff9b794b.js" as="script" /><link rel="prefetch" href="/assets/gitbook.html-5a50abf0.js" as="script" /><link rel="prefetch" href="/assets/mysql-advance.html-79a57a00.js" as="script" /><link rel="prefetch" href="/assets/mysql-apply.html-b76d628d.js" as="script" /><link rel="prefetch" href="/assets/mysql-base.html-95625c2f.js" as="script" /><link rel="prefetch" href="/assets/mysql-devops.html-74e24111.js" as="script" /><link rel="prefetch" href="/assets/redis-base.html-0c64fcd1.js" as="script" /><link rel="prefetch" href="/assets/redis-cluster.html-d9e53ddd.js" as="script" /><link rel="prefetch" href="/assets/redis-overview.html-d8ed14d9.js" as="script" /><link rel="prefetch" href="/assets/java-base.html-bb254e89.js" as="script" /><link rel="prefetch" href="/assets/java-sql.html-98f87090.js" as="script" /><link rel="prefetch" href="/assets/java-time.html-1149c2e2.js" as="script" /><link rel="prefetch" href="/assets/java-collection-list.html-dcb82f95.js" as="script" /><link rel="prefetch" href="/assets/java-collection-map.html-20b29455.js" as="script" /><link rel="prefetch" href="/assets/java-collection-overview.html-0153adc1.js" as="script" /><link rel="prefetch" href="/assets/java-concurrent-base.html-4092d51f.js" as="script" /><link rel="prefetch" href="/assets/Java-concurrent-container.html-f22d5109.js" as="script" /><link rel="prefetch" href="/assets/java-concurrent-interview.html-02742a0a.js" as="script" /><link rel="prefetch" href="/assets/java-concurrent-lock.html-41872812.js" as="script" /><link rel="prefetch" href="/assets/java-concurrent-pool.html-b7de958e.js" as="script" /><link rel="prefetch" href="/assets/java-concurrent-tools.html-b9ad45db.js" as="script" /><link rel="prefetch" href="/assets/java-bio.html-a5769212.js" as="script" /><link rel="prefetch" href="/assets/java-io-base.html-e3ef5e77.js" as="script" /><link rel="prefetch" href="/assets/java-nio.html-a3fa4765.js" as="script" /><link rel="prefetch" href="/assets/Javaå†…å­˜æ¨¡å‹.html-087adb9d.js" as="script" /><link rel="prefetch" href="/assets/JVMå†…å­˜ç»“æ„.html-4bc916e1.js" as="script" /><link rel="prefetch" href="/assets/JVMåƒåœ¾å›æ”¶.html-c6e0e3e0.js" as="script" /><link rel="prefetch" href="/assets/JVMæ¦‚è§ˆ.html-435f6ec8.js" as="script" /><link rel="prefetch" href="/assets/JVMç±»åŠ è½½å™¨.html-0c7f8931.js" as="script" /><link rel="prefetch" href="/assets/JVMç±»æ–‡ä»¶ç»“æ„.html-5afd6d1d.js" as="script" /><link rel="prefetch" href="/assets/JVMè°ƒä¼˜.html-9a1a4154.js" as="script" /><link rel="prefetch" href="/assets/java-servlet.html-f9646dd1.js" as="script" /><link rel="prefetch" href="/assets/java-lambda.html-1db83529.js" as="script" /><link rel="prefetch" href="/assets/java-stream.html-8b490468.js" as="script" /><link rel="prefetch" href="/assets/HikariCP-base.html-d01cd368.js" as="script" /><link rel="prefetch" href="/assets/HikariCP-source.html-27512376.js" as="script" /><link rel="prefetch" href="/assets/jackson-overview.html-ccca046f.js" as="script" /><link rel="prefetch" href="/assets/kafka-broker.html-7cc959b4.js" as="script" /><link rel="prefetch" href="/assets/kafka-consumer.html-35141192.js" as="script" /><link rel="prefetch" href="/assets/kafka-overview.html-b243daf8.js" as="script" /><link rel="prefetch" href="/assets/kafka-producer.html-93a69d00.js" as="script" /><link rel="prefetch" href="/assets/spring-kafka.html-0032d80c.js" as="script" /><link rel="prefetch" href="/assets/log-framework.html-5769500e.js" as="script" /><link rel="prefetch" href="/assets/1.Hello World.html-78e7fc50.js" as="script" /><link rel="prefetch" href="/assets/2.Global Config.html-d3157ebb.js" as="script" /><link rel="prefetch" href="/assets/index.html-44ddef87.js" as="script" /><link rel="prefetch" href="/assets/sharding-sphere.html-2e54e4df.js" as="script" /><link rel="prefetch" href="/assets/shiro-overview.html-e44b2286.js" as="script" /><link rel="prefetch" href="/assets/tomcat.html-653f98cd.js" as="script" /><link rel="prefetch" href="/assets/data-structure-list.html-420dc821.js" as="script" /><link rel="prefetch" href="/assets/data-structure-overview.html-e227421d.js" as="script" /><link rel="prefetch" href="/assets/data-structure-tree.html-752ceeb1.js" as="script" /><link rel="prefetch" href="/assets/design-adapter.html-41aa7652.js" as="script" /><link rel="prefetch" href="/assets/design-chain.html-8685e4e6.js" as="script" /><link rel="prefetch" href="/assets/design-composite.html-4375b033.js" as="script" /><link rel="prefetch" href="/assets/design-decorator.html-2b2ae807.js" as="script" /><link rel="prefetch" href="/assets/design-overview.html-300948fd.js" as="script" /><link rel="prefetch" href="/assets/design-proxy.html-e1813076.js" as="script" /><link rel="prefetch" href="/assets/design-strategy.html-a31637dd.js" as="script" /><link rel="prefetch" href="/assets/æ»‘åŠ¨çª—å£.html-ae330cc5.js" as="script" /><link rel="prefetch" href="/assets/linux-overview.html-8ac20a5d.js" as="script" /><link rel="prefetch" href="/assets/encoding.html-f8e7f158.js" as="script" /><link rel="prefetch" href="/assets/encryption-algorithm.html-bfb3dc64.js" as="script" /><link rel="prefetch" href="/assets/temp.html-ec342781.js" as="script" /><link rel="prefetch" href="/assets/BeanPostProcessor-base.html-a44c5c69.js" as="script" /><link rel="prefetch" href="/assets/BeanPostProcessor-ConfigurationClassPostProcessor.html-edba8ecd.js" as="script" /><link rel="prefetch" href="/assets/spring-source-overview.html-576738e8.js" as="script" /><link rel="prefetch" href="/assets/spring-boot-condition.html-b4e4df1a.js" as="script" /><link rel="prefetch" href="/assets/spring-cloud-commons-base.html-39238198.js" as="script" /><link rel="prefetch" href="/assets/spring-cloud-gateway.html-7a4e7b1f.js" as="script" /><link rel="prefetch" href="/assets/spring-cloud-loadbalancer.html-7a202164.js" as="script" /><link rel="prefetch" href="/assets/nacos-client-discovery.html-1f7ae7f3.js" as="script" /><link rel="prefetch" href="/assets/nacos-overview.html-43d7250d.js" as="script" /><link rel="prefetch" href="/assets/cloud-openfeign-action.html-7559bcf7.js" as="script" /><link rel="prefetch" href="/assets/spring-cloud-openfeign.html-47e8c26d.js" as="script" /><link rel="prefetch" href="/assets/sentinel-source.html-dc357213.js" as="script" /><link rel="prefetch" href="/assets/git.html-eefdc275.js" as="script" /><link rel="prefetch" href="/assets/gitlab.html-65555382.js" as="script" /><link rel="prefetch" href="/assets/junit4.html-c35363b6.js" as="script" /><link rel="prefetch" href="/assets/junit5.html-bdf5716e.js" as="script" /><link rel="prefetch" href="/assets/maven.html-7c434596.js" as="script" /><link rel="prefetch" href="/assets/reactor.html-f20890c4.js" as="script" /><link rel="prefetch" href="/assets/spring-source-web-init.html-27ad7747.js" as="script" /><link rel="prefetch" href="/assets/spring-source-web-listener.html-2166addd.js" as="script" /><link rel="prefetch" href="/assets/404.html-46b6c18e.js" as="script" /><link rel="prefetch" href="/assets/index.html-ed68d2be.js" as="script" /><link rel="prefetch" href="/assets/index.html-398e9a2c.js" as="script" /><link rel="prefetch" href="/assets/index.html-902245d5.js" as="script" /><link rel="prefetch" href="/assets/index.html-93ba03a9.js" as="script" /><link rel="prefetch" href="/assets/index.html-70956359.js" as="script" /><link rel="prefetch" href="/assets/index.html-f0a732cd.js" as="script" /><link rel="prefetch" href="/assets/index.html-3344b751.js" as="script" /><link rel="prefetch" href="/assets/index.html-6d2a3ffd.js" as="script" /><link rel="prefetch" href="/assets/index.html-a5787a89.js" as="script" /><link rel="prefetch" href="/assets/index.html-440f50d2.js" as="script" /><link rel="prefetch" href="/assets/index.html-a7274cc8.js" as="script" /><link rel="prefetch" href="/assets/clientConfigs-bdea5ab7.js" as="script" /><link rel="prefetch" href="/assets/clientConfigs-bdea5ab7.js" as="script" />
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><!----><!----><span class="site-name">Java æˆç¥ä¹‹è·¯</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Java ç¬”è®°"><span class="title"><!---->Java ç¬”è®°</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Java åŸºç¡€</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/java-base/java-base.html" class="nav-link" aria-label="Java åŸºç¡€çŸ¥è¯†"><!---->Java åŸºç¡€çŸ¥è¯†<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Java IO</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/java-io/java-io-base.html" class="nav-link" aria-label="Java IO åŸºç¡€çŸ¥è¯†"><!---->Java IO åŸºç¡€çŸ¥è¯†<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Java é›†åˆ</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/java-collection/java-collection-overview.html" class="nav-link" aria-label="Java é›†åˆæ¦‚è§ˆ"><!---->Java é›†åˆæ¦‚è§ˆ<!----></a></li><li class="dropdown-subitem"><a href="/java/java-collection/java-collection-list.html" class="nav-link" aria-label="Java Listé›†åˆ"><!---->Java Listé›†åˆ<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Java å¹¶å‘</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/java-concurrent/java-concurrent-base.html" class="nav-link" aria-label="Java å¹¶å‘åŸºç¡€"><!---->Java å¹¶å‘åŸºç¡€<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>JVM è¯¦è§£</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/java-jvm/JVM%E6%A6%82%E8%A7%88.html" class="nav-link" aria-label="JVMæ¦‚è§ˆ"><!---->JVMæ¦‚è§ˆ<!----></a></li><li class="dropdown-subitem"><a href="/java/java-jvm/JVM%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84.html" class="nav-link" aria-label="JVMå†…å­˜ç»“æ„"><!---->JVMå†…å­˜ç»“æ„<!----></a></li><li class="dropdown-subitem"><a href="/java/java-jvm/JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6.html" class="nav-link" aria-label="JVMåƒåœ¾å›æ”¶"><!---->JVMåƒåœ¾å›æ”¶<!----></a></li><li class="dropdown-subitem"><a href="/java/java-jvm/JVM%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84.html" class="nav-link" aria-label="JVMç±»æ–‡ä»¶ç»“æ„"><!---->JVMç±»æ–‡ä»¶ç»“æ„<!----></a></li><li class="dropdown-subitem"><a href="/java/java-jvm/JVM%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8.html" class="nav-link" aria-label="JVMç±»åŠ è½½å™¨"><!---->JVMç±»åŠ è½½å™¨<!----></a></li><li class="dropdown-subitem"><a href="/java/java-jvm/JVMå†…å­˜æ¨¡å‹.html" class="nav-link" aria-label="Javaå†…å­˜æ¨¡å‹"><!---->Javaå†…å­˜æ¨¡å‹<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Spring ç¬”è®°"><span class="title"><!---->Spring ç¬”è®°</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Spring IOC</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/spring/test02.html" class="nav-link" aria-label="Spring IOCè¯¦è§£"><!---->Spring IOCè¯¦è§£<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Spring åç½®å¤„ç†å™¨è§£æ</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/spring/spring-bean-post-processor/BeanPostProcessor-base.html" class="nav-link" aria-label="Spring åç½®å¤„ç†å™¨æ€»è§ˆ"><!---->Spring åç½®å¤„ç†å™¨æ€»è§ˆ<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Spring Cloud"><span class="title"><!---->Spring Cloud</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/spring-cloud/spring-cloud-overview.html" class="nav-link" aria-label="Spring Cloud Overview"><!---->Spring Cloud Overview<!----></a></li><li class="dropdown-item"><a href="/spring-cloud/spring-cloud-alibaba-nacos.md" class="nav-link" aria-label="Spring Cloud Nacos"><!---->Spring Cloud Nacos<!----></a></li><li class="dropdown-item"><a href="/spring-cloud/spring-cloud-alibaba-sentinel.md" class="nav-link" aria-label="Spring Cloud Sentinel"><!---->Spring Cloud Sentinel<!----></a></li><li class="dropdown-item"><a href="/spring-cloud/spring-cloud-alibaba-seate.html" class="nav-link" aria-label="Spring Cloud Seate"><!---->Spring Cloud Seate<!----></a></li><li class="dropdown-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html" class="router-link-active router-link-exact-active nav-link active" aria-label="Spring Cloud Ribbon"><!---->Spring Cloud Ribbon<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="æ•°æ®åº“"><span class="title"><!---->æ•°æ®åº“</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>MySQL</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/database/mysql/mysql-base.html" class="nav-link" aria-label="MySQL åŸºç¡€ç¯‡"><!---->MySQL åŸºç¡€ç¯‡<!----></a></li><li class="dropdown-subitem"><a href="/database/mysql/mysql-advance.html" class="nav-link" aria-label="MySQL è¿›é˜¶ç¯‡"><!---->MySQL è¿›é˜¶ç¯‡<!----></a></li><li class="dropdown-subitem"><a href="/database/mysql/mysql-devops.html" class="nav-link" aria-label="MySQL è¿ç»´ç¯‡"><!---->MySQL è¿ç»´ç¯‡<!----></a></li><li class="dropdown-subitem"><a href="/database/mysql/mysql-apply.html" class="nav-link" aria-label="MySQL åº”ç”¨ç¯‡"><!---->MySQL åº”ç”¨ç¯‡<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="è‡ªæˆ‘ä¿®å…»"><span class="title"><!---->è‡ªæˆ‘ä¿®å…»</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/quality/design-mode/design-overview.html" class="nav-link" aria-label="è®¾è®¡æ¨¡å¼"><!---->è®¾è®¡æ¨¡å¼<!----></a></li><li class="dropdown-item"><a href="/quality/data-structure/data-structure-overview.html" class="nav-link" aria-label="æ•°æ®ç»“æ„"><!---->æ•°æ®ç»“æ„<!----></a></li><li class="dropdown-item"><a href="/quality/linux/linux-overview.html" class="nav-link" aria-label="Linux æ€»ç»“"><!---->Linux æ€»ç»“<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="ä¸­é—´ä»¶"><span class="title"><!---->ä¸­é—´ä»¶</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/middleware/tomcat/tomcat.html" class="nav-link" aria-label="Tomcat ä¸“é¢˜"><!---->Tomcat ä¸“é¢˜<!----></a></li><li class="dropdown-item"><a href="/middleware/kafka/kafka-overview.html" class="nav-link" aria-label="Kafka ä¸“é¢˜"><!---->Kafka ä¸“é¢˜<!----></a></li><li class="dropdown-item"><a href="/middleware/redis/redis-overview.md" class="nav-link" aria-label="Redis ä¸“é¢˜"><!---->Redis ä¸“é¢˜<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="å·¥å…·åŒ…"><span class="title"><!---->å·¥å…·åŒ…</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Junit æµ‹è¯•æ¡†æ¶</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/tools/junit/junit5.html" class="nav-link" aria-label="Junit 5 ä½¿ç”¨æ€»ç»“"><!---->Junit 5 ä½¿ç”¨æ€»ç»“<!----></a></li></ul></li><li class="dropdown-item"><a href="/tools/log/log-framework.md" class="nav-link" aria-label="Java æ—¥å¿—æ¡†æ¶"><!---->Java æ—¥å¿—æ¡†æ¶<!----></a></li><li class="dropdown-item"><a href="/tools/maven/maven.html" class="nav-link" aria-label="Maven ä½¿ç”¨å…¥é—¨"><!---->Maven ä½¿ç”¨å…¥é—¨<!----></a></li></ul></button></div></div></nav><!--[--><!----><!--]--></div><div class="navbar-right"><!--[--><!----><!--]--><!----><!----><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><p class="sidebar-heading"><!----><span class="title">å¾®æœåŠ¡æ¶æ„</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/spring-cloud/spring-cloud-overview.html" class="nav-link sidebar-link sidebar-page" aria-label="Spring Cloud"><!---->Spring Cloud<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/spring-cloud/spring-cloud-nacos/nacos-client-discovery.html" class="nav-link sidebar-link sidebar-page" aria-label="NacosæœåŠ¡æ³¨å†Œå‘ç°åŸç†"><!---->NacosæœåŠ¡æ³¨å†Œå‘ç°åŸç†<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/spring-cloud/spring-cloud-nacos/nacos-overview.html" class="nav-link sidebar-link sidebar-page" aria-label="Nacos"><!---->Nacos<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/spring-cloud/spring-cloud-sentinel/sentinel-source.html" class="nav-link sidebar-link sidebar-page" aria-label="Sentinel æºç åˆ†æ"><!---->Sentinel æºç åˆ†æ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/spring-cloud/spring-cloud-alibaba-seate.html" class="nav-link sidebar-link sidebar-page" aria-label="Spring Cloud Alibaba Seate"><!---->Spring Cloud Alibaba Seate<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/spring-cloud/spring-cloud-gateway/spring-cloud-gateway.html" class="nav-link sidebar-link sidebar-page" aria-label="Spring Cloud Gateway"><!---->Spring Cloud Gateway<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading active"><!----><span class="title">å¸¸ç”¨ç»„ä»¶</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/spring-cloud/spring-cloud-openfeign/spring-cloud-openfeign.html" class="nav-link sidebar-link sidebar-page" aria-label="Spring Cloud OpenFeign æºç è§£æ"><!---->Spring Cloud OpenFeign æºç è§£æ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="Spring Cloud Ribbon æºç è§£æ"><!---->Spring Cloud Ribbon æºç è§£æ<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#è´Ÿè½½å‡è¡¡ç®€ä»‹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="è´Ÿè½½å‡è¡¡ç®€ä»‹"><!---->è´Ÿè½½å‡è¡¡ç®€ä»‹<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#æœåŠ¡å™¨ç«¯è´Ÿè½½å‡è¡¡å™¨" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="æœåŠ¡å™¨ç«¯è´Ÿè½½å‡è¡¡å™¨"><!---->æœåŠ¡å™¨ç«¯è´Ÿè½½å‡è¡¡å™¨<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨"><!---->å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbon-ç®€ä»‹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Spring Cloud Ribbon ç®€ä»‹"><!---->Spring Cloud Ribbon ç®€ä»‹<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbonä¸­çš„å…³é”®ç»„ä»¶" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Spring Cloud Ribbonä¸­çš„å…³é”®ç»„ä»¶"><!---->Spring Cloud Ribbonä¸­çš„å…³é”®ç»„ä»¶<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbonç®€å•ä½¿ç”¨" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Spring Cloud Ribbonç®€å•ä½¿ç”¨"><!---->Spring Cloud Ribbonç®€å•ä½¿ç”¨<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbonçš„è´Ÿè½½å‡è¡¡ç­–ç•¥" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Spring Cloud Ribbonçš„è´Ÿè½½å‡è¡¡ç­–ç•¥"><!---->Spring Cloud Ribbonçš„è´Ÿè½½å‡è¡¡ç­–ç•¥<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#è´Ÿè½½å‡è¡¡ç­–ç•¥æ¦‚è¿°" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="è´Ÿè½½å‡è¡¡ç­–ç•¥æ¦‚è¿°"><!---->è´Ÿè½½å‡è¡¡ç­–ç•¥æ¦‚è¿°<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#randomrule" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="RandomRule"><!---->RandomRule<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#roundrobinrule" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="RoundRobinRule"><!---->RoundRobinRule<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#retryrule" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="RetryRule"><!---->RetryRule<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#clientconfigenabledroundrobinrule" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ClientConfigEnabledRoundRobinRule"><!---->ClientConfigEnabledRoundRobinRule<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#weightedresponsetimerule" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="WeightedResponseTimeRule"><!---->WeightedResponseTimeRule<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#bestavailablerule" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="BestAvailableRule"><!---->BestAvailableRule<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#zoneavoidancerule" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ZoneAvoidanceRule"><!---->ZoneAvoidanceRule<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbonçš„å¿ƒè·³æ£€æµ‹æœºåˆ¶" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Spring Cloud Ribbonçš„å¿ƒè·³æ£€æµ‹æœºåˆ¶"><!---->Spring Cloud Ribbonçš„å¿ƒè·³æ£€æµ‹æœºåˆ¶<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#noopping" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="NoOpPing"><!---->NoOpPing<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#pingurl" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="PingUrl"><!---->PingUrl<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#pingconstant" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="PingConstant"><!---->PingConstant<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#dummyping" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="DummyPing"><!---->DummyPing<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbonçš„æœåŠ¡åˆ—è¡¨" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Spring Cloud Ribbonçš„æœåŠ¡åˆ—è¡¨"><!---->Spring Cloud Ribbonçš„æœåŠ¡åˆ—è¡¨<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#staticserverlist" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="StaticServerList"><!---->StaticServerList<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#configurationbasedserverlist" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ConfigurationBasedServerList"><!---->ConfigurationBasedServerList<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#nacosserverlist" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="NacosServerList"><!---->NacosServerList<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbonçš„æœåŠ¡åˆ—è¡¨è¿‡æ»¤" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Spring Cloud Ribbonçš„æœåŠ¡åˆ—è¡¨è¿‡æ»¤"><!---->Spring Cloud Ribbonçš„æœåŠ¡åˆ—è¡¨è¿‡æ»¤<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#zoneaffinityserverlistfilter" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ZoneAffinityServerListFilter"><!---->ZoneAffinityServerListFilter<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#serverlistsubsetfilter" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ServerListSubsetFilter"><!---->ServerListSubsetFilter<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#zonepreferenceserverlistfilter" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ZonePreferenceServerListFilter"><!---->ZonePreferenceServerListFilter<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbonçš„æœåŠ¡åˆ—è¡¨æ›´æ–°" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Spring Cloud Ribbonçš„æœåŠ¡åˆ—è¡¨æ›´æ–°"><!---->Spring Cloud Ribbonçš„æœåŠ¡åˆ—è¡¨æ›´æ–°<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#pollingserverlistupdater" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="PollingServerListUpdater"><!---->PollingServerListUpdater<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbonçš„è´Ÿè½½å‡è¡¡å™¨" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Spring Cloud Ribbonçš„è´Ÿè½½å‡è¡¡å™¨"><!---->Spring Cloud Ribbonçš„è´Ÿè½½å‡è¡¡å™¨<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#nooploadbalancer" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="NoOpLoadBalancer"><!---->NoOpLoadBalancer<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#baseloadbalancer" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="BaseLoadBalancer"><!---->BaseLoadBalancer<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#dynamicserverlistloadbalancer" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="DynamicServerListLoadBalancer"><!---->DynamicServerListLoadBalancer<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#zoneawareloadbalancer" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ZoneAwareLoadBalancer"><!---->ZoneAwareLoadBalancer<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbonè‡ªåŠ¨è£…é…" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Spring Cloud Ribbonè‡ªåŠ¨è£…é…"><!---->Spring Cloud Ribbonè‡ªåŠ¨è£…é…<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#ribbonautoconfigurationä¸Šçš„æ³¨è§£" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="RibbonAutoConfigurationä¸Šçš„æ³¨è§£"><!---->RibbonAutoConfigurationä¸Šçš„æ³¨è§£<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#ribbonautoconfiguration" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="RibbonAutoConfiguration"><!---->RibbonAutoConfiguration<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#loadbalancerautoconfiguration" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="LoadBalancerAutoConfiguration"><!---->LoadBalancerAutoConfiguration<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbonä¸­é‡è¦çš„ç»„ä»¶" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Spring Cloud Ribbonä¸­é‡è¦çš„ç»„ä»¶"><!---->Spring Cloud Ribbonä¸­é‡è¦çš„ç»„ä»¶<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#iclientconfig" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="IClientConfig"><!---->IClientConfig<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#loadbalancerstatus" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="LoadBalancerStatus"><!---->LoadBalancerStatus<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbonä¸­çš„ç›‘æ§ç»„ä»¶" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Spring Cloud Ribbonä¸­çš„ç›‘æ§ç»„ä»¶"><!---->Spring Cloud Ribbonä¸­çš„ç›‘æ§ç»„ä»¶<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#åŸºç¡€å·¥å…·åŒ…" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="åŸºç¡€å·¥å…·åŒ…"><!---->åŸºç¡€å·¥å…·åŒ…<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#serverstats" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ServerStats"><!---->ServerStats<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#loadbalancerstats" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="LoadBalancerStats"><!---->LoadBalancerStats<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbon-é…ç½®æ€»ç»“" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Spring Cloud Ribbon é…ç½®æ€»ç»“"><!---->Spring Cloud Ribbon é…ç½®æ€»ç»“<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->Spring Cloud Ribbon æºç è§£æ</h1><div class="page-info"><!----><!----><span class="date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2022-06-11T14:36:26.000Z"></span><!----><!----><span class="reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 39 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT39M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">æ­¤é¡µå†…å®¹</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#è´Ÿè½½å‡è¡¡ç®€ä»‹" class="router-link-active router-link-exact-active toc-link level2">è´Ÿè½½å‡è¡¡ç®€ä»‹</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#æœåŠ¡å™¨ç«¯è´Ÿè½½å‡è¡¡å™¨" class="router-link-active router-link-exact-active toc-link level3">æœåŠ¡å™¨ç«¯è´Ÿè½½å‡è¡¡å™¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨" class="router-link-active router-link-exact-active toc-link level3">å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbon-ç®€ä»‹" class="router-link-active router-link-exact-active toc-link level2">Spring Cloud Ribbon ç®€ä»‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbonä¸­çš„å…³é”®ç»„ä»¶" class="router-link-active router-link-exact-active toc-link level2">Spring Cloud Ribbonä¸­çš„å…³é”®ç»„ä»¶</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbonç®€å•ä½¿ç”¨" class="router-link-active router-link-exact-active toc-link level2">Spring Cloud Ribbonç®€å•ä½¿ç”¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbonçš„è´Ÿè½½å‡è¡¡ç­–ç•¥" class="router-link-active router-link-exact-active toc-link level2">Spring Cloud Ribbonçš„è´Ÿè½½å‡è¡¡ç­–ç•¥</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#è´Ÿè½½å‡è¡¡ç­–ç•¥æ¦‚è¿°" class="router-link-active router-link-exact-active toc-link level3">è´Ÿè½½å‡è¡¡ç­–ç•¥æ¦‚è¿°</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#randomrule" class="router-link-active router-link-exact-active toc-link level3">RandomRule</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#roundrobinrule" class="router-link-active router-link-exact-active toc-link level3">RoundRobinRule</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#retryrule" class="router-link-active router-link-exact-active toc-link level3">RetryRule</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#clientconfigenabledroundrobinrule" class="router-link-active router-link-exact-active toc-link level3">ClientConfigEnabledRoundRobinRule</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#weightedresponsetimerule" class="router-link-active router-link-exact-active toc-link level3">WeightedResponseTimeRule</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#bestavailablerule" class="router-link-active router-link-exact-active toc-link level3">BestAvailableRule</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#zoneavoidancerule" class="router-link-active router-link-exact-active toc-link level3">ZoneAvoidanceRule</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbonçš„å¿ƒè·³æ£€æµ‹æœºåˆ¶" class="router-link-active router-link-exact-active toc-link level2">Spring Cloud Ribbonçš„å¿ƒè·³æ£€æµ‹æœºåˆ¶</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#noopping" class="router-link-active router-link-exact-active toc-link level3">NoOpPing</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#pingurl" class="router-link-active router-link-exact-active toc-link level3">PingUrl</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#pingconstant" class="router-link-active router-link-exact-active toc-link level3">PingConstant</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#dummyping" class="router-link-active router-link-exact-active toc-link level3">DummyPing</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbonçš„æœåŠ¡åˆ—è¡¨" class="router-link-active router-link-exact-active toc-link level2">Spring Cloud Ribbonçš„æœåŠ¡åˆ—è¡¨</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#staticserverlist" class="router-link-active router-link-exact-active toc-link level3">StaticServerList</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#configurationbasedserverlist" class="router-link-active router-link-exact-active toc-link level3">ConfigurationBasedServerList</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#nacosserverlist" class="router-link-active router-link-exact-active toc-link level3">NacosServerList</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbonçš„æœåŠ¡åˆ—è¡¨è¿‡æ»¤" class="router-link-active router-link-exact-active toc-link level2">Spring Cloud Ribbonçš„æœåŠ¡åˆ—è¡¨è¿‡æ»¤</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#zoneaffinityserverlistfilter" class="router-link-active router-link-exact-active toc-link level3">ZoneAffinityServerListFilter</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#serverlistsubsetfilter" class="router-link-active router-link-exact-active toc-link level3">ServerListSubsetFilter</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#zonepreferenceserverlistfilter" class="router-link-active router-link-exact-active toc-link level3">ZonePreferenceServerListFilter</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbonçš„æœåŠ¡åˆ—è¡¨æ›´æ–°" class="router-link-active router-link-exact-active toc-link level2">Spring Cloud Ribbonçš„æœåŠ¡åˆ—è¡¨æ›´æ–°</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#pollingserverlistupdater" class="router-link-active router-link-exact-active toc-link level3">PollingServerListUpdater</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbonçš„è´Ÿè½½å‡è¡¡å™¨" class="router-link-active router-link-exact-active toc-link level2">Spring Cloud Ribbonçš„è´Ÿè½½å‡è¡¡å™¨</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#nooploadbalancer" class="router-link-active router-link-exact-active toc-link level3">NoOpLoadBalancer</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#baseloadbalancer" class="router-link-active router-link-exact-active toc-link level3">BaseLoadBalancer</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#dynamicserverlistloadbalancer" class="router-link-active router-link-exact-active toc-link level3">DynamicServerListLoadBalancer</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#zoneawareloadbalancer" class="router-link-active router-link-exact-active toc-link level3">ZoneAwareLoadBalancer</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbonè‡ªåŠ¨è£…é…" class="router-link-active router-link-exact-active toc-link level2">Spring Cloud Ribbonè‡ªåŠ¨è£…é…</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#ribbonautoconfigurationä¸Šçš„æ³¨è§£" class="router-link-active router-link-exact-active toc-link level3">RibbonAutoConfigurationä¸Šçš„æ³¨è§£</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#ribbonautoconfiguration" class="router-link-active router-link-exact-active toc-link level3">RibbonAutoConfiguration</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#loadbalancerautoconfiguration" class="router-link-active router-link-exact-active toc-link level3">LoadBalancerAutoConfiguration</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbonä¸­é‡è¦çš„ç»„ä»¶" class="router-link-active router-link-exact-active toc-link level2">Spring Cloud Ribbonä¸­é‡è¦çš„ç»„ä»¶</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#iclientconfig" class="router-link-active router-link-exact-active toc-link level3">IClientConfig</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#loadbalancerstatus" class="router-link-active router-link-exact-active toc-link level3">LoadBalancerStatus</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbonä¸­çš„ç›‘æ§ç»„ä»¶" class="router-link-active router-link-exact-active toc-link level2">Spring Cloud Ribbonä¸­çš„ç›‘æ§ç»„ä»¶</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#åŸºç¡€å·¥å…·åŒ…" class="router-link-active router-link-exact-active toc-link level3">åŸºç¡€å·¥å…·åŒ…</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#serverstats" class="router-link-active router-link-exact-active toc-link level3">ServerStats</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#loadbalancerstats" class="router-link-active router-link-exact-active toc-link level3">LoadBalancerStats</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/spring-cloud/spring-cloud-ribbon/spring-cloud-ribbon.html#spring-cloud-ribbon-é…ç½®æ€»ç»“" class="router-link-active router-link-exact-active toc-link level2">Spring Cloud Ribbon é…ç½®æ€»ç»“</a></li><!----><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="spring-cloud-ribbon-æºç è§£æ" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ribbon-æºç è§£æ" aria-hidden="true">#</a> Spring Cloud Ribbon æºç è§£æ</h1><h2 id="è´Ÿè½½å‡è¡¡ç®€ä»‹" tabindex="-1"><a class="header-anchor" href="#è´Ÿè½½å‡è¡¡ç®€ä»‹" aria-hidden="true">#</a> è´Ÿè½½å‡è¡¡ç®€ä»‹</h2><p>è´Ÿè½½å‡è¡¡ï¼Œè‹±æ–‡åç§°ä¸ºLoad Balanceï¼Œå…¶å«ä¹‰å°±æ˜¯æŒ‡å°†è´Ÿè½½ï¼ˆå·¥ä½œä»»åŠ¡ï¼‰è¿›è¡Œå¹³è¡¡ã€åˆ†æ‘Šåˆ°å¤šä¸ªæ“ä½œå•å…ƒä¸Šè¿›è¡Œè¿è¡Œï¼Œä¾‹å¦‚FTPæœåŠ¡å™¨ã€WebæœåŠ¡å™¨ã€ä¼ä¸šæ ¸å¿ƒåº”ç”¨æœåŠ¡å™¨å’Œå…¶å®ƒä¸»è¦ä»»åŠ¡æœåŠ¡å™¨ç­‰ï¼Œä»è€ŒååŒå®Œæˆå·¥ä½œä»»åŠ¡ã€‚</p><p>è´Ÿè½½å‡è¡¡æ„å»ºåœ¨åŸæœ‰ç½‘ç»œç»“æ„ä¹‹ä¸Šï¼Œå®ƒæä¾›äº†ä¸€ç§é€æ˜ä¸”å»‰ä»·æœ‰æ•ˆçš„æ–¹æ³•æ‰©å±•æœåŠ¡å™¨å’Œç½‘ç»œè®¾å¤‡çš„å¸¦å®½ã€åŠ å¼ºç½‘ç»œæ•°æ®å¤„ç†èƒ½åŠ›ã€å¢åŠ ååé‡ã€æé«˜ç½‘ç»œçš„å¯ç”¨æ€§å’Œçµæ´»æ€§ã€‚</p><h3 id="æœåŠ¡å™¨ç«¯è´Ÿè½½å‡è¡¡å™¨" tabindex="-1"><a class="header-anchor" href="#æœåŠ¡å™¨ç«¯è´Ÿè½½å‡è¡¡å™¨" aria-hidden="true">#</a> æœåŠ¡å™¨ç«¯è´Ÿè½½å‡è¡¡å™¨</h3><p>ä¼ ç»Ÿä¸Šï¼ŒLoad Balancersï¼ˆä¾‹å¦‚Nginxã€F5ï¼‰æ˜¯æ”¾ç½®åœ¨æœåŠ¡å™¨ç«¯çš„ç»„ä»¶ã€‚å½“è¯·æ±‚æ¥è‡ª <strong>å®¢æˆ·ç«¯</strong> æ—¶ï¼Œå®ƒä»¬å°†è½¬åˆ°è´Ÿè½½å‡è¡¡å™¨ï¼Œè´Ÿè½½å‡è¡¡å™¨å°†ä¸ºè¯·æ±‚æŒ‡å®š <strong>æœåŠ¡å™¨</strong>ã€‚è´Ÿè½½å‡è¡¡å™¨ä½¿ç”¨çš„æœ€ç®€å•çš„ç®—æ³•æ˜¯éšæœºæŒ‡å®šã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¤§å¤šæ•°è´Ÿè½½å¹³è¡¡å™¨æ˜¯ç”¨äºæ§åˆ¶è´Ÿè½½å¹³è¡¡çš„ç¡¬ä»¶é›†æˆè½¯ä»¶ã€‚</p><p><img src="/assets/v2-056f3af3ae6ad842d6b57671f78ca1d5_b-ba69a707.webp" alt="åŠ¨å›¾"></p><p>é‡ç‚¹ï¼š</p><ul><li>å¯¹å®¢æˆ·ç«¯ä¸é€æ˜ï¼Œå®¢æˆ·ç«¯ä¸çŸ¥é“æœåŠ¡å™¨ç«¯çš„æœåŠ¡åˆ—è¡¨ï¼Œç”šè‡³ä¸çŸ¥é“è‡ªå·±å‘é€è¯·æ±‚çš„ç›®æ ‡åœ°å€å­˜åœ¨è´Ÿè½½å‡è¡¡å™¨ã€‚</li><li>æœåŠ¡å™¨ç«¯ç»´æŠ¤è´Ÿè½½å‡è¡¡æœåŠ¡å™¨ï¼Œæ§åˆ¶è´Ÿè½½å‡è¡¡ç­–ç•¥å’Œç®—æ³•ã€‚</li></ul><h3 id="å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨" tabindex="-1"><a class="header-anchor" href="#å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨" aria-hidden="true">#</a> å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨</h3><p>å½“è´Ÿè½½å‡è¡¡å™¨ä½äº <strong>å®¢æˆ·ç«¯</strong> æ—¶ï¼Œ<strong>å®¢æˆ·ç«¯</strong>å¾—åˆ°å¯ç”¨çš„æœåŠ¡å™¨åˆ—è¡¨ç„¶åæŒ‰ç…§ç‰¹å®šçš„è´Ÿè½½å‡è¡¡ç­–ç•¥,åˆ†å‘è¯·æ±‚åˆ°ä¸åŒçš„ <strong>æœåŠ¡å™¨</strong> ã€‚</p><p><img src="/assets/v2-0c112f54dcacfd2a6718a8b281b696c5_b-9b128df2.webp" alt="åŠ¨å›¾"></p><p>é‡ç‚¹ï¼š</p><ul><li>å¯¹å®¢æˆ·ç«¯é€æ˜ï¼Œå®¢æˆ·ç«¯éœ€è¦çŸ¥é“æœåŠ¡å™¨ç«¯çš„æœåŠ¡åˆ—è¡¨ï¼Œéœ€è¦è‡ªè¡Œå†³å®šè¯·æ±‚è¦å‘é€çš„ç›®æ ‡åœ°å€ã€‚</li><li>å®¢æˆ·ç«¯ç»´æŠ¤è´Ÿè½½å‡è¡¡æœåŠ¡å™¨ï¼Œæ§åˆ¶è´Ÿè½½å‡è¡¡ç­–ç•¥å’Œç®—æ³•ã€‚</li><li>ç›®å‰å•ç‹¬æä¾›çš„å®¢æˆ·ç«¯å®ç°æ¯”è¾ƒå°‘ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯åœ¨æ¡†æ¶å†…éƒ¨è‡ªè¡Œå®ç°ã€‚</li></ul><h2 id="spring-cloud-ribbon-ç®€ä»‹" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ribbon-ç®€ä»‹" aria-hidden="true">#</a> Spring Cloud Ribbon ç®€ä»‹</h2><p>Ribbonæ˜¯Netflixå…¬å¸å¼€æºçš„ä¸€ä¸ªå®¢æˆ·å•è´Ÿè½½å‡è¡¡çš„é¡¹ç›®ï¼Œå¯ä»¥è‡ªåŠ¨ä¸ Eureka è¿›è¡Œäº¤äº’ã€‚å®ƒæä¾›ä¸‹åˆ—ç‰¹æ€§ï¼š</p><ul><li>è´Ÿè½½å‡è¡¡</li><li>å®¹é”™</li><li>ä»¥å¼‚æ­¥å’Œååº”å¼æ¨¡å‹æ‰§è¡Œå¤šåè®® (HTTP, TCP, UDP)</li><li>ç¼“å­˜å’Œæ‰¹é‡</li></ul><h2 id="spring-cloud-ribbonä¸­çš„å…³é”®ç»„ä»¶" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ribbonä¸­çš„å…³é”®ç»„ä»¶" aria-hidden="true">#</a> Spring Cloud Ribbonä¸­çš„å…³é”®ç»„ä»¶</h2><p><img src="/assets/13587608-75ed41151f955860-c5960747.png" alt="img"></p><ul><li><p><strong>ServerList</strong>ï¼šå¯ä»¥å“åº”å®¢æˆ·ç«¯çš„ç‰¹å®šæœåŠ¡çš„æœåŠ¡å™¨åˆ—è¡¨ã€‚</p></li><li><p><strong>ServerListFilter</strong>ï¼šå¯ä»¥åŠ¨æ€è·å¾—çš„å…·æœ‰æ‰€éœ€ç‰¹å¾çš„å€™é€‰æœåŠ¡å™¨åˆ—è¡¨çš„è¿‡æ»¤å™¨ã€‚</p></li><li><p><strong>ServerListUpdater</strong>ï¼šç”¨äºæ‰§è¡ŒåŠ¨æ€æœåŠ¡å™¨åˆ—è¡¨æ›´æ–°ã€‚</p></li><li><p><strong>Rule</strong>ï¼šè´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œç”¨äºç¡®å®šä»æœåŠ¡å™¨åˆ—è¡¨è¿”å›å“ªä¸ªæœåŠ¡å™¨ã€‚</p></li><li><p><strong>Ping</strong>ï¼šå®¢æˆ·ç«¯ç”¨äºå¿«é€Ÿæ£€æŸ¥æœåŠ¡å™¨å½“æ—¶æ˜¯å¦å¤„äºæ´»åŠ¨çŠ¶æ€ã€‚</p></li><li><p><strong>LoadBalancer</strong>ï¼šè´Ÿè½½å‡è¡¡å™¨ï¼Œè´Ÿè´£è´Ÿè½½å‡è¡¡è°ƒåº¦çš„ç®¡ç†ã€‚</p></li></ul><h2 id="spring-cloud-ribbonç®€å•ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ribbonç®€å•ä½¿ç”¨" aria-hidden="true">#</a> Spring Cloud Ribbonç®€å•ä½¿ç”¨</h2><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œå°†RestTemplateå’ŒRibbonç»“åˆä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RibbonConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@LoadBalanced</span>
    <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¶ˆè´¹ç«¯è°ƒç”¨æœåŠ¡ç«¯æ¥å£ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RibbonService</span> <span class="token punctuation">{</span>
	
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token annotation punctuation">@LoadBalanced</span>
    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hi</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">&quot;http://service-hi/hi?name=&quot;</span><span class="token operator">+</span>name<span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è‡ªåŠ¨æ³¨å…¥æ—¶ï¼Œåªä¼šå°†æ ‡æ³¨äº†<code>@LoadBalanced</code>æ³¨è§£çš„RestTemplateå¯¹è±¡æ³¨å…¥è¿›æ¥ã€‚é‚£ä¹ˆ<code>@LoadBalanced</code>æ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æºç ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">FIELD</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">PARAMETER</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Inherited</span>
<span class="token annotation punctuation">@Qualifier</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">LoadBalanced</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°åœ¨LoadBalancedçš„å®šä¹‰ä¸Šæ·»åŠ äº†<code>@Qualifier</code>æ³¨è§£ï¼Œç”±æ­¤å®ç°äº†å¯¹<code>RestTemplate</code>å¯¹è±¡çš„æ ‡è®°ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹ï¼ŒSpring Cloud Ribbonæ˜¯å¦‚ä½•å®ç°å®¢æˆ·ç«¯çš„è´Ÿè½½å‡è¡¡çš„ã€‚</p><h2 id="spring-cloud-ribbonçš„è´Ÿè½½å‡è¡¡ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ribbonçš„è´Ÿè½½å‡è¡¡ç­–ç•¥" aria-hidden="true">#</a> Spring Cloud Ribbonçš„è´Ÿè½½å‡è¡¡ç­–ç•¥</h2><p>Ribbonä¸­è´Ÿè½½å‡è¡¡ç­–ç•¥çš„æŠ½è±¡æ¥å£å®šä¹‰ä¸º<code>IRule</code>ï¼Œä¸‹é¢æ¥çœ‹çœ‹æ¥å£å®šä¹‰ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IRule</span><span class="token punctuation">{</span>
    <span class="token comment">/*
     *æ ¹æ®keyä»å­˜æ´»çš„æœåŠ¡åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ª
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è®¾ç½®è´Ÿè½½å‡è¡¡å™¨</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLoadBalancer</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å–è´Ÿè½½å‡è¡¡å™¨</span>
    <span class="token keyword">public</span> <span class="token class-name">ILoadBalancer</span> <span class="token function">getLoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥å£<code>AbstractLoadBalancerRule</code>æ˜¯IRuleçš„ç›´æ¥æŠ½è±¡ç±»å®ç°</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractLoadBalancerRule</span> <span class="token keyword">implements</span> <span class="token class-name">IRule</span><span class="token punctuation">,</span> <span class="token class-name">IClientConfigAware</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLoadBalancer</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>lb <span class="token operator">=</span> lb<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ILoadBalancer</span> <span class="token function">getLoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> lb<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>      
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå…¶é™¤äº†å®ç°äº†ä¸€ä¸ªIClientConfigAwareæ¥å£ï¼Œä»¥åŠå®ç°äº†è´Ÿè½½å‡è¡¡å™¨çš„å­˜å–å¤–ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆå…·ä½“çš„å®ç°ã€‚å¥½äº†ï¼Œä¸‹é¢æ¥çœ‹çœ‹IRuleæ¥å£æœ‰å“ªäº›å…·ä½“çš„å®ç°ç±»ï¼š</p><p><img src="/assets/image-20220612215843204-41523c56.png" alt="image-20220612215843204"></p><h3 id="è´Ÿè½½å‡è¡¡ç­–ç•¥æ¦‚è¿°" tabindex="-1"><a class="header-anchor" href="#è´Ÿè½½å‡è¡¡ç­–ç•¥æ¦‚è¿°" aria-hidden="true">#</a> è´Ÿè½½å‡è¡¡ç­–ç•¥æ¦‚è¿°</h3><ul><li><strong>ClientConfigEnableRoundRobinRule</strong>ï¼š è½®è¯¢</li><li><strong>BestAvailableRule</strong>ï¼šé€‰æ‹©å…·æœ‰æœ€ä½å¹¶å‘è¯·æ±‚çš„æœåŠ¡å™¨ã€‚</li><li><strong>RandomRule</strong>ï¼šéšæœºé€‰æ‹©ä¸€ä¸ªæœåŠ¡å™¨ã€‚</li><li><strong>RoundRobinRule</strong>ï¼šè½®è¯¢é€‰æ‹©æœåŠ¡å™¨ã€‚</li><li><strong>RetryRule</strong>ï¼šå…·å¤‡é‡è¯•æœºåˆ¶çš„è½®è¯¢ã€‚</li><li><strong>WeightedResponseTimeRule</strong>ï¼šæ ¹æ®ä½¿ç”¨å¹³å‡å“åº”æ—¶é—´å»åˆ†é…ä¸€ä¸ªweightï¼ˆæƒé‡ï¼‰ ï¼Œweightè¶Šä½ï¼Œè¢«é€‰æ‹©çš„å¯èƒ½æ€§å°±è¶Šä½ã€‚</li><li><strong>ZoneAvoidanceRule</strong>ï¼šæ ¹æ®åŒºåŸŸå’Œå¯ç”¨æ€§ç­›é€‰ï¼Œå†è½®è¯¢é€‰æ‹©æœåŠ¡å™¨ã€‚</li></ul><p>ä¸‹é¢ä¾æ¬¡ä»‹ç»æ²¡æ³•è´Ÿè½½å‡è¡¡å™¨çš„å®ç°ã€‚</p><h3 id="randomrule" tabindex="-1"><a class="header-anchor" href="#randomrule" aria-hidden="true">#</a> RandomRule</h3><p>éšæœºé€‰æ‹©ï¼Œè¿™ä¸ªç­–ç•¥åœ¨å®ç°ä¸Šæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å…ˆè·å–æœåŠ¡åˆ—è¡¨ï¼Œé€šè¿‡<code>ThreadLocalRandom</code>ç”Ÿæˆä¸€ä¸ªserveræ•°é‡ä»¥å†…çš„éšæœºæ•°ï¼Œç„¶ååˆ¤æ–­ä¸€ä¸‹å¯¹åº”çš„serveræ˜¯å¦å­˜æ´»ï¼Œå¦‚æœå­˜æ´»ï¼Œå°±ç›´æ¥è¿”å›ã€‚å¦‚æœæœåŠ¡å·²ç»downæ‰äº†ï¼Œå°±å¾ªç¯è¿™ä¸ªè¿‡ç¨‹</p><p>ä¸‹é¢æ¥çœ‹ä¸€ä¸‹æ ¸å¿ƒæºç å®ç°ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RandomRule</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLoadBalancerRule</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/** ä»å­˜æ´»çš„æœåŠ¡ä¸­éšæœºé€‰æ‹©ä¸€ä¸ª */</span>
    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lb <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Server</span> server <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// è·å–å­˜æ´»çš„æœåŠ¡åˆ—è¡¨</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> upList <span class="token operator">=</span> lb<span class="token punctuation">.</span><span class="token function">getReachableServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è·å–æ‰€æœ‰æœåŠ¡åˆ—è¡¨</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> allList <span class="token operator">=</span> lb<span class="token punctuation">.</span><span class="token function">getAllServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">int</span> serverCount <span class="token operator">=</span> allList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>serverCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment">// æ²¡æœ‰æœåŠ¡ï¼Œè¿”å›null</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			<span class="token comment">// äº§ç”Ÿä¸€ä¸ªéšæœºæ•°</span>
            <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token function">chooseRandomInt</span><span class="token punctuation">(</span>serverCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            server <span class="token operator">=</span> upList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/*serverä¸ºç©ºï¼Œå¯èƒ½æ˜¯è¯¥æœåŠ¡å·²ç»ä¸å¯ç”¨äº†ï¼Œç»§ç»­é€‰æ‹© */</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             	<span class="token comment">// serverä¸ºå­˜æ´»çŠ¶æ€ï¼Œç›´æ¥è¿”å›</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// åˆ°è¿™é‡Œè¯´æ˜serverå·²ç»ä¸å¯æ‰“äº†ï¼Œè®¾ç½®ä¸ºnull</span>
            server <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> server<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// ç”¨æ¥äº§ç”Ÿéšæœºæ•°</span>
    <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">chooseRandomInt</span><span class="token punctuation">(</span><span class="token keyword">int</span> serverCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>serverCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="roundrobinrule" tabindex="-1"><a class="header-anchor" href="#roundrobinrule" aria-hidden="true">#</a> RoundRobinRule</h3><p>è½®è¯¢æ¨¡å¼ï¼Œä½¿ç”¨ä¸€ä¸ªæ•´æ•°ä¸serveråˆ—è¡¨çš„é•¿åº¦è¿›è¡Œå–ä½™ï¼Œæ¥å®Œæˆè½®è¯¢æ“ä½œã€‚è½®è¯¢æˆåŠŸï¼Œå¯¹æ•´æ•°è¿›è¡ŒåŠ 1æ“ä½œã€‚ä¸‹é¢æ¥çœ‹ä¸€ä¸‹æºç å®ç°ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RoundRobinRule</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLoadBalancerRule</span> <span class="token punctuation">{</span>
	<span class="token comment">// é€šè¿‡è¿™ä¸ªå˜é‡è‡ªå¢ï¼Œä¸serveræ•°é‡å–æ¨¡ï¼Œæ¥å®Œæˆè½®è¯¢é€»è¾‘</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> nextServerCyclicCounter<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RoundRobinRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nextServerCyclicCounter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">RoundRobinRule</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setLoadBalancer</span><span class="token punctuation">(</span>lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// è¿™é‡Œæ˜¯æ ¸å¿ƒå®ç°</span>
    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lb <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;no load balancer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Server</span> server <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> count<span class="token operator">++</span> <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è·å–å¯ç”¨çš„æœåŠ¡åˆ—è¡¨</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> reachableServers <span class="token operator">=</span> lb<span class="token punctuation">.</span><span class="token function">getReachableServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è·å–å…¨éƒ¨æœåŠ¡åˆ—è¡¨</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> allServers <span class="token operator">=</span> lb<span class="token punctuation">.</span><span class="token function">getAllServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> upCount <span class="token operator">=</span> reachableServers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> serverCount <span class="token operator">=</span> allServers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// é¦–å…ˆåˆ¤æ–­æ˜¯å¦æœ‰å¯ç”¨çš„æœåŠ¡</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>upCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>serverCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;No up servers available from load balancer: &quot;</span> <span class="token operator">+</span> lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// é€šè¿‡è‡ªå¢å–æ¨¡ï¼Œæ¥è·å–ä¸‹ä¸€ä¸ªserver</span>
            <span class="token keyword">int</span> nextServerIndex <span class="token operator">=</span> <span class="token function">incrementAndGetModulo</span><span class="token punctuation">(</span>serverCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            server <span class="token operator">=</span> allServers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>nextServerIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/* server ä¸ºnull è¯´æ˜è¯¥æœåŠ¡å¯èƒ½å‡ºé—®é¢˜äº† */</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			<span class="token comment">// æ£€æŸ¥serveræ˜¯å¦å­˜æ´»ï¼Œå¹¶ä¸”ä¸ºæä¾›æœåŠ¡åšå¥½å‡†å¤‡</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">isReadyToServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// serverå·²æ­»ï¼Œç½®ç©º</span>
            server <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// è½®è¯¢å¤§äº10æ¬¡æ‰“å°ä¸€ä¸ªwarningæ—¥å¿—ã€‚</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;No available alive servers after 10 tries from load balancer: &quot;</span> <span class="token operator">+</span> lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> server<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * è·å–ä¸‹ä¸€ä¸ªserverçš„indexï¼Œè¿™é‡Œä½¿ç”¨CAS+æ­»å¾ªç¯çš„æ–¹å¼ä¿è¯å¹¶å‘å®‰å…¨ã€‚
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">incrementAndGetModulo</span><span class="token punctuation">(</span><span class="token keyword">int</span> modulo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> current <span class="token operator">=</span> nextServerCyclicCounter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> next <span class="token operator">=</span> <span class="token punctuation">(</span>current <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> modulo<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nextServerCyclicCounter<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> next<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="retryrule" tabindex="-1"><a class="header-anchor" href="#retryrule" aria-hidden="true">#</a> RetryRule</h3><p>é‡è¯•ç­–ç•¥ï¼Œé’ˆå¯¹ç°æœ‰è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œæ·»åŠ é‡è¯•é€»è¾‘ã€‚è¯¥ç­–ç•¥çš„é»˜è®¤è´Ÿè½½é€»è¾‘æ˜¯è½®è¯¢ï¼Œå¯ä»¥é€šè¿‡setæ–¹æ³•æˆ–æ„é€ æ–¹æ³•è¿›è¡Œä¿®æ”¹ã€‚åœ¨ç»™å®šçš„æ—¶é—´å†…æ— é™æ¬¡é‡è¯•ã€‚</p><p>ä¸‹é¢æ¥çœ‹çœ‹æ ¸å¿ƒæºç å®ç°(çœç•¥äº†ä¸€ä¸‹ä¸é‡è¦çš„é€»è¾‘)ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RetryRule</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLoadBalancerRule</span> <span class="token punctuation">{</span>
    <span class="token comment">// é»˜è®¤çš„çº§è”ç­–ç•¥æ˜¯ è½®è¯¢ç­–ç•¥ï¼Œè¯¥å‚æ•°å¯ä»¥é€šè¿‡æ„é€ å‡½æ•°æˆ–setæ–¹æ³•è¿›è¡Œè®¾ç½®</span>
	<span class="token class-name">IRule</span> subRule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RoundRobinRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æœ€å¤§é‡è¯•æ¯«ç§’æ•°ï¼Œå½“æ€»çš„æ‰§è¡Œæ—¶é—´è¶…è¿‡500æ¯«ç§’åï¼Œåœæ­¢é‡è¯•ã€‚é»˜è®¤500æ¯«ç§’</span>
	<span class="token keyword">long</span> maxRetryMillis <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>

	<span class="token comment">/* é€‰æ‹©ä¸€ä¸ªserver*/</span>
	<span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// é‡è¯•å¼€å§‹æ—¶é—´</span>
		<span class="token keyword">long</span> requestTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// é‡è¯•æˆªæ­¢æ—¶é—´</span>
		<span class="token keyword">long</span> deadline <span class="token operator">=</span> requestTime <span class="token operator">+</span> maxRetryMillis<span class="token punctuation">;</span>

		<span class="token class-name">Server</span> answer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token comment">// é¦–å…ˆä½¿ç”¨çº§è”çš„ç­–ç•¥é€‰æ‹©è´Ÿè½½ç­–ç•¥</span>
		answer <span class="token operator">=</span> subRule<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// å¦‚æœansweræ— æ•ˆ å¹¶ä¸” æœªåˆ°deadlineï¼Œæ‰§è¡Œé‡è¯•é€»è¾‘</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>answer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>answer<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> deadline<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">InterruptTask</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InterruptTask</span><span class="token punctuation">(</span>deadline <span class="token operator">-</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// åªè¦æ‰§è¡Œæ—¶é—´ä¸ºè¶…è¿‡ maxRetryMillis, å°±æ— é™æ¬¡é‡è¯•ã€‚</span>
			<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				answer <span class="token operator">=</span> subRule<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>answer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>answer<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> deadline<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">/* è®©å‡ºcpu */</span>
					<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			task<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>answer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>answer<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> answer<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="clientconfigenabledroundrobinrule" tabindex="-1"><a class="header-anchor" href="#clientconfigenabledroundrobinrule" aria-hidden="true">#</a> ClientConfigEnabledRoundRobinRule</h3><p>è¯¥è´Ÿè½½å‡è¡¡ç­–ç•¥å†…éƒ¨ä½¿ç”¨çš„æ˜¯è½®è¯¢ç­–ç•¥ã€‚è¿™é‡Œæ²¡ä»€ä¹ˆå¥½è¯´çš„ã€‚è¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªç»„åˆæ¨¡å¼</p><p>ä¸‹é¢çœ‹çœ‹æºç å®ç°ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClientConfigEnabledRoundRobinRule</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLoadBalancerRule</span> <span class="token punctuation">{</span>

    <span class="token class-name">RoundRobinRule</span> roundRobinRule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RoundRobinRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initWithNiwsConfig</span><span class="token punctuation">(</span><span class="token class-name">IClientConfig</span> clientConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        roundRobinRule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RoundRobinRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLoadBalancer</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setLoadBalancer</span><span class="token punctuation">(</span>lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	roundRobinRule<span class="token punctuation">.</span><span class="token function">setLoadBalancer</span><span class="token punctuation">(</span>lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>roundRobinRule <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> roundRobinRule<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;This class has not been initialized with the RoundRobinRule class&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="weightedresponsetimerule" tabindex="-1"><a class="header-anchor" href="#weightedresponsetimerule" aria-hidden="true">#</a> WeightedResponseTimeRule</h3><p>ä»¥å“åº”æ—¶é—´ä½œä¸ºæƒé‡ï¼Œè¿›è¡Œè´Ÿè½½åˆ†é…ã€‚è¿™é‡Œå…ˆä»‹ç»ä¸€äº›ç®—æ³•çš„å®ç°ï¼Œç„¶ååœ¨çœ‹ä»£ç å°±å¾ˆå¥½ç†è§£äº†ã€‚</p><p>å‡è®¾æœ‰Aã€Bã€Cã€Dç¬¬ä¸ªå®ä¾‹ï¼Œå¹³å‡å“åº”æ—¶é—´æ˜¯10,20,30,50ï¼Œç›¸åŠ å¾—åˆ°çš„æ€»å“åº”æ—¶é—´æ˜¯100ã€‚æ¯ä¸ªå®ä¾‹çš„æƒé‡æ˜¯æ€»å“åº”æ—¶é—´-è‡ªèº«å“åº”æ—¶é—´ï¼Œå¯å¾—å¦‚ä¸‹ï¼š</p><ul><li>Aï¼š100 - 10 = 90ï¼›</li><li>Bï¼š90 + 100 - 20 = 170ï¼›</li><li>Cï¼š170 + 100 - 30 = 240ï¼›</li><li>Dï¼š 240 + 100 - 50 = 290ï¼›</li></ul><p>åˆ™æ¯ä¸ªå®ä¾‹çš„æƒé‡ç©ºé—´ä¸ºï¼š</p><ul><li>Aï¼š[0, 90]</li><li>Bï¼š[90, 170]</li><li>Cï¼š[170, 240]</li><li>Dï¼š[240, 290]</li></ul><p>åœ¨è·å–å®ä¾‹çš„æ—¶å€™ï¼Œé€šè¿‡290ä¹˜ä»¥ä¸€ä¸ª0åˆ°1ç›´æ¥çš„éšæœºæ•°ï¼Œè¿™ä¸ªéšæœºæ•°è½åˆ°é‚£ä¸ªåŒºé—´ï¼Œå°±é€‰å–é‚£ä¸ªå®ä¾‹ã€‚å¥½äº†ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è®¡ç®—æƒé‡çš„æºç å®ç°ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeightedResponseTimeRule</span> <span class="token keyword">extends</span> <span class="token class-name">RoundRobinRule</span> <span class="token punctuation">{</span>
	<span class="token comment">// å®šæ—¶ä»»åŠ¡çš„é»˜è®¤é—´éš”æ—¶é—´é—´éš”æ—¶é—´</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_TIMER_INTERVAL</span> <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token comment">// å®šæ—¶ä»»åŠ¡çš„æ—¶é—´é—´éš”</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> serverWeightTaskTimerInterval <span class="token operator">=</span> <span class="token constant">DEFAULT_TIMER_INTERVAL</span><span class="token punctuation">;</span>
    <span class="token comment">// å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨</span>
    <span class="token keyword">protected</span> <span class="token class-name">Timer</span> serverWeightTimer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    
    <span class="token comment">// è®¾ç½®è´Ÿè½½å‡è¡¡å™¨</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLoadBalancer</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setLoadBalancer</span><span class="token punctuation">(</span>lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lb <span class="token keyword">instanceof</span> <span class="token class-name">BaseLoadBalancer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            name <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BaseLoadBalancer</span><span class="token punctuation">)</span> lb<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">initialize</span><span class="token punctuation">(</span>lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>serverWeightTimer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            serverWeightTimer<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// åˆå§‹åŒ–ä¸€ä¸ªå®šæ—¶è°ƒåº¦å™¨</span>
        serverWeightTimer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Timer</span><span class="token punctuation">(</span><span class="token string">&quot;NFLoadBalancer-serverWeightTimer-&quot;</span> <span class="token operator">+</span> name<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æäº¤å®šæ—¶ä»»åŠ¡</span>
        serverWeightTimer<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DynamicServerWeightTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> serverWeightTaskTimerInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åˆå§‹åŒ–è¿è¡Œ</span>
        <span class="token class-name">ServerWeight</span> sw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerWeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sw<span class="token punctuation">.</span><span class="token function">maintainWeights</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// åœæ­¢ä»»åŠ¡çš„é’©å­æ–¹æ³•</span>
        <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addShutdownHook</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Stopping NFLoadBalancer-serverWeightTimer-&quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                serverWeightTimer<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// å®šæ—¶ä»»åŠ¡ç±»</span>
    <span class="token keyword">class</span> <span class="token class-name">DynamicServerWeightTask</span> <span class="token keyword">extends</span> <span class="token class-name">TimerTask</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ServerWeight</span> serverWeight <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerWeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                serverWeight<span class="token punctuation">.</span><span class="token function">maintainWeights</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error running DynamicServerWeightTask for {}&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// è¿™é‡Œå°±æ˜¯å…·ä½“è®¡ç®—æƒé‡çš„ç±»äº†ã€‚</span>
    <span class="token keyword">class</span> <span class="token class-name">ServerWeight</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">maintainWeights</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ILoadBalancer</span> lb <span class="token operator">=</span> <span class="token function">getLoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lb <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// é€šè¿‡casæ¥åŠ é”</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>serverWeightAssignmentInProgress<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span> 
            <span class="token punctuation">}</span>
            
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">AbstractLoadBalancer</span> nlb <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AbstractLoadBalancer</span><span class="token punctuation">)</span> lb<span class="token punctuation">;</span>
                <span class="token class-name">LoadBalancerStats</span> stats <span class="token operator">=</span> nlb<span class="token punctuation">.</span><span class="token function">getLoadBalancerStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>stats <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">double</span> totalResponseTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token comment">// å¯¹æ‰€æœ‰æœåŠ¡çš„å¹³å‡å“åº”æ—¶é—´æ±‚å’Œ</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Server</span> server <span class="token operator">:</span> nlb<span class="token punctuation">.</span><span class="token function">getAllServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">ServerStats</span> ss <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">getSingleServerStat</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    totalResponseTime <span class="token operator">+=</span> ss<span class="token punctuation">.</span><span class="token function">getResponseTimeAvg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">Double</span> weightSoFar <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
                <span class="token comment">// è®¡ç®—æƒé‡</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> finalWeights <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Server</span> server <span class="token operator">:</span> nlb<span class="token punctuation">.</span><span class="token function">getAllServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">ServerStats</span> ss <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">getSingleServerStat</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">double</span> weight <span class="token operator">=</span> totalResponseTime <span class="token operator">-</span> ss<span class="token punctuation">.</span><span class="token function">getResponseTimeAvg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    weightSoFar <span class="token operator">+=</span> weight<span class="token punctuation">;</span>
                    finalWeights<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>weightSoFar<span class="token punctuation">)</span><span class="token punctuation">;</span>   
                <span class="token punctuation">}</span>
                <span class="token function">setWeights</span><span class="token punctuation">(</span>finalWeights<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error calculating server weights&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                serverWeightAssignmentInProgress<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‹é¢æ¥çœ‹æœåŠ¡é€‰æ‹©çš„æºç å®ç°ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeightedResponseTimeRule</span> <span class="token keyword">extends</span> <span class="token class-name">RoundRobinRule</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lb <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Server</span> server <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å®šæ—¶ä»»åŠ¡è®¡ç®—å‡ºçš„æƒé‡åˆ—è¡¨</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> currentWeights <span class="token operator">=</span> accumulatedWeights<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> allList <span class="token operator">=</span> lb<span class="token punctuation">.</span><span class="token function">getAllServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> serverCount <span class="token operator">=</span> allList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>serverCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">int</span> serverIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment">// è·å–åˆ°æƒé‡çš„æœ€å¤§å€¼</span>
            <span class="token keyword">double</span> maxTotalWeight <span class="token operator">=</span> currentWeights<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> currentWeights<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>currentWeights<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token comment">// åˆ¤æ–­æƒé‡æ˜¯å¦æœ‰æ•ˆï¼Œ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>maxTotalWeight <span class="token operator">&lt;</span> <span class="token number">0.001d</span> <span class="token operator">||</span> serverCount <span class="token operator">!=</span> currentWeights<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å¦‚æœæƒé‡ä¸å¯ç”¨çš„è¯ï¼Œè¿™é‡Œé€‰æ‹©è½®è¯¢ç­–ç•¥</span>
                server <span class="token operator">=</span>  <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span><span class="token function">getLoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> server<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// è¿™é‡Œè®¡ç®—æƒé‡ï¼Œä½¿ç”¨æœ€å¤§æ•°ä¹˜ä»¥ä¸€ä¸ª0åˆ°1ç›´æ¥çš„éšæœºå€¼ï¼Œç»“æœè½åˆ°é‚£ä¸ªåŒºé—´ï¼Œå°±é€‰å–åŒºé—´å¯¹åº”çš„å®ä¾‹</span>
                <span class="token keyword">double</span> randomWeight <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> maxTotalWeight<span class="token punctuation">;</span>
                <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Double</span> d <span class="token operator">:</span> currentWeights<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>d <span class="token operator">&gt;=</span> randomWeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        serverIndex <span class="token operator">=</span> n<span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        n<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                server <span class="token operator">=</span> allList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>serverIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			<span class="token comment">// è€å¥—è·¯ï¼Œå¦‚æœserver ä¸ºnull å°±å†æ¥ä¸€é</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// å¦‚æœserver å­˜æ´»ç€ï¼Œç›´æ¥è¿”å›</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// åˆ°è¿™é‡Œï¼Œè¯´æ˜serverå·²ç»æ­»äº†ã€‚è®¾ä¸ºnull</span>
            server <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> server<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>   
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="bestavailablerule" tabindex="-1"><a class="header-anchor" href="#bestavailablerule" aria-hidden="true">#</a> BestAvailableRule</h3><p>è¯¥ç­–ç•¥ä¼šé€‰æ‹©ä¸€ä¸ªå“åº”æœ€å¿«çš„serverè¿”å›ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BestAvailableRule</span> <span class="token keyword">extends</span> <span class="token class-name">ClientConfigEnabledRoundRobinRule</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">LoadBalancerStats</span> loadBalancerStats<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loadBalancerStats <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> serverList <span class="token operator">=</span> <span class="token function">getLoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAllServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> minimalConcurrentConnections <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> currentTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Server</span> chosen <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Server</span> server<span class="token operator">:</span> serverList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ServerStats</span> serverStats <span class="token operator">=</span> loadBalancerStats<span class="token punctuation">.</span><span class="token function">getSingleServerStat</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>serverStats<span class="token punctuation">.</span><span class="token function">isCircuitBreakerTripped</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> concurrentConnections <span class="token operator">=</span> serverStats<span class="token punctuation">.</span><span class="token function">getActiveRequestsCount</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>concurrentConnections <span class="token operator">&lt;</span> minimalConcurrentConnections<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    minimalConcurrentConnections <span class="token operator">=</span> concurrentConnections<span class="token punctuation">;</span>
                    chosen <span class="token operator">=</span> server<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>chosen <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> chosen<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLoadBalancer</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setLoadBalancer</span><span class="token punctuation">(</span>lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lb <span class="token keyword">instanceof</span> <span class="token class-name">AbstractLoadBalancer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            loadBalancerStats <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractLoadBalancer</span><span class="token punctuation">)</span> lb<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLoadBalancerStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="zoneavoidancerule" tabindex="-1"><a class="header-anchor" href="#zoneavoidancerule" aria-hidden="true">#</a> ZoneAvoidanceRule</h3><p>è¿™ä¸ªæ˜¯Ribbonä¸­æœ€é‡è¦çš„ä¸€ä¸ªè´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œè¯¥ç­–ç•¥æ˜¯Spring Cloudè‡ªåŠ¨è£…é…æ˜¯çš„é»˜è®¤é€‰é¡¹ã€‚</p><p>è¯¥ç±»ç»§æ‰¿è‡ª<code>PredicateBasedRule</code>ï¼Œè€è§„çŸ©ï¼Œå…ˆæ¥çœ‹çœ‹çˆ¶ç±»çš„å®šä¹‰ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">PredicateBasedRule</span> <span class="token keyword">extends</span> <span class="token class-name">ClientConfigEnabledRoundRobinRule</span> <span class="token punctuation">{</span>
   
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">AbstractServerPredicate</span> <span class="token function">getPredicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ILoadBalancer</span> lb <span class="token operator">=</span> <span class="token function">getLoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ³¨æ„ getPredicate() æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•</span>
        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> server <span class="token operator">=</span> <span class="token function">getPredicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chooseRoundRobinAfterFiltering</span><span class="token punctuation">(</span>lb<span class="token punctuation">.</span><span class="token function">getAllServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> server<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>       
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯¥ç±»é‡å†™äº†chooseæ–¹æ³•ï¼Œåœ¨æ–¹æ³•ä¸­è°ƒç”¨äº†<code>AbstractServerPredicate#chooseRoundRobinAfterFiltering</code>æ–¹æ³•ï¼Œæ¥çœ‹çœ‹è¿™ä¸ªæºç ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// AbstractServerPredicate#chooseRoundRobinAfterFiltering</span>
<span class="token keyword">public</span> <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token function">chooseRoundRobinAfterFiltering</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> servers<span class="token punctuation">,</span> <span class="token class-name">Object</span> loadBalancerKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–ç¬¦åˆæ¡ä»¶çš„serveré›†åˆ</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> eligible <span class="token operator">=</span> <span class="token function">getEligibleServers</span><span class="token punctuation">(</span>servers<span class="token punctuation">,</span> loadBalancerKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>eligible<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">absent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è¿™é‡Œå®ç°äº†ä¸€ä¸ªè½®è¯¢åŠŸèƒ½</span>
    <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>eligible<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token function">incrementAndGetModulo</span><span class="token punctuation">(</span>eligible<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// è½®è¯¢çš„å…·ä½“å®ç°</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">incrementAndGetModulo</span><span class="token punctuation">(</span><span class="token keyword">int</span> modulo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> current <span class="token operator">=</span> nextIndex<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> next <span class="token operator">=</span> <span class="token punctuation">(</span>current <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> modulo<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextIndex<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> current <span class="token operator">&lt;</span> modulo<span class="token punctuation">)</span>
            <span class="token keyword">return</span> current<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°è¯¥æ–¹æ³•é¦–å…ˆè°ƒç”¨<code>getEligibleServers</code>æ–¹æ³•è¿‡æ»¤å‡ºåˆé€‚çš„serveråˆ—è¡¨ï¼Œç„¶åé€šè¿‡ä¸€ä¸ªç®€å•çš„è½®è¯¢æ¥é€‰æ‹©äº†ä¸€ä¸ªserverè¿›è¡Œè¿”å›ï¼Œé‚£ä¹ˆè¿™ä¸ªç¬¦åˆæ¡ä»¶çš„serveré›†åˆæ˜¯å¦‚ä½•é€‰å‡ºçš„å‘¢ï¼Ÿä¸‹é¢æ¥çœ‹çœ‹ä»£ç ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// AbstractServerPredicate#getEligibleServers</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> serverOnlyPredicate <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Server</span> input<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    
        <span class="token keyword">return</span> <span class="token class-name">AbstractServerPredicate</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PredicateKey</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token function">getEligibleServers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> servers<span class="token punctuation">,</span> <span class="token class-name">Object</span> loadBalancerKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>loadBalancerKey <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ImmutableList</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span><span class="token class-name">Iterables</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>servers<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getServerOnlyPredicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> results <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Server</span> server<span class="token operator">:</span> servers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PredicateKey</span><span class="token punctuation">(</span>loadBalancerKey<span class="token punctuation">,</span> server<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                results<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> results<span class="token punctuation">;</span>            
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token function">getServerOnlyPredicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> serverOnlyPredicate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è§‚å¯Ÿä¸Šé¢çš„æ–¹æ³•ï¼Œä¸ç®¡loadBalancerKeyæ˜¯å¦ä¸ºnullï¼Œæœ€åéƒ½æ˜¯æŠŠserverå°è£…åˆ°PredicateKeyçš„å®ä¾‹ä¸­(åŒºåˆ«åœ¨äºå¦‚æœloadBalancerKeyä¸ä¸ºnullçš„è¯ï¼Œä¼šæŠŠloadBalancerKeyä¹Ÿå°è£…åˆ°PredicateKeyä¸­)ï¼Œç„¶åè°ƒç”¨this.apply()æ–¹æ³•è¿›è¡Œåˆ¤æ–­ï¼Œä½†æ˜¯applyæ–¹æ³•ï¼Œåœ¨è¿™ä¸ªç±»ä¸­å¹¶æ²¡æœ‰å®ç°ï¼Œæ‰€ä»¥è¿™ä¸ªä»»åŠ¡å°±è½åˆ°å­ç±»ä¸­ã€‚ä¸‹é¢æ¥çœ‹çœ‹AbstractServerPredicateçš„å®ç°ç±»å›¾ï¼š</p><p><img src="/assets/image-20220706102437731-5db46389.png" alt="image-20220706102437731"></p><p>è¿™é‡Œå°±ä¸å–å…³å­äº†ï¼Œåœ¨ZoneAvoidanceRuleä¸­ï¼Œä½¿ç”¨äº†ZoneAvoidancePredicateå’ŒAvailabilityPredicateä¸¤ä¸ªå®ç°ç±»ï¼Œå¦å¤–ä¹Ÿä½¿ç”¨äº†ä¸€ä¸ªåœ¨AbstractServerPredicateå†…éƒ¨å®ç°çš„å†…éƒ¨ç±»ã€‚</p><p>CompositePredicateæ˜¯ä¸€ä¸ªç»„åˆæ¨¡å¼çš„å®ç°</p><p>ZoneAffinityPredicateåœ¨æœåŠ¡åˆ—è¡¨è¿‡æ»¤å™¨ä¸­æœ‰ä½¿ç”¨åˆ°ï¼Œå…·ä½“çš„ä¿¡æ¯å¯ä»¥å‚è€ƒè¿‡æ»¤å™¨ZoneAffinityServerListFilterã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹ZoneAvoidanceRuleæ˜¯å¦‚ä½•ä½¿ç”¨Predicateçš„ã€‚é¦–å…ˆæ¥çœ‹çœ‹æ„é€ å‡½æ•°ä»¥åŠæŠ½è±¡å®ç°æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZoneAvoidanceRule</span> <span class="token keyword">extends</span> <span class="token class-name">PredicateBasedRule</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">// ç»„åˆæ¨¡å¼</span>
    <span class="token keyword">private</span> <span class="token class-name">CompositePredicate</span> compositePredicate<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">ZoneAvoidanceRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ZoneAvoidancePredicate</span> zonePredicate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZoneAvoidancePredicate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AvailabilityPredicate</span> availabilityPredicate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AvailabilityPredicate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        compositePredicate <span class="token operator">=</span> <span class="token function">createCompositePredicate</span><span class="token punctuation">(</span>zonePredicate<span class="token punctuation">,</span> availabilityPredicate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token class-name">CompositePredicate</span> <span class="token function">createCompositePredicate</span><span class="token punctuation">(</span><span class="token class-name">ZoneAvoidancePredicate</span> p1<span class="token punctuation">,</span> <span class="token class-name">AvailabilityPredicate</span> p2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// åœ¨è¿™é‡Œæ„é€ æˆæœ€ç»ˆä½¿ç”¨çš„Predicate</span>
        <span class="token keyword">return</span> <span class="token class-name">CompositePredicate</span><span class="token punctuation">.</span><span class="token function">withPredicates</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">)</span>
                             <span class="token punctuation">.</span><span class="token function">addFallbackPredicate</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span>
                             <span class="token punctuation">.</span><span class="token function">addFallbackPredicate</span><span class="token punctuation">(</span><span class="token class-name">AbstractServerPredicate</span><span class="token punctuation">.</span><span class="token function">alwaysTrue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                             <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">AbstractServerPredicate</span> <span class="token function">getPredicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> compositePredicate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å†æ¥çœ‹çœ‹CompositePredicateçš„æ ¸å¿ƒä»£ç å®ç°ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CompositePredicate</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractServerPredicate</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">AbstractServerPredicate</span> delegate<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractServerPredicate</span><span class="token punctuation">&gt;</span></span> fallbacks <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token keyword">private</span> <span class="token keyword">int</span> minimalFilteredServers <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">float</span> minimalFilteredPercentage <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">PredicateKey</span> input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> delegate<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token function">getEligibleServers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> servers<span class="token punctuation">,</span> <span class="token class-name">Object</span> loadBalancerKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getEligibleServers</span><span class="token punctuation">(</span>servers<span class="token punctuation">,</span> loadBalancerKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractServerPredicate</span><span class="token punctuation">&gt;</span></span> i <span class="token operator">=</span> fallbacks<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> minimalFilteredServers <span class="token operator">&amp;&amp;</span> result<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>servers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> minimalFilteredPercentage<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> i<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">AbstractServerPredicate</span> predicate <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> predicate<span class="token punctuation">.</span><span class="token function">getEligibleServers</span><span class="token punctuation">(</span>servers<span class="token punctuation">,</span> loadBalancerKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ°è¿™é‡ŒZoneAvoidanceRuleçš„å®ç°æµç¨‹å¤§è‡´å°±æ¸…æ™°äº†ã€‚é¦–å…ˆè°ƒç”¨æœåŠ¡é€‰æ‹©ä¼šä»choseæ–¹æ³•è¿›å…¥ï¼Œåœ¨choseæ–¹æ³•ä¸­æœ‰è¿™æ ·ä¸€æ¡è¯­å¥ï¼Œ<code>getPredicate().chooseRoundRobinAfterFiltering(lb.getAllServers(), key);</code>ï¼Œè¿™é‡Œä¼šè¿”å›CompositePredicateå¯¹è±¡ï¼Œé‡Œé¢ç»„åˆäº†ä¸¤ä¸ªPredicateï¼Œåˆ†åˆ«æ˜¯ZoneAvoidancePredicateå’ŒAvailabilityPredicateï¼Œç„¶åè°ƒç”¨CompositePredicateä¸­çš„è¿‡æ»¤æ–¹æ³•ï¼Œæœ€ç»ˆä¼šé€šè¿‡è¿™ä¸¤ä¸ªPredicateä¸­çš„applyæ–¹æ³•è¿›è¡Œåˆ¤å®šã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å°±æ­£å¼æ¥åˆ†æè¿‡æ»¤é€»è¾‘</p><p><strong>ZoneAvoidancePredicate</strong></p><p><strong>AvailabilityPredicate</strong></p><h2 id="spring-cloud-ribbonçš„å¿ƒè·³æ£€æµ‹æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ribbonçš„å¿ƒè·³æ£€æµ‹æœºåˆ¶" aria-hidden="true">#</a> Spring Cloud Ribbonçš„å¿ƒè·³æ£€æµ‹æœºåˆ¶</h2><p><code>IPing</code>æ˜¯å¿ƒè·³æ£€æµ‹çš„é¡¶çº§å®šä¹‰æ¥å£ï¼Œä¸‹é¢å…ˆçœ‹çœ‹æ¥å£å®šä¹‰ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IPing</span> <span class="token punctuation">{</span>   
    <span class="token doc-comment comment">/** æ£€æŸ¥ç»™å®šçš„æœåŠ¡æ˜¯å¦å¤„äºå­˜æ´»çŠ¶æ€ï¼Œå³åœ¨è´Ÿè½½å¹³è¡¡æ—¶å°†å…¶è§†ä¸ºå€™é€‰å¯¹è±¡ */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token class-name">Server</span> server<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œçš„å®šä¹‰ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯æ£€æŸ¥ç»™å®šçš„æœåŠ¡æ˜¯å¦å­˜æ´»ã€‚ä¸‹é¢æ¥çœ‹çœ‹ç±»çš„å®ç°ç±»å›¾ï¼š</p><img src="/assets/image-20220628151228285-69b0d791.png" alt="image-20220628151228285" style="zoom:67%;"><ul><li>NoOpPingï¼š ä»€ä¹ˆéƒ½ä¸åš</li><li>PingConstantï¼šé€šè¿‡é…ç½®å‚æ•°è®¾ç½®æœåŠ¡å­˜æ´»çŠ¶æ€</li><li>DummyPingï¼š æ€»æ˜¯è®¤ä¸ºå­˜æ´»</li><li>PingUrlï¼šä½¿ç”¨HttpClientæ„é€ ä¸€ä¸ªHttpRequestï¼Œå‘èµ·ä¸€ä¸ªGetè°ƒç”¨ï¼Œå¦‚æœæˆåŠŸï¼Œè¯æ˜æœåŠ¡å­˜æ´»</li></ul><p>ä¸‹é¢å°±å¼€å§‹ä¸€ä¸€è§£æ</p><h3 id="noopping" tabindex="-1"><a class="header-anchor" href="#noopping" aria-hidden="true">#</a> NoOpPing</h3><p>ä»å­—é¢ä¸Šç†è§£ï¼Œno operation ping ï¼Œå°±æ˜¯ä¸åšä»»ä½•æ“ä½œã€‚è¿™ä¸ªæ˜¯Ribbonä¸­æœ€ç®€å•çš„å®ç°ï¼ŒåŸºæœ¬ä¸Šæ²¡ä»€ä¹ˆç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NoOpPing</span> <span class="token keyword">implements</span> <span class="token class-name">IPing</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token class-name">Server</span> server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="pingurl" tabindex="-1"><a class="header-anchor" href="#pingurl" aria-hidden="true">#</a> PingUrl</h3><p>è¿™ä¸ªå®ç°ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå¯¹ç»™å®šçš„æœåŠ¡å‘èµ·ä¸€ä¸ªGetè¯·æ±‚ï¼Œç„¶ååˆ¤æ–­å“åº”æ˜¯å¦ä¸º200ï¼Œå“åº”çš„ç»“æœæ˜¯å¦æœåŠ¡é¢„æœŸã€‚å¦‚æœéƒ½ç¬¦åˆï¼Œåˆ™æœåŠ¡ä¸ºå­˜æ´»çŠ¶æ€ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PingUrl</span> <span class="token keyword">implements</span> <span class="token class-name">IPing</span> <span class="token punctuation">{</span>

    <span class="token class-name">String</span> pingAppendString <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
	<span class="token comment">// æ ‡è¯†æ˜¯å¦æ˜¯httpsåè®®ï¼Œæœ‰get/setæ–¹æ³•ï¼Œè¿™é‡Œçœç•¥äº†</span>
    <span class="token keyword">boolean</span> isSecure <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token comment">// é¢„æœŸçš„å“åº”ç»“æœï¼Œæœ‰get/setæ–¹æ³•ï¼Œè¿™é‡Œçœç•¥äº†</span>
    <span class="token class-name">String</span> expectedContent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">PingUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">PingUrl</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isSecure<span class="token punctuation">,</span> <span class="token class-name">String</span> pingAppendString<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isSecure <span class="token operator">=</span> isSecure<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pingAppendString <span class="token operator">=</span> <span class="token punctuation">(</span>pingAppendString <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> pingAppendString <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// æ ¸å¿ƒå®ç°å°±åœ¨è¿™é‡Œäº†</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token class-name">Server</span> server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// åˆ¤æ–­åè®®ç±»å‹ï¼Œæ‹¼æ¥url</span>
        <span class="token class-name">String</span> urlStr   <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isSecure<span class="token punctuation">)</span><span class="token punctuation">{</span>
            urlStr <span class="token operator">=</span> <span class="token string">&quot;https://&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            urlStr <span class="token operator">=</span> <span class="token string">&quot;http://&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        urlStr <span class="token operator">+=</span> server<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        urlStr <span class="token operator">+=</span> <span class="token function">getPingAppendString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> isAlive <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token comment">// æ„é€ HttpRequestï¼Œ å¹¶å‘èµ·è¯·æ±‚</span>
        <span class="token class-name">HttpClient</span> httpClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HttpUriRequest</span> getRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpGet</span><span class="token punctuation">(</span>urlStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> content<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">HttpResponse</span> response <span class="token operator">=</span> httpClient<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>getRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            content <span class="token operator">=</span> <span class="token class-name">EntityUtils</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// åˆ¤æ–­å“åº”ç æ˜¯å¦ä¸º 200</span>
            isAlive <span class="token operator">=</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStatusLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getExpectedContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;content:&quot;</span> <span class="token operator">+</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>content <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    isAlive <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                    <span class="token comment">// åˆ¤æ–­å“åº”ç»“æœæ˜¯å¦å’Œé¢„æœŸä¸€è‡´</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token function">getExpectedContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        isAlive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                        isAlive <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span><span class="token punctuation">{</span>
            <span class="token comment">// Release the connection.</span>
            getRequest<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> isAlive<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="pingconstant" tabindex="-1"><a class="header-anchor" href="#pingconstant" aria-hidden="true">#</a> PingConstant</h3><p>åŸºäºé…ç½®çš„å®ç°ã€‚ä¸çŸ¥é“ä¸ºä»€ä¹ˆè¦æœ‰è¿™ä¹ˆä¸ªå®ç°ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PingConstant</span> <span class="token keyword">implements</span> <span class="token class-name">IPing</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿™ä¸ªç”¨æ¥æ ‡è¯†æ˜¯å¦å­˜æ´»ï¼Œ é€šè¿‡ä»£ç è®¾ç½®</span>
    <span class="token keyword">boolean</span> constant <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token comment">// è®¾ç½®å­˜æ´»çŠ¶æ€</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setConstant</span><span class="token punctuation">(</span><span class="token class-name">String</span> constantStr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        constant <span class="token operator">=</span> <span class="token punctuation">(</span>constantStr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>constantStr<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// è®¾ç½®å­˜æ´»çŠ¶æ€</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setConstant</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> constant<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>constant <span class="token operator">=</span> constant<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token class-name">Server</span> server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> constant<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="dummyping" tabindex="-1"><a class="header-anchor" href="#dummyping" aria-hidden="true">#</a> DummyPing</h3><p>è¯¥æ¥å£ç»§æ‰¿è‡ªAbstractLoadBalancerPingï¼Œ å…¶å®ç°ä¹Ÿå¾ˆç®€å•ï¼Œè®¤ä¸ºæœåŠ¡æ€»æ˜¯å­˜æ´»çŠ¶æ€ã€‚é¦–å…ˆçœ‹ä¸€ä¸‹çˆ¶ç±»çš„å®ç°ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractLoadBalancerPing</span> <span class="token keyword">implements</span> <span class="token class-name">IPing</span><span class="token punctuation">,</span> <span class="token class-name">IClientConfigAware</span><span class="token punctuation">{</span>
    <span class="token class-name">AbstractLoadBalancer</span> lb<span class="token punctuation">;</span>   
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token class-name">Server</span> server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLoadBalancer</span><span class="token punctuation">(</span><span class="token class-name">AbstractLoadBalancer</span> lb<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>lb <span class="token operator">=</span> lb<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>    
    <span class="token keyword">public</span> <span class="token class-name">AbstractLoadBalancer</span> <span class="token function">getLoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> lb<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å†æ¥çœ‹çœ‹è¯¥ç±»çš„å®ç°ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DummyPing</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLoadBalancerPing</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">DummyPing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
	<span class="token comment">// é»˜è®¤è¿”å›trueï¼Œå³æ‰€æœ‰çš„æœåŠ¡éƒ½å­˜æ´»</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token class-name">Server</span> server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initWithNiwsConfig</span><span class="token punctuation">(</span><span class="token class-name">IClientConfig</span> clientConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="spring-cloud-ribbonçš„æœåŠ¡åˆ—è¡¨" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ribbonçš„æœåŠ¡åˆ—è¡¨" aria-hidden="true">#</a> Spring Cloud Ribbonçš„æœåŠ¡åˆ—è¡¨</h2><p>è¯¥ç»„ä»¶ä¸»è¦æä¾›è·å–æœåŠ¡åˆ—è¡¨çš„åŠŸèƒ½ã€‚<code>ServerList</code>æ˜¯æœåŠ¡åˆ—è¡¨ç»„ä»¶çš„é¡¶çº§æ¥å£å®šä¹‰ï¼Œé‡Œè¾¹åªå®šä¹‰äº†ä¸¤ä¸ªæ–¹æ³•ï¼ŒåŒ…æ‹¬è·å–åŸå§‹çš„æœåŠ¡åˆ—è¡¨ï¼Œä»¥åŠæ›´æ–°åçš„æœåŠ¡åˆ—è¡¨ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ServerList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/** è¿”å›åˆè¯•çš„æœåŠ¡åˆ—è¡¨ */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getInitialListOfServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/** è¿”å›æ›´æ–°åçš„æœåŠ¡åˆ—è¡¨ */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUpdatedListOfServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶å®ç°çš„ç±»å›¾å¦‚ä¸‹</p><img src="/assets/image-20220614170722800-3670d6bc.png" alt="image-20220614170722800" style="zoom:67%;"><ul><li><p><strong>StaticServerList</strong>ï¼š é™æ€çš„æœåŠ¡åˆ—è¡¨ç»´æŠ¤ç±»ã€‚è¯´ç™½äº†å°±æ˜¯å†™æ­»çš„ã€‚</p></li><li><p><strong>ConfigurationBasedServerList:</strong> åŸºäºè¯»å–Archaiusé…ç½®æ–‡ä»¶æ¥ç»´æŠ¤ServerList</p></li><li><p><strong>NacosServerListï¼š</strong></p></li></ul><p>è¿™é‡Œè¾¹StaticServerListæ˜¯Spring Cloudæä¾›çš„ä¸€ä¸ªå®ç°ï¼ŒNacosServerListæ˜¯Nacosæä¾›çš„å®ç°ã€‚è€ŒConfigurationBasedServerListæ˜¯Ribbonæä¾›çš„å®ç°ã€‚ä¸‹é¢æˆ‘ä»¬æ¥ä¸€ä¸€è®²è§£ã€‚</p><h3 id="staticserverlist" tabindex="-1"><a class="header-anchor" href="#staticserverlist" aria-hidden="true">#</a> StaticServerList</h3><p>é™æ€æœåŠ¡åˆ—è¡¨ï¼Œè§åçŸ¥æ„ï¼Œè¿™ä¸ªæœåŠ¡åˆ—è¡¨åœ¨é…ç½®å®Œæˆåï¼Œå°±ä¸ä¼šæœ‰å˜åŠ¨äº†ã€‚è¯´ç™½äº†å°±æ˜¯åŸºäºé…ç½®å›ºå®šçš„ã€‚å®ç°å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StaticServerList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">ServerList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> servers<span class="token punctuation">;</span>
	<span class="token keyword">public</span> <span class="token class-name">StaticServerList</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> servers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>servers <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>servers<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getInitialListOfServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> servers<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUpdatedListOfServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> servers<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="configurationbasedserverlist" tabindex="-1"><a class="header-anchor" href="#configurationbasedserverlist" aria-hidden="true">#</a> ConfigurationBasedServerList</h3><p>è¿™ä¸ªæœåŠ¡ç®¡ç†ç±»æ˜¯Ribbonæä¾›çš„æœåŠ¡ç®¡ç†ç±»ã€‚ç”±ç»§æ‰¿å…³ç³»å¯çŸ¥ï¼ŒConfigurationBasedServerListç»§æ‰¿è‡ªAbstractServerListï¼Œè€ŒAbstractServerListç”±å®ç°äº†ServerListæ¥å£ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹AbstractServerListç±»æ‰©å±•äº†é‚£äº›åŠŸèƒ½ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractServerList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">ServerList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">IClientConfigAware</span> <span class="token punctuation">{</span>   
    <span class="token keyword">public</span> <span class="token class-name">AbstractServerListFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getFilterImpl</span><span class="token punctuation">(</span><span class="token class-name">IClientConfig</span> niwsClientConfig<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClientException</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> niwsServerListFilterClassName <span class="token operator">=</span> niwsClientConfig
                    <span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>
                            <span class="token class-name">CommonClientConfigKey<span class="token punctuation">.</span>NIWSServerListFilterClassName</span><span class="token punctuation">,</span>
                            <span class="token class-name">ZoneAffinityServerListFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">AbstractServerListFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> abstractNIWSServerListFilter <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AbstractServerListFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> 
                <span class="token class-name">ClientFactory</span><span class="token punctuation">.</span><span class="token function">instantiateInstanceWithClientConfig</span><span class="token punctuation">(</span>niwsServerListFilterClassName<span class="token punctuation">,</span> niwsClientConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> abstractNIWSServerListFilter<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é¦–å…ˆï¼Œè¯¥ç±»å®ç°äº†<code>IClientConfigAware</code>æ¥å£ï¼Œè¯´æ˜ä»–å…·æœ‰è·å–<code>IClientConfig</code>çš„èƒ½åŠ›ã€‚å¦å¤–ï¼Œä»–è¿˜æä¾›äº†ä¸€ä¸ª<code>getFilterImpl</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç”¨æ¥è·å–æœåŠ¡åˆ—è¡¨è¿‡æ»¤å™¨ï¼Œå¦‚æœä¸é…ç½®ï¼Œé»˜è®¤ä½¿ç”¨çš„æ˜¯<code>ZoneAffinityServerListFilter</code>ï¼Œå¦‚æœéœ€è¦é…ç½®æŒ‡å®šçš„è¿‡æ»¤å™¨å¯ä»¥ä½¿ç”¨å¦‚ä¸‹é…ç½®ï¼š</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">&lt;clientName&gt;.&lt;nameSpace&gt;.NIWSServerListFilterClassName</span><span class="token punctuation">=</span><span class="token value attr-value">className</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>çœ‹å®Œäº†çˆ¶ç±»ï¼Œå’±ä»¬æ¥ç€çœ‹æœ¬ç±»çš„å®ç°</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigurationBasedServerList</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractServerList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span>  <span class="token punctuation">{</span>

	<span class="token keyword">private</span> <span class="token class-name">IClientConfig</span> clientConfig<span class="token punctuation">;</span>
		
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token function">getInitialListOfServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token keyword">return</span> <span class="token function">getUpdatedListOfServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUpdatedListOfServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> listOfServers <span class="token operator">=</span> clientConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">CommonClientConfigKey<span class="token punctuation">.</span>ListOfServers</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">derive</span><span class="token punctuation">(</span>listOfServers<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initWithNiwsConfig</span><span class="token punctuation">(</span><span class="token class-name">IClientConfig</span> clientConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token keyword">this</span><span class="token punctuation">.</span>clientConfig <span class="token operator">=</span> clientConfig<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">protected</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token function">derive</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Strings</span><span class="token punctuation">.</span><span class="token function">isNullOrEmpty</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token operator">:</span> value<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Server</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
        <span class="token keyword">return</span> list<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®ç°ä¹Ÿå¾ˆç®€å•ï¼Œå¯ä»¥çœ‹åˆ°<code>getInitialListOfServers()</code>æ–¹æ³•è°ƒç”¨çš„æ˜¯<code>getUpdatedListOfServers()</code>æ–¹æ³•ï¼Œè€Œ<code>getUpdatedListOfServers()</code>ç›´æ¥ä»å®¢æˆ·ç«¯é…ç½®ä¸­åŠ è½½é…ç½®çš„æœåŠ¡åˆ—è¡¨ã€‚å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹æ³•é…ç½®æœåŠ¡åˆ—è¡¨ï¼š</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">&lt;clientName&gt;.&lt;nameSpace&gt;.listOfServers</span><span class="token punctuation">=</span> <span class="token value attr-value">host1:port1,host2:port2</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="nacosserverlist" tabindex="-1"><a class="header-anchor" href="#nacosserverlist" aria-hidden="true">#</a> NacosServerList</h3><p>ç•¥</p><h2 id="spring-cloud-ribbonçš„æœåŠ¡åˆ—è¡¨è¿‡æ»¤" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ribbonçš„æœåŠ¡åˆ—è¡¨è¿‡æ»¤" aria-hidden="true">#</a> Spring Cloud Ribbonçš„æœåŠ¡åˆ—è¡¨è¿‡æ»¤</h2><p>æœåŠ¡å®ä¾‹è¿‡æ»¤å™¨ï¼ˆServerListFilterï¼‰ä¸ºè´Ÿè½½å‡è¡¡å™¨ï¼ˆLoadbalancerï¼‰æä¾›ä»æœåŠ¡å®ä¾‹åˆ—è¡¨ï¼ˆServerListï¼‰è·å–çš„æœåŠ¡å®ä¾‹è¿‡æ»¤å‡ºç¬¦åˆè¦æ±‚çš„æœåŠ¡å®ä¾‹ã€‚</p><p>è´Ÿè½½å‡è¡¡å™¨ï¼ˆLoadbalancerï¼‰é€šè¿‡æœåŠ¡å®ä¾‹åˆ—è¡¨(ServerList)ä»æ³¨å†Œä¸­å¿ƒ(register)æˆ–è€…é…ç½®æ–‡ä»¶ï¼ˆyamlæˆ–propertiesï¼‰ä¸Šè¯»å–å…¨éƒ¨æœåŠ¡å®ä¾‹(server)ï¼Œç„¶åä»¥æœåŠ¡å®ä¾‹è¿‡æ»¤å™¨(ServerListFilter)çš„è¿‡æ»¤æ–¹å¼è¿›è¡Œç­›é€‰ç•™ä¸‹æ»¡è¶³æ¡ä»¶çš„æœåŠ¡å®ä¾‹ï¼Œè¿›è€Œå€ŸåŠ©è´Ÿè½½å‡è¡¡ç­–ç•¥(IRule)é€‰æ‹©å‡ºä¸€ä¸ªåˆé€‚çš„æœåŠ¡å®ä¾‹ã€‚</p><p>é¦–å…ˆæ¥çœ‹æ¥å£å®šä¹‰ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ServerListFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
	<span class="token comment">// è·å–è¿‡æ»¤åçš„æœåŠ¡åˆ—è¡¨</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getFilteredListOfServers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> servers<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªæ¥å£å®šä¹‰ç‰¹åˆ«ç®€å•ï¼Œå°±ä¸€ä¸ªæ–¹æ³•ï¼Œè¿”å›è¿‡æ»¤åçš„æ¥å£ä¿¡æ¯ã€‚</p><p>ä¸‹é¢æ¥çœ‹ä¸€ä¸‹æ¥å£çš„æŠ½è±¡å®ç°ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractServerListFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">ServerListFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">LoadBalancerStats</span> stats<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLoadBalancerStats</span><span class="token punctuation">(</span><span class="token class-name">LoadBalancerStats</span> stats<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stats <span class="token operator">=</span> stats<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token class-name">LoadBalancerStats</span> <span class="token function">getLoadBalancerStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> stats<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‹é¢æ¥çœ‹ä¸€ä¸‹ç±»å›¾ï¼š</p><img src="/assets/image-20220615094039643-8fb7fb47.png" alt="image-20220615094039643" style="zoom:60%;"><ul><li>ZoneAffinityServerListFilter:</li></ul><p>è¿™é‡Œé¢ZonePreferenceServerListFilteræ˜¯SpringCloudçš„å®ç°ï¼Œå…¶ä½™ä¸ºRibbonå†…éƒ¨çš„å®ç°ã€‚ä¸‹é¢å°±æ¥çœ‹å®ç°æºç ã€‚</p><h3 id="zoneaffinityserverlistfilter" tabindex="-1"><a class="header-anchor" href="#zoneaffinityserverlistfilter" aria-hidden="true">#</a> ZoneAffinityServerListFilter</h3><p>åŒºåŸŸç›¸å…³æ€§ç­›é€‰è¿‡æ»¤</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZoneAffinityServerListFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span>
        <span class="token class-name">AbstractServerListFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">IClientConfigAware</span> <span class="token punctuation">{</span>
	<span class="token comment">// åŒºåŸŸäº²å’Œæ€§ï¼Œ é»˜è®¤false</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> zoneAffinity <span class="token operator">=</span> <span class="token class-name">DefaultClientConfigImpl</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_ENABLE_ZONE_AFFINITY</span><span class="token punctuation">;</span>
    <span class="token comment">// åŒºåŸŸæ’é™¤ï¼Œ é»˜è®¤false</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> zoneExclusive <span class="token operator">=</span> <span class="token class-name">DefaultClientConfigImpl</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_ENABLE_ZONE_EXCLUSIVITY</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getFilteredListOfServers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> servers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>zone <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>zoneAffinity <span class="token operator">||</span> zoneExclusive<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> servers <span class="token operator">!=</span><span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> servers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// è¿™é‡Œè°ƒç”¨è¿‡æ»¤æ¡ä»¶</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> filteredServers <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token class-name">Iterables</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
                    servers<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zoneAffinityPredicate<span class="token punctuation">.</span><span class="token function">getServerOnlyPredicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡ŒåŒºåŸŸäº²å’Œæ€§è¿‡æ»¤</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldEnableZoneAffinity</span><span class="token punctuation">(</span>filteredServers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> filteredServers<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>zoneAffinity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                overrideCounter<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> servers<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>          
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œé¦–å…ˆè°ƒç”¨ZoneAffinityPredicate.getServerOnlyPredicate()æ–¹æ³•è¿›è¡Œè¿‡æ»¤ï¼Œç„¶åè°ƒç”¨shouldEnableZoneAffinity()æ–¹æ³•åˆ¤æ–­æ˜¯å¦çœŸçš„éœ€è¦è¿”å›è¿‡æ»¤çš„æ•°æ®</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZoneAffinityPredicate</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractServerPredicate</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> zone <span class="token operator">=</span> <span class="token class-name">ConfigurationManager</span><span class="token punctuation">.</span><span class="token function">getDeploymentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token class-name">ContextKey</span><span class="token punctuation">.</span>zone<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">PredicateKey</span> input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Server</span> s <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">getServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> az <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">getZone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>az <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> zone <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> az<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>zone<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ZoneAffinityPredicateé‡Œä¼šå¯¹serverçš„zoneè¿›è¡Œåˆ¤æ–­ï¼Œåªæœ‰ç›¸åŒçš„zoneæ‰ä¼šè¢«é€‰å‡ºæ¥ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">shouldEnableZoneAffinity</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> filtered<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>zoneAffinity <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>zoneExclusive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>zoneExclusive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">LoadBalancerStats</span> stats <span class="token operator">=</span> <span class="token function">getLoadBalancerStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stats <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> zoneAffinity<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">ZoneSnapshot</span> snapshot <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">getZoneSnapshot</span><span class="token punctuation">(</span>filtered<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> loadPerServer <span class="token operator">=</span> snapshot<span class="token punctuation">.</span><span class="token function">getLoadPerServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> instanceCount <span class="token operator">=</span> snapshot<span class="token punctuation">.</span><span class="token function">getInstanceCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            
        <span class="token keyword">int</span> circuitBreakerTrippedCount <span class="token operator">=</span> snapshot<span class="token punctuation">.</span><span class="token function">getCircuitTrippedCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> circuitBreakerTrippedCount<span class="token punctuation">)</span><span class="token operator">/</span>instanceCount<span class="token operator">&gt;=</span>blackOutServerPercentageThreshold<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
            <span class="token operator">||</span> loadPerServer <span class="token operator">&gt;=</span> activeReqeustsPerServerThreshold<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">||</span> <span class="token punctuation">(</span>instanceCount <span class="token operator">-</span> circuitBreakerTrippedCount<span class="token punctuation">)</span> <span class="token operator">&lt;</span> availableServersThreshold<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ä¸»è¦æ˜¯å¯¹ä¸€äº›ç»Ÿè®¡æ•°æ®è¿›è¡Œåˆ¤å®šï¼Œå¦‚æœç›®æ ‡zoneçš„serverç»Ÿè®¡æ•°æ®ä¸å¤ªå¥½ï¼Œè¾¾åˆ°æ–­è·¯çš„æ ‡å‡†ï¼Œåˆ™ä¸ä¼šè¿”å›è¯¥zoneçš„serverã€‚</p><h3 id="serverlistsubsetfilter" tabindex="-1"><a class="header-anchor" href="#serverlistsubsetfilter" aria-hidden="true">#</a> ServerListSubsetFilter</h3><p>å¯¹äºè¿‡æ»¤åçš„æœåŠ¡å™¨åˆ—è¡¨ï¼Œåœ¨è¿™é‡Œä¼šè¿›è¡Œè¿›ä¸€æ­¥çš„è¿‡æ»¤ï¼ŒåŒ…æ‹¬å‰”é™¤ä¸€äº›ä¸å¥åº·çš„æœåŠ¡åˆ—è¡¨ï¼Œåªä¿ç•™ä¸‹æœ€ç¨³å®šçš„æœåŠ¡å™¨åˆ—è¡¨ï¼Œå¦‚ï¼š</p><ul><li><p>å¹¶å‘è¿æ¥è®¡æ•°è¶…è¿‡å®¢æˆ·ç«¯é…ç½®çš„æœåŠ¡åˆ—è¡¨ï¼Œé…ç½®é¡¹ä¸º <code>&lt;clientName&gt;.&lt;nameSpace&gt;.ServerListSubsetFilter.eliminationConnectionThresold</code></p></li><li><p>æœåŠ¡æ•…éšœè®¡æ•°è¶…è¿‡å®¢æˆ·ç«¯é…ç½®çš„åˆ—è¡¨ï¼Œé…ç½®é¡¹ä¸ºï¼š<code>&lt;clientName&gt;.&lt;nameSpace&gt;.ServerListSubsetFilter.eliminationFailureThresold</code></p></li><li><p>å¦‚æœå‰ä¸¤éƒ¨å‰”é™¤çš„åˆ—è¡¨å°äºé…ç½®çš„å‰”é™¤æ¯”ä¾‹ï¼Œå…¶ä½™æœåŠ¡æŒ‰è¿è¡ŒçŠ¶å†µæ’åºï¼Œå¼ºåˆ¶æœ«ä½å‰”é™¤ã€‚é…ç½®é¡¹ä¸ºï¼š</p><p><code>&lt;clientName&gt;.&lt;nameSpace&gt;.ServerListSubsetFilter.forceEliminatePercent</code></p></li></ul><p>ä¸‹é¢æ¥çœ‹ä»£ç å®ç°ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServerListSubsetFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">ZoneAffinityServerListFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">IClientConfigAware</span><span class="token punctuation">,</span> <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> currentSubset <span class="token operator">=</span> <span class="token class-name">Sets</span><span class="token punctuation">.</span><span class="token function">newHashSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

        
    <span class="token doc-comment comment">/** è¿‡æ»¤æœåŠ¡åˆ—è¡¨ */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getFilteredListOfServers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> servers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// é¦–å…ˆè°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•è¿›è¡Œè¿‡æ»¤</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> zoneAffinityFiltered <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getFilteredListOfServers</span><span class="token punctuation">(</span>servers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> candidates <span class="token operator">=</span> <span class="token class-name">Sets</span><span class="token punctuation">.</span><span class="token function">newHashSet</span><span class="token punctuation">(</span>zoneAffinityFiltered<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> newSubSet <span class="token operator">=</span> <span class="token class-name">Sets</span><span class="token punctuation">.</span><span class="token function">newHashSet</span><span class="token punctuation">(</span>currentSubset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è·å–ç»Ÿè®¡ä¿¡æ¯</span>
        <span class="token class-name">LoadBalancerStats</span> lbStats <span class="token operator">=</span> <span class="token function">getLoadBalancerStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">T</span> server<span class="token operator">:</span> currentSubset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å‰”é™¤å¯èƒ½å·²ç»ä¸‹çº¿çš„server</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>candidates<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                newSubSet<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">ServerStats</span> stats <span class="token operator">=</span> lbStats<span class="token punctuation">.</span><span class="token function">getSingleServerStat</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// åˆ¤æ–­ï¼Œå¦‚æœå¹¶å‘è¿æ¥æ•°æˆ–æ•…éšœæ•°å¤§äºå®¢æˆ·ç«¯é…ç½®çš„æ•°é‡ï¼Œäºˆä»¥å‰”é™¤</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span><span class="token function">getActiveRequestsCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> eliminationConnectionCountThreshold<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token operator">||</span> stats<span class="token punctuation">.</span><span class="token function">getFailureCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> eliminationFailureCountThreshold<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    newSubSet<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    candidates<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// è®¡ç®—éœ€è¦å‰”é™¤çš„æ•°é‡</span>
        <span class="token keyword">int</span> targetedListSize <span class="token operator">=</span> sizeProp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// sizeProp é»˜è®¤20</span>
        <span class="token keyword">int</span> numEliminated <span class="token operator">=</span> currentSubset<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> newSubSet<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> minElimination <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>targetedListSize <span class="token operator">*</span> eliminationPercent<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> numToForceEliminate <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>targetedListSize <span class="token operator">&lt;</span> newSubSet<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// size is shrinking</span>
            numToForceEliminate <span class="token operator">=</span> newSubSet<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> targetedListSize<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>minElimination <span class="token operator">&gt;</span> numEliminated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            numToForceEliminate <span class="token operator">=</span> minElimination <span class="token operator">-</span> numEliminated<span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>numToForceEliminate <span class="token operator">&gt;</span> newSubSet<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            numToForceEliminate <span class="token operator">=</span> newSubSet<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// å¦‚æœéœ€è¦å‰”é™¤çš„æ•°é‡å¤§äº0ï¼Œ æ‰§è¡Œå‰”é™¤</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>numToForceEliminate <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> sortedSubSet <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>newSubSet<span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token comment">// æ’åºï¼Œæœ«å°¾æ·˜æ±°</span>
            <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>sortedSubSet<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> forceEliminated <span class="token operator">=</span> sortedSubSet<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> numToForceEliminate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            newSubSet<span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span>forceEliminated<span class="token punctuation">)</span><span class="token punctuation">;</span>
            candidates<span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span>forceEliminated<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// åœ¨å‰”é™¤ä¸å¥åº·çš„æœåŠ¡å’Œå¼ºåˆ¶å‰”é™¤åï¼Œå¦‚æœå‰©ä½™çš„æœåŠ¡æ•°é‡å°äºç›®æ ‡é›†åˆæ•°é‡(é»˜è®¤20)ï¼Œåˆ™ä»åŸå§‹æœåŠ¡åˆ—è¡¨ä¸­éšæœºåŠ è¿‡æ¥ä¸€äº›ã€‚</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newSubSet<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> targetedListSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è®¡ç®—éœ€è¦é€‰æ‹©çš„æ•°é‡</span>
            <span class="token keyword">int</span> numToChoose <span class="token operator">=</span> targetedListSize <span class="token operator">-</span> newSubSet<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            candidates<span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span>newSubSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>numToChoose <span class="token operator">&gt;</span> candidates<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Not enough healthy instances to choose, fallback to use the</span>
                <span class="token comment">// total server pool</span>
                candidates <span class="token operator">=</span> <span class="token class-name">Sets</span><span class="token punctuation">.</span><span class="token function">newHashSet</span><span class="token punctuation">(</span>zoneAffinityFiltered<span class="token punctuation">)</span><span class="token punctuation">;</span>
                candidates<span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span>newSubSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// é€‰æ‹©æŒ‡å®šæ•°é‡çš„åˆ—è¡¨</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> chosen <span class="token operator">=</span> <span class="token function">randomChoose</span><span class="token punctuation">(</span><span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>candidates<span class="token punctuation">)</span><span class="token punctuation">,</span> numToChoose<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">T</span> server<span class="token operator">:</span> chosen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ·»åŠ åˆ°ç›®æ ‡é›†åˆä¸­</span>
                newSubSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        currentSubset <span class="token operator">=</span> newSubSet<span class="token punctuation">;</span>
        <span class="token comment">// è¿”å›è¿‡æ»¤åçš„ç»“æœ</span>
        <span class="token keyword">return</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>newSubSet<span class="token punctuation">)</span><span class="token punctuation">;</span>            
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** é€‰æ‹©æŒ‡å®šæ•°é‡çš„æœåŠ¡åˆ—è¡¨ */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">randomChoose</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> servers<span class="token punctuation">,</span> <span class="token keyword">int</span> toChoose<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> size <span class="token operator">=</span> servers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>toChoose <span class="token operator">&gt;=</span> size <span class="token operator">||</span> toChoose <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> servers<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> toChoose<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ç”Ÿæˆä¸€ä¸ªéšæœºæ•°ï¼Œå¹¶ä¸iåšäº¤æ¢</span>
            <span class="token keyword">int</span> index <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">T</span> tmp <span class="token operator">=</span> servers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            servers<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> servers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            servers<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> servers<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> toChoose<span class="token punctuation">)</span><span class="token punctuation">;</span>        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="zonepreferenceserverlistfilter" tabindex="-1"><a class="header-anchor" href="#zonepreferenceserverlistfilter" aria-hidden="true">#</a> ZonePreferenceServerListFilter</h3><p>è¯¥è¿‡æ»¤å™¨æ˜¯Spring Cloudä¸­çš„å®ç°ï¼Œè¯¥ç±»ç»§æ‰¿äº†ZoneAffinityServerListFilterï¼Œå¹¶é‡å†™äº†getFilteredListOfServersæ–¹æ³•ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZonePreferenceServerListFilter</span> <span class="token keyword">extends</span> <span class="token class-name">ZoneAffinityServerListFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

	<span class="token keyword">private</span> <span class="token class-name">String</span> zone<span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token function">getFilteredListOfServers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> servers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> output <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getFilteredListOfServers</span><span class="token punctuation">(</span>servers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å¦‚æœsizeç›¸åŒï¼Œåˆ™è®¤ä¸ºæœåŠ¡å¯èƒ½æ²¡æœ‰æ‰§è¡Œè¿‡æ»¤</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>zone <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> output<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> servers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> local <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Server</span> server <span class="token operator">:</span> output<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>zone<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">getZone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					local<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>local<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> local<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> output<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œä¼šå¯¹çˆ¶ç±»è¿‡æ»¤å‡ºæ¥çš„ç»“æœè®°æ€§åˆ¤æ–­ï¼Œå¦‚æœçˆ¶ç±»è¿”å›çš„ç»“æœæ²¡æœ‰æŒ‰åŒºåŸŸè¿›è¡Œäº²å’Œæ€§è¿‡æ»¤ï¼Œé‚£ä¹ˆè¿™é‡Œä¼šåœ¨è¿‡æ»¤ä¸€æ¬¡ï¼Œå¦‚æœè¿‡æ»¤åçš„ç»“æœä¸ºç©ºï¼Œåˆ™è¿”å›çˆ¶ç±»çš„ç»“æœï¼Œå¦åˆ™è¿”å›åŸå§‹ç»“æœã€‚</p><h2 id="spring-cloud-ribbonçš„æœåŠ¡åˆ—è¡¨æ›´æ–°" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ribbonçš„æœåŠ¡åˆ—è¡¨æ›´æ–°" aria-hidden="true">#</a> Spring Cloud Ribbonçš„æœåŠ¡åˆ—è¡¨æ›´æ–°</h2><p>è¯¥ç»„ä»¶ä¸»è¦æä¾›å¯¹æœåŠ¡åˆ—è¡¨çš„æ›´æ–°æ“ä½œã€‚</p><p>è¯¥ç»„ä»¶çš„é¡¶çº§æ¥å£ä¸º<code>ServerListUpdater</code>ï¼Œä¸‹é¢æ¥çœ‹çœ‹è¯¥æ¥å£å®šä¹‰äº†é‚£äº›æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ServerListUpdater</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/** ä¸€ä¸ªå†…éƒ¨æ¥å£ï¼Œå®é™…ç”¨æ¥æ‰§è¡ŒæœåŠ¡åˆ—è¡¨æ›´æ–°çš„æ“ä½œ */</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UpdateAction</span> <span class="token punctuation">{</span>
        <span class="token keyword">void</span> <span class="token function">doUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     *å¼€å§‹æœåŠ¡åˆ—è¡¨æ›´æ–°çš„åŠ¨ä½œï¼Œè¿™ä¸ªæ¥å£æ˜¯å¹‚ç­‰çš„
     */</span>
    <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token class-name">UpdateAction</span> updateAction<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * åœæ­¢æœåŠ¡åˆ—è¡¨æ›´æ–°çš„åŠ¨ä½œ
     */</span>
    <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * è¿”å›æœ€åæ›´æ–°çš„æ—¶é—´
     */</span>
    <span class="token class-name">String</span> <span class="token function">getLastUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * è·æœ€åä¸€æ¬¡æ›´æ–°ï¼Œè¿‡å»äº†å¤šå°‘æ¯«ç§’
     */</span>
    <span class="token keyword">long</span> <span class="token function">getDurationSinceLastUpdateMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * è¿”å›ä¸¢å¤±çš„æ›´æ–°å‘¨æœŸæ•°
     */</span>
    <span class="token keyword">int</span> <span class="token function">getNumberMissedCycles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * è¿”å›ä½¿ç”¨çš„çº¿ç¨‹æ•°
     */</span>
    <span class="token keyword">int</span> <span class="token function">getCoreThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œæ¯”è¾ƒé‡è¦çš„æ–¹æ³•åªæœ‰ä¸¤ä¸ªï¼Œå³<code>UpdateAction</code>å’Œ<code>start</code>æ–¹æ³•</p><p>åœ¨Ribbonä¸­ï¼Œ ServerListUpdaterçš„å®ç°åªæœ‰ä¸€ä¸ªï¼Œå³<code>PollingServerListUpdater</code>ï¼Œè¿™é‡Œå°±ä¸åœ¨ç»™å‡ºç±»å›¾äº†ï¼Œåœ¨ä»¬ç›´æ¥çœ‹å®ƒçš„å®ç°ã€‚</p><h3 id="pollingserverlistupdater" tabindex="-1"><a class="header-anchor" href="#pollingserverlistupdater" aria-hidden="true">#</a> PollingServerListUpdater</h3><p>é¦–å…ˆæ¥çœ‹çœ‹æ„é€ å‡½æ•°åŠå†…éƒ¨ç±»çš„å®ç°ï¼Œå¯¹PollingServerListUpdateræœ‰ä¸€ä¸ªç®€å•çš„äº†è§£</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PollingServerListUpdater</span> <span class="token keyword">implements</span> <span class="token class-name">ServerListUpdater</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token constant">LISTOFSERVERS_CACHE_UPDATE_DELAY</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token comment">// msecs;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token constant">LISTOFSERVERS_CACHE_REPEAT_INTERVAL</span> <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token comment">// msecs;</span>
	<span class="token comment">// è¯¥å±æ€§è¡¨ç¤ºæ›´æ–°ä»»åŠ¡æ˜¯å¦åœ¨è¿è¡Œä¸­</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicBoolean</span> isActive <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicBoolean</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è®°å½•æœ€åä¸€æ¬¡æ›´æ–°æœåŠ¡çš„æ—¶é—´</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> lastUpdated <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å®šæ—¶ä»»åŠ¡é¦–æ¬¡æ‰§è¡Œçš„å»¶è¿Ÿæ—¶é—´</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> initialDelayMs<span class="token punctuation">;</span>
    <span class="token comment">// ä¸€æ¬¡æ‰§è¡Œç»ˆæ­¢å’Œä¸‹ä¸€æ¬¡æ‰§è¡Œå¼€å§‹ä¹‹é—´çš„å»¶è¿Ÿ</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> refreshIntervalMs<span class="token punctuation">;</span>
    <span class="token comment">// å®šæ—¶ä»»åŠ¡çš„è¿”å›å€¼ç±»å‹</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> scheduledFuture<span class="token punctuation">;</span>
    
    <span class="token comment">// é»˜è®¤çš„å»¶è¿Ÿæ—¶é—´åŠé—´éš”æ—¶é—´</span>
    <span class="token keyword">public</span> <span class="token class-name">PollingServerListUpdater</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token constant">LISTOFSERVERS_CACHE_UPDATE_DELAY</span><span class="token punctuation">,</span> <span class="token constant">LISTOFSERVERS_CACHE_REPEAT_INTERVAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// é»˜è®¤çš„å»¶è¿Ÿæ—¶é—´ï¼Œé…ç½®çš„é—´éš”æ—¶é—´</span>
    <span class="token keyword">public</span> <span class="token class-name">PollingServerListUpdater</span><span class="token punctuation">(</span><span class="token class-name">IClientConfig</span> clientConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token constant">LISTOFSERVERS_CACHE_UPDATE_DELAY</span><span class="token punctuation">,</span> <span class="token function">getRefreshIntervalMs</span><span class="token punctuation">(</span>clientConfig<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">PollingServerListUpdater</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> initialDelayMs<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> refreshIntervalMs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>initialDelayMs <span class="token operator">=</span> initialDelayMs<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>refreshIntervalMs <span class="token operator">=</span> refreshIntervalMs<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è¿™ä¸ªå†…éƒ¨ç±»ä¸»è¦ç”¨æ¥é…ç½®å®šæ—¶ä»»åŠ¡çš„çº¿ç¨‹æ± ï¼ŒåŠç»“æŸä»»åŠ¡çš„æ–¹æ³•</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">LazyHolder</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">CORE_THREAD</span> <span class="token operator">=</span> <span class="token string">&quot;DynamicServerListLoadBalancer.ThreadPoolSize&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">DynamicIntProperty</span> poolSizeProp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DynamicIntProperty</span><span class="token punctuation">(</span><span class="token constant">CORE_THREAD</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Thread</span> _shutdownThread<span class="token punctuation">;</span>

        <span class="token keyword">static</span> <span class="token class-name">ScheduledThreadPoolExecutor</span> _serverListRefreshExecutor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">static</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ ¸å¿ƒçº¿ç¨‹æ•°</span>
            <span class="token keyword">int</span> coreSize <span class="token operator">=</span> poolSizeProp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è‡ªå®šä¹‰å·¥å‚</span>
            <span class="token class-name">ThreadFactory</span> factory <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span><span class="token string">&quot;PollingServerListUpdater-%d&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// åˆå§‹åŒ–çº¿ç¨‹æ± </span>
            _serverListRefreshExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScheduledThreadPoolExecutor</span><span class="token punctuation">(</span>coreSize<span class="token punctuation">,</span> factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            poolSizeProp<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    _serverListRefreshExecutor<span class="token punctuation">.</span><span class="token function">setCorePoolSize</span><span class="token punctuation">(</span>poolSizeProp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æš‚åœçº¿ç¨‹</span>
            _shutdownThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Shutting down the Executor Pool for PollingServerListUpdater&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">shutdownExecutorPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addShutdownHook</span><span class="token punctuation">(</span>_shutdownThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">shutdownExecutorPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_serverListRefreshExecutor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                _serverListRefreshExecutor<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>_shutdownThread <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeShutdownHook</span><span class="token punctuation">(</span>_shutdownThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalStateException</span> ise<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// NOPMD</span>
                       
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é¦–å…ˆæ¥çœ‹startæ–¹æ³•çš„å®ç°</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PollingServerListUpdater</span> <span class="token keyword">implements</span> <span class="token class-name">ServerListUpdater</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token constant">LISTOFSERVERS_CACHE_UPDATE_DELAY</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token comment">// msecs;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token constant">LISTOFSERVERS_CACHE_REPEAT_INTERVAL</span> <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token comment">// msecs;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicBoolean</span> isActive <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicBoolean</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> scheduledFuture<span class="token punctuation">;</span>
    
    
    <span class="token keyword">public</span> <span class="token class-name">PollingServerListUpdater</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token constant">LISTOFSERVERS_CACHE_UPDATE_DELAY</span><span class="token punctuation">,</span> <span class="token constant">LISTOFSERVERS_CACHE_REPEAT_INTERVAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">PollingServerListUpdater</span><span class="token punctuation">(</span><span class="token class-name">IClientConfig</span> clientConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token constant">LISTOFSERVERS_CACHE_UPDATE_DELAY</span><span class="token punctuation">,</span> <span class="token function">getRefreshIntervalMs</span><span class="token punctuation">(</span>clientConfig<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">PollingServerListUpdater</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> initialDelayMs<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> refreshIntervalMs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>initialDelayMs <span class="token operator">=</span> initialDelayMs<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>refreshIntervalMs <span class="token operator">=</span> refreshIntervalMs<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">UpdateAction</span> updateAction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isActive<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">Runnable</span> wrapperRunnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isActive<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduledFuture <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            scheduledFuture<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        updateAction<span class="token punctuation">.</span><span class="token function">doUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        lastUpdated <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Failed one update cycle&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            scheduledFuture <span class="token operator">=</span> <span class="token function">getRefreshExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleWithFixedDelay</span><span class="token punctuation">(</span>
                    wrapperRunnable<span class="token punctuation">,</span>
                    initialDelayMs<span class="token punctuation">,</span>
                    refreshIntervalMs<span class="token punctuation">,</span>
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Already active, no-op&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>    
    
    
    
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="spring-cloud-ribbonçš„è´Ÿè½½å‡è¡¡å™¨" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ribbonçš„è´Ÿè½½å‡è¡¡å™¨" aria-hidden="true">#</a> Spring Cloud Ribbonçš„è´Ÿè½½å‡è¡¡å™¨</h2><p>è´Ÿè½½å‡è¡¡å™¨çš„ä½œç”¨å°±æ˜¯åè°ƒå…¶ä»–ç»„ä»¶ï¼Œå®Œæˆè´Ÿè½½å‡è¡¡çš„è°ƒåº¦ç®¡ç†åŠŸèƒ½ã€‚è€Œå¦‚ä½•åè°ƒç»„ä»¶ï¼Œå®Œæˆå¯¹serveråˆ—è¡¨çš„è·å–ã€æ›´æ–°ã€ç»´æŠ¤ã€å¿ƒè·³æ£€æµ‹ã€é€‰æ‹©ç­‰åŠŸèƒ½ï¼Œä¾¿æˆä¸ºäº†è¿™ä¸ªç»„ä»¶çš„ä¸»è¦å·¥ä½œï¼Œæ¥ä¸‹æ¥å°±çœ‹çœ‹Ribbonæ˜¯å¦‚ä½•å®ç°çš„ã€‚é¦–å…ˆæ¥çœ‹çœ‹Ribbonä¸­è´Ÿè½½å‡è¡¡å™¨çš„é¡¶çº§æ¥å£å®šä¹‰<code>ILoadBalancer</code>ï¼Œè¯¥æ¥å£æä¾›äº†å¯¹æœåŠ¡å™¨æ“ä½œçš„ä¸€ç»„æ–¹æ³•ï¼ŒåŒ…æ‹¬æ·»åŠ ã€é€‰æ‹©ã€æ ‡è®°ä»¥åŠè·å–serveråˆ—è¡¨ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ILoadBalancer</span> <span class="token punctuation">{</span>
	<span class="token doc-comment comment">/**
	 * æ·»åŠ æ–°çš„æœåŠ¡åˆ—è¡¨
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addServers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> newServers<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token doc-comment comment">/**
	 * æ ¹æ®keyé€šè¿‡è´Ÿè½½å‡è¡¡å™¨é€‰ä¸ªä¸€ä¸ªæœåŠ¡ï¼Œé€šå¸¸æƒ…å†µä¸‹æ˜¯å§”æ‰˜ç»™IRuleç»„ä»¶
	 */</span>
	<span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">chooseServer</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token doc-comment comment">/**
	 * ç”±å®¢æˆ·ç«¯å›è°ƒï¼Œç”¨æ¥æ ‡è®°æŸä¸ªæœåŠ¡ä¸‹çº¿
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">markServerDown</span><span class="token punctuation">(</span><span class="token class-name">Server</span> server<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token doc-comment comment">/**
	 * è·å–å¯ç”¨çš„æœåŠ¡åˆ—è¡¨
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token function">getReachableServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * è·å–æ‰€æœ‰æœåŠ¡åˆ—è¡¨ï¼ŒåŒ…å«å¯ç”¨å’Œä¸å¯ç”¨
     */</span>
	<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAllServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶ç›´æ¥æŠ½è±¡å®ç°ä¸º<code>AbstractLoadBalancer</code>ï¼Œåªæ˜¯å®šä¹‰äº†ä¸¤ä¸ªæ–°çš„æ–¹æ³•ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆå…·ä½“çš„å®ç°ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractLoadBalancer</span> <span class="token keyword">implements</span> <span class="token class-name">ILoadBalancer</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">ServerGroup</span><span class="token punctuation">{</span>
        <span class="token constant">ALL</span><span class="token punctuation">,</span>
        <span class="token constant">STATUS_UP</span><span class="token punctuation">,</span>
        <span class="token constant">STATUS_NOT_UP</span>        
    <span class="token punctuation">}</span>
        
    <span class="token doc-comment comment">/**
     * å®šä¹‰ä¸€ä¸ªç©ºå‚æ•°çš„chooseServer()
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">chooseServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token keyword">return</span> <span class="token function">chooseServer</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * æ ¹æ®æœåŠ¡åˆ†ç»„è·å–æœåŠ¡åˆ—è¡¨
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token function">getServerList</span><span class="token punctuation">(</span><span class="token class-name">ServerGroup</span> serverGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token doc-comment comment">/**
     * è·å–loadBalancerçš„ç»Ÿè®¡ä¿¡æ¯
     * å­ç±»å¯ä»¥æ ¹æ®serverçš„å¥åº·çŠ¶æ€æ¥è·å–å¥åº·çš„server
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">LoadBalancerStats</span> <span class="token function">getLoadBalancerStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‹é¢æ¥çœ‹çœ‹LoadBalancerçš„å®ç°ç±»å›¾ï¼š</p><img src="/assets/image-20220613100308276-6eb86e19.png" alt="image-20220613100308276" style="zoom:60%;"><h3 id="nooploadbalancer" tabindex="-1"><a class="header-anchor" href="#nooploadbalancer" aria-hidden="true">#</a> NoOpLoadBalancer</h3><p>è¿™ä¸ªå°±æ˜¯æœªåšä»»ä½•å®ç°çš„å®ç°ï¼Œæ–¹æ³•è¿”å›çš„ä¸æ˜¯nullï¼Œå°±æ˜¯ç©ºåˆ—è¡¨ã€‚æ²¡ä»€ä¹ˆå®é™…çš„ä½¿ç”¨åœºæ™¯ï¼Œæºç å°±ä¸åœ¨è¿™é‡Œç²˜äº†ã€‚</p><h3 id="baseloadbalancer" tabindex="-1"><a class="header-anchor" href="#baseloadbalancer" aria-hidden="true">#</a> BaseLoadBalancer</h3><p>è¿™ä¸ªè´Ÿè½½å‡è¡¡å™¨æ˜¯Ribbonä¸­æœ€åŸºç¡€çš„ä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨ï¼Œæä¾›äº†è´Ÿè½½å‡è¡¡çš„åŸºæœ¬èƒ½åŠ›ã€‚å…¶ä»–çš„è´Ÿè½½å‡è¡¡å™¨éƒ½æ˜¯åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œæ‰©å±•çš„ã€‚</p><p>é¦–å…ˆæ¥çœ‹çœ‹è¯¥è´Ÿè½½å‡è¡¡å™¨ä¸­çš„ä¸€äº›åŸºç¡€å±æ€§ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// é»˜è®¤çš„è´Ÿè½½å‡è¡¡è§„åˆ™ï¼Œè½®è¯¢</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">IRule</span> <span class="token constant">DEFAULT_RULE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RoundRobinRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// é»˜è®¤çš„å¿ƒè·³æ£€æŸ¥ç­–ç•¥ï¼Œ ä¸²è¡Œping</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">SerialPingStrategy</span> <span class="token constant">DEFAULT_PING_STRATEGY</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SerialPingStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEFAULT_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;default&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PREFIX</span> <span class="token operator">=</span> <span class="token string">&quot;LoadBalancer_&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// è´Ÿè½½å‡è¡¡è§„åˆ™</span>
<span class="token keyword">protected</span> <span class="token class-name">IRule</span> rule <span class="token operator">=</span> <span class="token constant">DEFAULT_RULE</span><span class="token punctuation">;</span>
<span class="token comment">// å¿ƒè·³æ£€æŸ¥ç­–ç•¥</span>
<span class="token keyword">protected</span> <span class="token class-name">IPingStrategy</span> pingStrategy <span class="token operator">=</span> <span class="token constant">DEFAULT_PING_STRATEGY</span><span class="token punctuation">;</span>
<span class="token comment">// å¿ƒè·³æ£€æŸ¥</span>
<span class="token keyword">protected</span> <span class="token class-name">IPing</span> ping <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token comment">// æ‰€æœ‰ server åˆ—è¡¨</span>
<span class="token keyword">protected</span> <span class="token keyword">volatile</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> allServerList <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">synchronizedList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// å¯ç”¨çš„ server åˆ—è¡¨</span>
<span class="token keyword">protected</span> <span class="token keyword">volatile</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> upServerList <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">synchronizedList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">protected</span> <span class="token class-name">ReadWriteLock</span> allServerLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">protected</span> <span class="token class-name">ReadWriteLock</span> upServerLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// è´Ÿè½½å‡è¡¡å™¨çš„åç§°ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸ºClientNameï¼Œè‹¥æ²¡æŒ‡å®šä¸ºdefault</span>
<span class="token keyword">protected</span> <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token constant">DEFAULT_NAME</span><span class="token punctuation">;</span>
<span class="token comment">// å®šæ—¶å™¨ï¼Œç”¨äºå¯åŠ¨å¿ƒè·³ä»»åŠ¡</span>
<span class="token keyword">protected</span> <span class="token class-name">Timer</span> lbTimer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token comment">// ping é—´éš”æ—¶é—´ï¼Œå¯ä»¥é€šè¿‡é…ç½®ä¿®æ”¹ï¼Œ&lt;clientName&gt;.&lt;nameSpace&gt;.NFLoadBalancerPingInterval</span>
<span class="token keyword">protected</span> <span class="token keyword">int</span> pingIntervalSeconds <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token comment">// æ¯æ¬¡pingçš„æœ€é•¿æ—¶é—´ï¼Œå¯é€šè¿‡é…ç½®ä¿®æ”¹ï¼Œ&lt;clientName&gt;.&lt;nameSpace&gt;.NFLoadBalancerMaxTotalPingTime</span>
<span class="token keyword">protected</span> <span class="token keyword">int</span> maxTotalPingTimeSeconds <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token comment">// æŒ‰ç…§serverçš„idæ’åº</span>
<span class="token keyword">protected</span> <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> serverComparator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerComparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// è¡¨ç¤ºPing æ˜¯å¦æ­£åœ¨è¿›è¡Œ</span>
<span class="token keyword">protected</span> <span class="token class-name">AtomicBoolean</span> pingInProgress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicBoolean</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ç»Ÿè®¡ä¿¡æ¯</span>
<span class="token keyword">protected</span> <span class="token class-name">LoadBalancerStats</span> lbStats<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">Counter</span> counter <span class="token operator">=</span> <span class="token class-name">Monitors</span><span class="token punctuation">.</span><span class="token function">newCounter</span><span class="token punctuation">(</span><span class="token string">&quot;LoadBalancer_ChooseServer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// åˆå§‹é“¾æ¥æ£€æŸ¥ï¼Œ ç”¨äºæ£€æŸ¥åˆå§‹æ£€æµ‹Serverçš„readyToServer æ˜¯å¦èƒ½å¤Ÿæä¾›æœåŠ¡ã€‚</span>
<span class="token keyword">private</span> <span class="token class-name">PrimeConnections</span> primeConnections<span class="token punctuation">;</span>
<span class="token comment">// åˆå§‹æ£€æµ‹çš„å¼€å…³</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> enablePrimingConnections <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">IClientConfig</span> config<span class="token punctuation">;</span>
<span class="token comment">// ä¸€ä¸ªç›‘å¬å™¨åˆ—è¡¨ï¼Œåˆ°allServerListé‡Œé¢çš„å†…å®¹å‘ç”Ÿå˜åŒ–ï¼Œä¼šè§¦å‘æ­¤ç›‘å¬å™¨</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerListChangeListener</span><span class="token punctuation">&gt;</span></span> changeListeners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerListChangeListener</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// å½“serverçš„isAliveçŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè§¦å‘è¯ç›‘å¬å™¨ã€‚</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerStatusChangeListener</span><span class="token punctuation">&gt;</span></span> serverStatusListeners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerStatusChangeListener</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="dynamicserverlistloadbalancer" tabindex="-1"><a class="header-anchor" href="#dynamicserverlistloadbalancer" aria-hidden="true">#</a> DynamicServerListLoadBalancer</h3><h3 id="zoneawareloadbalancer" tabindex="-1"><a class="header-anchor" href="#zoneawareloadbalancer" aria-hidden="true">#</a> ZoneAwareLoadBalancer</h3><h2 id="spring-cloud-ribbonè‡ªåŠ¨è£…é…" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ribbonè‡ªåŠ¨è£…é…" aria-hidden="true">#</a> Spring Cloud Ribbonè‡ªåŠ¨è£…é…</h2><p>æ ¹æ®Spring Bootçš„è‡ªåŠ¨è£…é…åŸåˆ™ï¼Œæˆ‘ä»¬ç›´æ¥å»æŸ¥çœ‹spring-cloud-netflix-ribbon-2.2.9.RELEASE.jaråŒ…ä¸‹çš„META_INFç›®å½•ä¸­çš„spring.factoriesæ–‡ä»¶ï¼š</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span><span class="token punctuation">=</span><span class="token value attr-value">\
org.springframework.cloud.netflix.ribbon.RibbonAutoConfiguration</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼ŒRibbonçš„è‡ªåŠ¨è£…é…ç±»ä¸º<code>RibbonAutoConfiguration</code>ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<code>RibbonAutoConfiguration</code>çš„å®šä¹‰ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Conditional</span><span class="token punctuation">(</span><span class="token class-name">RibbonAutoConfiguration<span class="token punctuation">.</span>RibbonClassesConditions</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RibbonClients</span>
<span class="token annotation punctuation">@AutoConfigureAfter</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;org.springframework.cloud.netflix.eureka.EurekaClientAutoConfiguration&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@AutoConfigureBefore</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">LoadBalancerAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">AsyncLoadBalancerAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">RibbonEagerLoadProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">ServerIntrospectorProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;spring.cloud.loadbalancer.ribbon.enabled&quot;</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">,</span> matchIfMissing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RibbonAutoConfiguration</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ribbonautoconfigurationä¸Šçš„æ³¨è§£" tabindex="-1"><a class="header-anchor" href="#ribbonautoconfigurationä¸Šçš„æ³¨è§£" aria-hidden="true">#</a> RibbonAutoConfigurationä¸Šçš„æ³¨è§£</h3><p>ä¸‹é¢æ¥æŒ¨ä¸ªåˆ†æè¿™ä¸ªè‡ªåŠ¨è£…é…ç±»ä¸Šæ ‡è®°çš„æ³¨è§£ï¼š</p><h4 id="configuration" tabindex="-1"><a class="header-anchor" href="#configuration" aria-hidden="true">#</a> @Configurationï¼š</h4><p>æ ‡æ˜è¿™ä¸ªä¸€ä¸ªé…ç½®ç±»</p><h4 id="conditional" tabindex="-1"><a class="header-anchor" href="#conditional" aria-hidden="true">#</a> @Conditional</h4><p>è‡ªåŠ¨è£…é…çš„æ¡ä»¶ï¼Œæ¡ä»¶ç±»ä¸º<code>RibbonAutoConfiguration.RibbonClassesConditions.class</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">RibbonClassesConditions</span> <span class="token keyword">extends</span> <span class="token class-name">AllNestedConditions</span> <span class="token punctuation">{</span>
    <span class="token class-name">RibbonClassesConditions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è¯¥å‚æ•°è¡¨ç¤ºè§£æè¯¥æ³¨è§£çš„æ—¶æœºæ˜¯åœ¨å‘å®¹å™¨ä¸­æ³¨å…¥beançš„æ—¶å€™è®°æ€§è§£æã€‚</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationPhase</span><span class="token punctuation">.</span><span class="token constant">PARSE_CONFIGURATION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">IClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">IClientPresent</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">RestTemplate</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">RestTemplatePresent</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;deprecation&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">AsyncRestTemplate</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">AsyncRestTemplatePresent</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">Ribbon</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">RibbonPresent</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯¥æ¡ä»¶è£…é…ç±»ç»§æ‰¿è‡ª<code>AllNestedConditions</code>ï¼Œè¡¨ç¤ºè¯¥ç±»å®šä¹‰çš„æ‰€æœ‰å†…éƒ¨ç±»çš„æ¡ä»¶æ³¨è§£éƒ½å¿…é¡»æ»¡è¶³ã€‚å³å½“å‰ç¯å¢ƒå¿…é¡»å­˜åœ¨è¿™å‡ ä¸ªç±»ï¼šIClientã€RestTemplateã€AsyncRestTemplateã€Ribbonã€‚</p><h4 id="ribbonclients" tabindex="-1"><a class="header-anchor" href="#ribbonclients" aria-hidden="true">#</a> @RibbonClients</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token class-name">RibbonClientConfigurationRegistrar</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">RibbonClients</span> <span class="token punctuation">{</span>
	<span class="token class-name">RibbonClient</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">defaultConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯¥æ³¨è§£å¼•å…¥äº†<code>RibbonClientConfigurationRegistrar.class</code>ç±»ï¼Œè¯¥ç±»è´Ÿè´£å¯¹<code>@RibbonClients</code>åŠ<code>@RibbonClient</code>ä¸¤ç§æ³¨è§£çš„è§£æã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RibbonClientConfigurationRegistrar</span> <span class="token keyword">implements</span> <span class="token class-name">ImportBeanDefinitionRegistrar</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span> metadata<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// è§£æ@RibbonClients</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> attrs <span class="token operator">=</span> metadata<span class="token punctuation">.</span><span class="token function">getAnnotationAttributes</span><span class="token punctuation">(</span><span class="token class-name">RibbonClients</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>attrs <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> attrs<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">AnnotationAttributes</span><span class="token punctuation">[</span><span class="token punctuation">]</span> clients <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AnnotationAttributes</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> attrs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AnnotationAttributes</span> client <span class="token operator">:</span> clients<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">registerClientConfiguration</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> <span class="token function">getClientName</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;configuration&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>attrs <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> attrs<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">&quot;defaultConfiguration&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">String</span> name<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">.</span><span class="token function">hasEnclosingClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				name <span class="token operator">=</span> <span class="token string">&quot;default.&quot;</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">getEnclosingClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				name <span class="token operator">=</span> <span class="token string">&quot;default.&quot;</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">registerClientConfiguration</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> name<span class="token punctuation">,</span> attrs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;defaultConfiguration&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
        <span class="token comment">// è§£æ@RibbonClients</span>
		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> client <span class="token operator">=</span> metadata<span class="token punctuation">.</span><span class="token function">getAnnotationAttributes</span><span class="token punctuation">(</span><span class="token class-name">RibbonClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token function">getClientName</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ³¨å†Œå®¢æˆ·ç«¯é…ç½®</span>
			<span class="token function">registerClientConfiguration</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> name<span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;configuration&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getClientName</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> client<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>client <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token class-name">String</span> value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> value<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Either &#39;name&#39; or &#39;value&#39; must be provided in @RibbonClient&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">registerClientConfiguration</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">,</span> <span class="token class-name">Object</span> name<span class="token punctuation">,</span>
			<span class="token class-name">Object</span> configuration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">BeanDefinitionBuilder</span> builder <span class="token operator">=</span> <span class="token class-name">BeanDefinitionBuilder</span><span class="token punctuation">.</span><span class="token function">genericBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">RibbonClientSpecification</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		builder<span class="token punctuation">.</span><span class="token function">addConstructorArgValue</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
		builder<span class="token punctuation">.</span><span class="token function">addConstructorArgValue</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
		registry<span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">&quot;.RibbonClientSpecification&quot;</span><span class="token punctuation">,</span> builder<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œæœ€åæ³¨å†Œçš„beançš„ç±»å‹éƒ½æ˜¯<code>RibbonClientSpecification</code>ç±»å‹ã€‚</p><h4 id="autoconfigureafter" tabindex="-1"><a class="header-anchor" href="#autoconfigureafter" aria-hidden="true">#</a> @AutoConfigureAfter</h4><p>è¿™ä¸ªæ³¨è§£æ˜¯ç”¨æ¥æ§åˆ¶è‡ªåŠ¨è£…é…ç±»çš„åŠ è½½é¡ºåºçš„ï¼Œå…ˆåŠ è½½è¯¥æ³¨è§£ä¸­å¼•å…¥çš„è‡ªåŠ¨é…ç½®ç±»ï¼Œåœ¨åŠ è½½å½“å‰çš„è‡ªåŠ¨é…ç½®ç±»ã€‚è¯¥æ³¨è§£ä¸­å¼•å…¥çš„è‡ªåŠ¨è£…é…ç±»<code>EurekaClientAutoConfiguration</code>æ˜¯ç”¨æ¥è‡ªåŠ¨è£…é…Eurekaçš„ï¼Œç›®å‰æ²¡æœ‰ç”¨åˆ°ã€‚</p><h4 id="autoconfigurebefore" tabindex="-1"><a class="header-anchor" href="#autoconfigurebefore" aria-hidden="true">#</a> @AutoConfigureBefore</h4><p>æ§åˆ¶è‡ªåŠ¨è£…é…ç±»çš„åŠ è½½é¡ºåºï¼Œåœ¨åŠ è½½å®Œå½“å‰è‡ªåŠ¨è£…é…ç±»ååœ¨è®°è½½è¯¥æ³¨è§£ä¸­çš„è‡ªåŠ¨è£…é…ç±»ã€‚è¯¥æ³¨è§£ä¸­å¼•å…¥çš„è¿ä¸ªé…ç½®ç±»LoadBalancerAutoConfiguration.class, AsyncLoadBalancerAutoConfiguration.class åé¢åœ¨ä»‹ç»ã€‚</p><h4 id="enableconfigurationproperties" tabindex="-1"><a class="header-anchor" href="#enableconfigurationproperties" aria-hidden="true">#</a> @EnableConfigurationProperties</h4><p>è¿™ä¸ªæ˜¯ç”¨æ¥å¯ç”¨é…ç½®é¡¹çš„ã€‚</p><h4 id="conditionalonproperty" tabindex="-1"><a class="header-anchor" href="#conditionalonproperty" aria-hidden="true">#</a> @ConditionalOnProperty</h4><p>å¯ç”¨æ¡ä»¶ï¼Œé»˜è®¤æ˜¯å¯ç”¨çš„ã€‚</p><h3 id="ribbonautoconfiguration" tabindex="-1"><a class="header-anchor" href="#ribbonautoconfiguration" aria-hidden="true">#</a> RibbonAutoConfiguration</h3><p>ä¸Šé¢è®²è§£äº†ä¸€äº›è‡ªåŠ¨åŠ¨è£…é…ç±»<code>RibbonAutoConfiguration</code>ä¸Šçš„æ¡ä»¶æ³¨è§£ï¼Œä¸‹é¢æ¥çœ‹çœ‹è¿™ä¸ªè‡ªåŠ¨è£…é…ç±»æ³¨å…¥äº†é‚£äº›beanã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RibbonClientSpecification</span><span class="token punctuation">&gt;</span></span> configurations <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">RibbonEagerLoadProperties</span> ribbonEagerLoadProperties<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸¤ä¸ªè‡ªåŠ¨æ³¨å…¥çš„å±æ€§æ˜¯é€šè¿‡ä¸Šé¢çš„æ³¨è§£åŠ è½½çš„ï¼Œconfigurationsæ˜¯åœ¨è§£æ@RibbonClientsæ³¨è§£æ—¶æ³¨å…¥çš„beanï¼Œè€ŒribbonEagerLoadPropertiesæ˜¯æ¿€æ´»çš„é…ç½®ç±»ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span>
<span class="token keyword">public</span> <span class="token class-name">SpringClientFactory</span> <span class="token function">springClientFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SpringClientFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpringClientFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    factory<span class="token punctuation">.</span><span class="token function">setConfigurations</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>configurations<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> factory<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>TODO</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token class-name">LoadBalancerClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">LoadBalancerClient</span> <span class="token function">loadBalancerClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RibbonLoadBalancerClient</span><span class="token punctuation">(</span><span class="token function">springClientFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡ŒåŠ è½½LoadBalancerClientçš„å®ä¾‹ï¼Œé»˜è®¤å®ç°ä¸º<code>RibbonLoadBalancerClient</code></p><p>æ³¨å…¥RestTemplateçš„å®šåˆ¶å™¨ï¼Œ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">HttpRequest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnRibbonRestClient</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">RibbonClientHttpRequestFactoryConfiguration</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SpringClientFactory</span> springClientFactory<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplateCustomizer</span> <span class="token function">restTemplateCustomizer</span><span class="token punctuation">(</span>
        <span class="token keyword">final</span> <span class="token class-name">RibbonClientHttpRequestFactory</span> ribbonClientHttpRequestFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> restTemplate <span class="token operator">-&gt;</span> restTemplate
            <span class="token punctuation">.</span><span class="token function">setRequestFactory</span><span class="token punctuation">(</span>ribbonClientHttpRequestFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RibbonClientHttpRequestFactory</span> <span class="token function">ribbonClientHttpRequestFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RibbonClientHttpRequestFactory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>springClientFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨å…¥PropertiesFactory</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span>
<span class="token keyword">public</span> <span class="token class-name">PropertiesFactory</span> <span class="token function">propertiesFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PropertiesFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="loadbalancerautoconfiguration" tabindex="-1"><a class="header-anchor" href="#loadbalancerautoconfiguration" aria-hidden="true">#</a> LoadBalancerAutoConfiguration</h3><h2 id="spring-cloud-ribbonä¸­é‡è¦çš„ç»„ä»¶" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ribbonä¸­é‡è¦çš„ç»„ä»¶" aria-hidden="true">#</a> Spring Cloud Ribbonä¸­é‡è¦çš„ç»„ä»¶</h2><h3 id="iclientconfig" tabindex="-1"><a class="header-anchor" href="#iclientconfig" aria-hidden="true">#</a> IClientConfig</h3><p>å®¢æˆ·ç«¯é…ç½®</p><h3 id="loadbalancerstatus" tabindex="-1"><a class="header-anchor" href="#loadbalancerstatus" aria-hidden="true">#</a> LoadBalancerStatus</h3><p>æœåŠ¡ç›¸å…³æ•°æ®ç»Ÿè®¡</p><h2 id="spring-cloud-ribbonä¸­çš„ç›‘æ§ç»„ä»¶" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ribbonä¸­çš„ç›‘æ§ç»„ä»¶" aria-hidden="true">#</a> Spring Cloud Ribbonä¸­çš„ç›‘æ§ç»„ä»¶</h2><p>åœ¨Ribbonä¸­ï¼Œä¸€äº›è´Ÿè½½å‡è¡¡ç­–ç•¥åœ¨åšè´Ÿè½½æ—¶ï¼Œéœ€è¦æ ¹æ®ä¸€äº›ç»Ÿè®¡ä¿¡æ¯æ¥åšåˆ¤æ–­ï¼Œä¾‹å¦‚å¹³å‡å“åº”æ—¶é—´ï¼Œç´¯è®¡å¤±è´¥æ¬¡æ•°ï¼Œç†”æ–­æ§åˆ¶ç­‰ã€‚åŸºäºæ­¤ï¼Œribboné‡å®ç°äº†ä¸€ä¸ªç®€ç‰ˆçš„ç›‘æ§ç³»ç»Ÿï¼ŒåŒ…å«å¦‚ä¸‹ä¸€äº›ç»„ä»¶ï¼Œå¦‚ribbon-statisticdsåŒ…ï¼ŒServerStatsä»¥åŠLoadBalancerStatsã€‚æ¥ä¸‹æ¥é€ä¸ªå‡»ç ´ã€‚</p><h3 id="åŸºç¡€å·¥å…·åŒ…" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€å·¥å…·åŒ…" aria-hidden="true">#</a> åŸºç¡€å·¥å…·åŒ…</h3><p>åœ¨netflix-statisticsåŒ…ä¸­ï¼Œribbonä¸ºæˆ‘ä»¬æä¾›äº†ä¸€äº›åŸºç¡€å·¥å…·ç±»ï¼Œè¯¥å·¥å…·åŒ…çš„è®¾è®¡ç›®çš„æ—¶ä¸ºäº†ç®€åŒ–æŒ‡æ ‡æ•°æ®æ”¶é›†ã€é€»è¾‘è®¡ç®—ç­‰ã€‚åœ¨è¯¥å·¥å…·åŒ…ä¸­ä»…æœ‰åä¸ªç±»å®šä¹‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹æ•´ä½“çš„ç±»å›¾ï¼š</p><p><img src="/assets/image-20220707151731227-52b6282c.png" alt="image-20220707151731227"></p><p>è¿™é‡Œè¾¹åŸºç¡€åŠŸèƒ½æ¥å£åŸºæœ¬éƒ½æ˜¯åœ¨DataCollectorè¿™ä¸ªåˆ†æ”¯ï¼Œåœ¨DistributionMBeanè¿™ä¸ªåˆ†æ”¯å®šä¹‰çš„éƒ½æ˜¯è·å–æ•°æ®çš„æ¥å£ã€‚</p><h4 id="datacollector" tabindex="-1"><a class="header-anchor" href="#datacollector" aria-hidden="true">#</a> DataCollector</h4><p>æ•°æ®æ”¶é›†ï¼Œä»¥å¢é‡çš„æ–¹å¼æ”¶é›†æ•°æ®ã€‚è¯¥æ¥å£éå¸¸ç®€å•ï¼Œä»…ä¸€ä¸ªå¢é‡æ”¶é›†æ•°æ®çš„æ–¹æ³•ã€‚ä»–æ˜¯æ•°æ®çš„å”¯ä¸€æ¥æºï¼Œå…¶ä»–ä¸€åˆ‡ä¸ºå›´ç»•è¯¥æ¥å£è¿›è¡Œå±•å¼€ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">DataCollector</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * å‘æ”¶é›†çš„æ•°æ®ä¸­æ·»åŠ ä¸€ä¸ªå€¼
     */</span>
    <span class="token keyword">void</span> <span class="token function">noteValue</span><span class="token punctuation">(</span><span class="token keyword">double</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="distributionmbean" tabindex="-1"><a class="header-anchor" href="#distributionmbean" aria-hidden="true">#</a> DistributionMBean</h4><p>è¯¥æ¥å£å®šä¹‰äº†ä¸€äº›è·å–æ•°æ®çš„æ–¹å¼</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">DistributionMBean</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**  æ¸…æ¥šæ•°æ® */</span>
    <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** è·å–æ¬¡æ•° */</span>
    <span class="token keyword">long</span> <span class="token function">getNumValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** è·å–å¹³å‡å€¼ */</span>
    <span class="token keyword">double</span> <span class="token function">getMean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** è·å–æ–¹å·® */</span>
    <span class="token keyword">double</span> <span class="token function">getVariance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** è·å–æ ‡å‡†å·® */</span>
    <span class="token keyword">double</span> <span class="token function">getStdDev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** è·å–æœ€å°å€¼ */</span>
    <span class="token keyword">double</span> <span class="token function">getMinimum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** è·å–æœ€å¤§å€¼ */</span>
    <span class="token keyword">double</span> <span class="token function">getMaximum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="distribution" tabindex="-1"><a class="header-anchor" href="#distribution" aria-hidden="true">#</a> Distribution</h4><p>åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç´¯åŠ å™¨ï¼Œæä¾›äº†å¯¹å¤šç»´åº¦çš„æ•°æ®ç»Ÿè®¡ã€‚ä»¥å¢é‡çš„æ–¹å¼äº§ç”Ÿè§‚æµ‹å€¼ã€‚è¯¥ç»„ä»¶é™¤äº†å®ç°äº†DataCollectorä»¥å¤–ï¼Œè¿˜å®ç°äº†DistributionMBeanæ¥å£</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Distribution</span> <span class="token keyword">implements</span> <span class="token class-name">DistributionMBean</span><span class="token punctuation">,</span> <span class="token class-name">DataCollector</span> <span class="token punctuation">{</span>
	<span class="token comment">// ç´¯åŠ å€¼çš„æ¬¡æ•°</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> numValues<span class="token punctuation">;</span>
    <span class="token comment">// æ‰€æœ‰å€¼å¾—æ€»å’Œ</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> sumValues<span class="token punctuation">;</span>
    <span class="token comment">// å€¼ å¹³æ–¹çš„æ€»å’Œ</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> sumSquareValues<span class="token punctuation">;</span>
    <span class="token comment">// æœ€å¤§å€¼</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> minValue<span class="token punctuation">;</span>
    <span class="token comment">// æœ€å°å€¼</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> maxValue<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** æ„é€ å‡½æ•°ï¼Œåˆ›å»ºä¸€ä¸ªç©ºå®ä¾‹ */</span>
    <span class="token keyword">public</span> <span class="token class-name">Distribution</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        numValues <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
        sumValues <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
        sumSquareValues <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
        minValue <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
        maxValue <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** ç´¯åŠ æ–°å€¼ */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">noteValue</span><span class="token punctuation">(</span><span class="token keyword">double</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        numValues<span class="token operator">++</span><span class="token punctuation">;</span>
        sumValues <span class="token operator">+=</span> val<span class="token punctuation">;</span>
        sumSquareValues <span class="token operator">+=</span> val <span class="token operator">*</span> val<span class="token punctuation">;</span>
        <span class="token comment">// è®¡ç®—æœ€å¤§å€¼ã€æœ€å°å€¼</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>numValues <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            minValue <span class="token operator">=</span> val<span class="token punctuation">;</span>
            maxValue <span class="token operator">=</span> val<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">&lt;</span> minValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            minValue <span class="token operator">=</span> val<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">&gt;</span> maxValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            maxValue <span class="token operator">=</span> val<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// æ¸…æ¥šæ•°æ®</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** æ¬¡æ•° */</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getNumValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> numValues<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** è·å–å¹³å‡å€¼ */</span>
    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">getMean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>numValues <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> sumValues <span class="token operator">/</span> numValues<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** è®¡ç®—æ–¹å·® */</span>
    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">getVariance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>numValues <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sumValues <span class="token operator">==</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">double</span> mean <span class="token operator">=</span> <span class="token function">getMean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>sumSquareValues <span class="token operator">/</span> numValues<span class="token punctuation">)</span> <span class="token operator">-</span> mean <span class="token operator">*</span> mean<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** æ ‡å‡†å·® */</span>
    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">getStdDev</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token function">getVariance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** æœ€å°å€¼ */</span>
    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">getMinimum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> minValue<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** æœ€å¤§å€¼ */</span>
    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">getMaximum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> maxValue<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** å°†ä¸¤ä¸ªDistributionç›¸åŠ   */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Distribution</span> anotherDistribution<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>anotherDistribution <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            numValues <span class="token operator">+=</span> anotherDistribution<span class="token punctuation">.</span>numValues<span class="token punctuation">;</span>
            sumValues <span class="token operator">+=</span> anotherDistribution<span class="token punctuation">.</span>sumValues<span class="token punctuation">;</span>
            sumSquareValues <span class="token operator">+=</span> anotherDistribution<span class="token punctuation">.</span>sumSquareValues<span class="token punctuation">;</span>
            minValue <span class="token operator">=</span> <span class="token punctuation">(</span>minValue <span class="token operator">&lt;</span> anotherDistribution<span class="token punctuation">.</span>minValue<span class="token punctuation">)</span> <span class="token operator">?</span> minValue
                    <span class="token operator">:</span> anotherDistribution<span class="token punctuation">.</span>minValue<span class="token punctuation">;</span>
            maxValue <span class="token operator">=</span> <span class="token punctuation">(</span>maxValue <span class="token operator">&gt;</span> anotherDistribution<span class="token punctuation">.</span>maxValue<span class="token punctuation">)</span> <span class="token operator">?</span> maxValue
                    <span class="token operator">:</span> anotherDistribution<span class="token punctuation">.</span>maxValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œéœ€è¦æ³¨æ„åˆ°ä¸€ç‚¹ï¼Œè¯¥ç±»æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚</p><h4 id="databuffer" tabindex="-1"><a class="header-anchor" href="#databuffer" aria-hidden="true">#</a> DataBuffer</h4><p>è¯¥ç±»æ˜¯Distributionçš„å­ç±» ï¼Œåœ¨çˆ¶ç±»çš„åŸºç¡€ä¸Šå¢åŠ äº†ä¸€ä¸ªç¼“å†²åŒºï¼Œå¹¶é…åˆstartCollectionå’ŒendCollectionåŠ¨ä½œï¼Œå®Œæˆå¯¹ä¸€ä¸ªå‘¨æœŸæ•°æ®çš„æ”¶é›†ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataBuffer</span> <span class="token keyword">extends</span> <span class="token class-name">Distribution</span> <span class="token punctuation">{</span>
	<span class="token comment">// é”</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Lock</span> lock<span class="token punctuation">;</span>
    <span class="token comment">// ç¼“å†²åŒº</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf<span class="token punctuation">;</span>
    <span class="token comment">// å‘¨æœŸå¼€å§‹æ—¶é—´æˆ³</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> startMillis<span class="token punctuation">;</span>
    <span class="token comment">// å‘¨æœŸç»“æŸæ—¶é—´æˆ³</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> endMillis<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> size<span class="token punctuation">;</span>
    <span class="token comment">// bufä¸­å½“å‰å†™å…¥çš„ä½ç½®</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> insertPos<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** æ„é€ å‡½æ•°ï¼Œåˆå§‹åŒ– */</span>
    <span class="token keyword">public</span> <span class="token class-name">DataBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">double</span><span class="token punctuation">[</span>capacity<span class="token punctuation">]</span><span class="token punctuation">;</span>
        startMillis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        insertPos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

   <span class="token comment">// è·å–é”</span>
    <span class="token keyword">public</span> <span class="token class-name">Lock</span> <span class="token function">getLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> lock<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** è·å–ç¼“å†²åŒºé•¿åº¦ */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> buf<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** è·å–å‘¨æœŸé•¿åº¦ */</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getSampleIntervalMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">(</span>endMillis <span class="token operator">-</span> startMillis<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** è·å–size */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getSampleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> size<span class="token punctuation">;</span> <span class="token punctuation">}</span>
   
    <span class="token doc-comment comment">/** æ¸…ç©ºæ•°æ® */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** å¼€å§‹å‘¨æœŸ */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        startMillis <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** ç»“æŸå‘¨æœŸ */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">endCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        endMillis <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** ç´¯åŠ å€¼ */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">noteValue</span><span class="token punctuation">(</span><span class="token keyword">double</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">noteValue</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        buf<span class="token punctuation">[</span>insertPos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
        <span class="token comment">// è¿™é‡Œå½“indexå¤§äºç¼“å†²åŒºé•¿åº¦æ—¶ï¼Œä¼šé‡æ–°setåˆ°0çš„ä½ç½®</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>insertPos <span class="token operator">&gt;=</span> buf<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            insertPos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            size <span class="token operator">=</span> buf<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>insertPos <span class="token operator">&gt;</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            size <span class="token operator">=</span> insertPos<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** è®¡ç®—åˆ†ä½æ•° */</span>
    <span class="token keyword">public</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getPercentiles</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> percents<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> percentiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> percents<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è®¡ç®—ç™¾åˆ†æ¯”ç»Ÿè®¡ä¿¡æ¯ã€‚æ¯”å¦‚è‹¥percents[i] = 50çš„è¯</span>
			<span class="token comment">// å°±æ˜¯è®¡ç®—bufç¼“å†²åŒºé‡Œä¸­ä½æ•°çš„å€¼</span>
			<span class="token comment">// 90çš„è¯ï¼šè®¡ç®—90åˆ†ä½æ•°çš„å€¼ï¼ˆä¹Ÿå°±æ˜¯è¯¥å€¼æ¯”90%çš„æ•°å€¼éƒ½å¤§ï¼‰</span>
			<span class="token comment">// computePercentileæ˜¯ç§æœ‰æ–¹æ³•ï¼šæ ¹æ®å½“å‰çª—å£å†…æ”¶é›†åˆ°çš„æ•°æ®è¿›è¡Œè®¡ç®—åˆ†ä½æ•°</span>
            percentiles<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">computePercentile</span><span class="token punctuation">(</span>percents<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> percentiles<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">double</span> <span class="token function">computePercentile</span><span class="token punctuation">(</span><span class="token keyword">double</span> percent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Some just-in-case edge cases</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>percent <span class="token operator">&lt;=</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>percent <span class="token operator">&gt;=</span> <span class="token number">100.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// SUPPRESS CHECKSTYLE MagicNumber</span>
            <span class="token keyword">return</span> buf<span class="token punctuation">[</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">double</span> index <span class="token operator">=</span> <span class="token punctuation">(</span>percent <span class="token operator">/</span> <span class="token number">100.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> size<span class="token punctuation">;</span> <span class="token comment">// SUPPRESS CHECKSTYLE MagicNumber</span>
        <span class="token keyword">int</span> iLow <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> iHigh <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> <span class="token number">0</span> <span class="token operator">&lt;=</span> iLow <span class="token operator">&amp;&amp;</span> iLow <span class="token operator">&lt;=</span> index <span class="token operator">&amp;&amp;</span> index <span class="token operator">&lt;=</span> iHigh <span class="token operator">&amp;&amp;</span> iHigh <span class="token operator">&lt;=</span> size<span class="token punctuation">;</span>
        <span class="token keyword">assert</span> <span class="token punctuation">(</span>iHigh <span class="token operator">-</span> iLow<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>iHigh <span class="token operator">&gt;=</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> buf<span class="token punctuation">[</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token comment">// Another edge case</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>iLow <span class="token operator">==</span> iHigh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> buf<span class="token punctuation">[</span>iLow<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Interpolate between the two bounding values</span>
            <span class="token keyword">return</span> buf<span class="token punctuation">[</span>iLow<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span>index <span class="token operator">-</span> iLow<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>buf<span class="token punctuation">[</span>iHigh<span class="token punctuation">]</span> <span class="token operator">-</span> buf<span class="token punctuation">[</span>iLow<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="histogram" tabindex="-1"><a class="header-anchor" href="#histogram" aria-hidden="true">#</a> Histogram</h4><p>histogram æ˜¯ç›´æ–¹å›¾çš„æ„æ€ã€‚ä»–çš„ä½œç”¨å°±æ˜¯æŠŠæ•°æ®åˆ†æ¡¶ï¼Œå¹¶æä¾›ä¸€äº›ç»Ÿè®¡æ–¹æ³•ã€‚</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="dataaccumulator" tabindex="-1"><a class="header-anchor" href="#dataaccumulator" aria-hidden="true">#</a> DataAccumulator</h4><p>æ•°æ®ç´¯åŠ å™¨ã€‚è¯¥ç±»æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå†…éƒ¨ä½¿ç”¨äº†ä¸¤ä¸ªç¼“å†²åŒºã€‚</p><ul><li>currentï¼šç”¨äºæ·»åŠ æ–°æ•°æ®</li><li>previousï¼šç”¨äºå­˜å‚¨ä¸Šä¸€ä¸ªå‘¨æœŸå†…æ¢å­˜å‚¨æ”¶é›†åˆ°çš„æ•°æ®</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">DataAccumulator</span> <span class="token keyword">implements</span> <span class="token class-name">DataCollector</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">DataBuffer</span> current<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">DataBuffer</span> previous<span class="token punctuation">;</span>
    <span class="token comment">// swapé”ï¼Œæ”¶é›†æ•°æ®å’Œäº¤æ¢æ•°æ®æ˜¯å¼‚æ­¥çš„ã€‚</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> swapLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token doc-comment comment">/** æ„é€ æ–¹æ³•
     *  è¿™æ˜¯å”¯ä¸€çš„æ„é€ æ–¹æ³•ï¼Œå¿…é¡»åˆ¶å®šç¼“å†²åŒºçš„å¤§å°ã€‚
     *  ä»–å†³å®šäº†ç¼“å†²åŒºçš„æ•°æ®æ‰¿è½½é‡ï¼Œæ¯”å¦‚è®¾ç½®äº†10ï¼Œ é‚£ä¹ˆå³ä½¿æœ‰å†å¤šçš„æ•°æ®è¿‡æ¥ï¼Œä¹Ÿåªç¼“å­˜æœ€è¿‘çš„10æ¡ã€‚ */</span>
    <span class="token keyword">public</span> <span class="token class-name">DataAccumulator</span><span class="token punctuation">(</span><span class="token keyword">int</span> bufferSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataBuffer</span><span class="token punctuation">(</span>bufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>previous <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataBuffer</span><span class="token punctuation">(</span>bufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** æ”¶é›†æ•°æ®çš„æ–¹æ³• */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">noteValue</span><span class="token punctuation">(</span><span class="token keyword">double</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>swapLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Lock</span> l <span class="token operator">=</span> current<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            l<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                current<span class="token punctuation">.</span><span class="token function">noteValue</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                l<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‰©ä¸‹çš„å°±æ˜¯æ•°æ®äº¤æ¢äº†ï¼Œè¿™ä¸ªåŠŸèƒ½ä¹Ÿæ˜¯è¯¥æ‰©å±•çš„ä¸€ä¸ªæ ¸å¿ƒåŠŸèƒ½ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">publish</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DataBuffer</span> tmp <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">Lock</span> l <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>swapLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// äº¤æ¢ç¼“å†²åŒº</span>
        tmp <span class="token operator">=</span> current<span class="token punctuation">;</span>
        current <span class="token operator">=</span> previous<span class="token punctuation">;</span>
        previous <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
        <span class="token comment">// å¼€åŒºæ–°çš„æ”¶é›†å‘¨æœŸ</span>
        l <span class="token operator">=</span> current<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        l<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            current<span class="token punctuation">.</span><span class="token function">startCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            l<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// è·å–è€ç¼“å†²åŒºçš„é”</span>
        l <span class="token operator">=</span> tmp<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        l<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// åœ¨å¤„ç†è€æ•°æ®ä¹‹å‰é‡Šæ”¾é”</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        tmp<span class="token punctuation">.</span><span class="token function">endCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è¿™ä¸ªæ˜¯æŠ½è±¡æ–¹æ³•ï¼Œç”±å­ç±»å®ç°ã€‚</span>
        <span class="token function">publish</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        l<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯¥æ–¹æ³•çš„ä¸»è¦ä½œç”¨å°±æ˜¯å¯¹æ–°è€ç¼“å†²åŒºåšä¸€ä¸ªäº¤æ¢ï¼Œå½“ç„¶ï¼Œäº¤æ¢ä¹‹å‰éœ€è¦åŠ é”ã€‚äº¤æ¢å®Œæˆä¹‹åï¼ŒæŠŠè€çš„ç¼“å†²åŒºä¸­çš„æ•°æ®æ‹¿å»åšè®¡ç®—ã€‚è®¡ç®—çš„æ–¹æ³•æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œåœ¨å­ç±»ä¸­å®ç°ã€‚</p><h4 id="datadistribution" tabindex="-1"><a class="header-anchor" href="#datadistribution" aria-hidden="true">#</a> DataDistribution</h4><p>è¯¥ç±»å°±æ˜¯DataAccumulatorçš„å®ç°ç±»äº†ï¼Œå®ç°äº†å…·ä½“çš„è®¡ç®—é€»è¾‘ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataDistribution</span> <span class="token keyword">extends</span> <span class="token class-name">DataAccumulator</span> <span class="token keyword">implements</span> <span class="token class-name">DataDistributionMBean</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">long</span> numValues <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> mean <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> variance <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> stddev <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> min <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> max <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> ts <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> interval <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> percents<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> percentiles<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** æ„é€ å‡½æ•° */</span>
    <span class="token keyword">public</span> <span class="token class-name">DataDistribution</span><span class="token punctuation">(</span><span class="token keyword">int</span> bufferSize<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> percents<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>bufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ç®€å•çš„æ ¡éªŒ</span>
        <span class="token keyword">assert</span> <span class="token function">percentsOK</span><span class="token punctuation">(</span>percents<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>percents <span class="token operator">=</span> percents<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>percentiles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">double</span><span class="token punctuation">[</span>percents<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        
    <span class="token doc-comment comment">/** è®¡ç®—é€»è¾‘ */</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">publish</span><span class="token punctuation">(</span><span class="token class-name">DataBuffer</span> buf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ts <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        numValues <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">getNumValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mean <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">getMean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        variance <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">getVariance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stddev <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">getStdDev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        min <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">getMinimum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        max <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">getMaximum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        interval <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">getSampleIntervalMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        size <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">getSampleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        buf<span class="token punctuation">.</span><span class="token function">getPercentiles</span><span class="token punctuation">(</span>percents<span class="token punctuation">,</span> percentiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** æ¸…ç†æ•°æ® */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>publish</code>ä¸€æ¬¡äº§ç”Ÿ<strong>ä¸€æ‰¹æ–°å€¼</strong>ï¼Œè¿™ä¸ªæ—¶å€™ä½ è‹¥æŠŠå®ƒæŒä¹…åŒ–ä¸‹æ¥ä»¥åå°±èƒ½å‚è€ƒå–½ã€‚ç„¶åè¿›å…¥åˆ°<strong>ä¸‹ä¸€è½®</strong>çš„æ•°æ®æ”¶é›†ï¼Œæ‰€ä»¥è¯´publishçš„è°ƒç”¨èŠ‚å¥å†³å®šäº†å®ƒçš„æ•°æ®æ”¶é›†çš„æ—¶é—´çª—å£ã€‚</p><h4 id="datapublisher" tabindex="-1"><a class="header-anchor" href="#datapublisher" aria-hidden="true">#</a> DataPublisher</h4><p>è¿™æ˜¯ä¸€ä¸ªç°æˆçš„ç±»ï¼Œä»–ä¼šå¯åŠ¨ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œå‘¨æœŸæ€§çš„è°ƒç”¨publishæ–¹æ³•ã€‚</p><p>é¦–å…ˆæ¥çœ‹çœ‹å±æ€§å’Œæ„é€ æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataPublisher</span> <span class="token punctuation">{</span>
	<span class="token comment">// å¸¸é‡ï¼Œåˆ¶å®šçº¿ç¨‹å</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">THREAD_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;DataPublisher&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// Demoçº¿ç¨‹</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token constant">DAEMON_THREADS</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">// æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ± </span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ScheduledExecutorService</span> sharedExecutor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token comment">// æ•°æ®ç´¯åŠ å™¨</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DataAccumulator</span> accumulator<span class="token punctuation">;</span>
    <span class="token comment">// æ‰§è¡Œä»»åŠ¡çš„æ—¶é—´é—´éš”</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> delayMillis<span class="token punctuation">;</span>
    <span class="token comment">// ä»»åŠ¡çš„è¿”å›ç»“æœ</span>
    <span class="token keyword">private</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** æ„é€ æ–¹æ³• ï¼Œéœ€è¦æŒ‡å®šç´¯åŠ å™¨å’Œçº¿ç¨‹çš„æ‰§è¡Œå‘¨æœŸ */</span>
    <span class="token keyword">public</span> <span class="token class-name">DataPublisher</span><span class="token punctuation">(</span><span class="token class-name">DataAccumulator</span> accumulator<span class="token punctuation">,</span> <span class="token keyword">long</span> delayMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator <span class="token operator">=</span> accumulator<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>delayMillis <span class="token operator">=</span> delayMillis<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‹é¢æ˜¯å¼€å¯å®šæ—¶ä»»åŠ¡ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// å¯åŠ¨å®šæ—¶ä»»åŠ¡</span>
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>future <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Runnable</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    accumulator<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">handleException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        future <span class="token operator">=</span> <span class="token function">getExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleWithFixedDelay</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> delayMillis<span class="token punctuation">,</span> delayMillis<span class="token punctuation">,</span>  
                                                      <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/** åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ±  */</span>
<span class="token keyword">protected</span> <span class="token keyword">synchronized</span> <span class="token class-name">ScheduledExecutorService</span> <span class="token function">getExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sharedExecutor <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sharedExecutor <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">PublishThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> sharedExecutor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// çº¿ç¨‹å·¥å‚</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">PublishThreadFactory</span> <span class="token keyword">implements</span> <span class="token class-name">ThreadFactory</span> <span class="token punctuation">{</span>
    <span class="token class-name">PublishThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">Thread</span> <span class="token function">newThread</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token constant">THREAD_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token constant">DAEMON_THREADS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> t<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä¸€ä¸ªç®€å•çš„ä½¿ç”¨æ¡ˆä¾‹" tabindex="-1"><a class="header-anchor" href="#ä¸€ä¸ªç®€å•çš„ä½¿ç”¨æ¡ˆä¾‹" aria-hidden="true">#</a> ä¸€ä¸ªç®€å•çš„ä½¿ç”¨æ¡ˆä¾‹</h4><p>ç•¥</p><h3 id="serverstats" tabindex="-1"><a class="header-anchor" href="#serverstats" aria-hidden="true">#</a> ServerStats</h3><p><strong>æœåŠ¡çŠ¶æ€</strong>ã€‚åœ¨LoadBalancerä¸­æ•è·æ¯ä¸ªæœåŠ¡å™¨(èŠ‚ç‚¹)çš„å„ç§çŠ¶æ€ï¼Œæ¯ä¸ªServerå°±å¯¹åº”ç€ä¸€ä¸ª<code>ServerStats</code>å®ä¾‹ã€‚ServerStatsè¡¨ç¤ºä¸€å°Serverçš„çŠ¶æ€ï¼Œå„ç§çº¬åº¦çš„ç»Ÿè®¡æ•°æ®æ‰èƒ½ä½¿å¾—ä½ æœ€ç»ˆæŒ‘é€‰å‡ºä¸€ä¸ª<strong>æœ€é€‚åˆ</strong>çš„Serverä¾›ä»¥ä½¿ç”¨ï¼Œä»¥åŠè®¡ç®—å…¶å½“å‰è®¿é—®å‹åŠ›ï¼ˆå¹¶å‘æ•°ï¼‰ã€æˆåŠŸæ•°ã€å¤±è´¥æ•°ã€æ˜¯å¦ç†”æ–­ã€ç†”æ–­äº†å¤šä¹…ç­‰ç­‰ã€‚</p><h4 id="ç»Ÿè®¡æ•°æ®-å±æ€§" tabindex="-1"><a class="header-anchor" href="#ç»Ÿè®¡æ•°æ®-å±æ€§" aria-hidden="true">#</a> ç»Ÿè®¡æ•°æ®/å±æ€§</h4><p>åˆ°åº•ç»Ÿè®¡äº†å“ªäº›æ•°æ®å‘¢ï¼Ÿå¯¹Serverè¿›è¡Œ<strong>å¤šç»´åº¦</strong>çš„æ•°æ®ç»Ÿè®¡ï¼Œå‡ä½“ç°åœ¨å®ƒçš„æˆå‘˜å±æ€§ä¸Šï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServerStats</span> <span class="token punctuation">{</span>
    <span class="token comment">// é»˜è®¤60sï¼ˆ1åˆ†é’Ÿï¼‰publishä¸€æ¬¡æ•°æ®</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_PUBLISH_INTERVAL</span> <span class="token operator">=</span>  <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span> 
    <span class="token comment">// ç¼“å†²åŒºå¤§å°ã€‚è¿™ä¸ªé»˜è®¤å¤§å°å¯è°“éå¸¸å¤§å‘€ï¼Œå°±ç®—ä½ QPSæ˜¯1000ï¼Œä¹Ÿèƒ½æŠ—1åˆ†é’Ÿ</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_BUFFER_SIZE</span> <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span> 
    <span class="token comment">// æ¥è¿å¤±è´¥çš„é˜ˆå€¼ï¼Œé»˜è®¤å€¼3ï¼Œè¶…è¿‡å°±ç†”æ–­</span>
    <span class="token comment">// é»˜è®¤é…ç½® niws.loadbalancer.default.connectionFailureCountThresholdï¼Œé»˜è®¤å€¼3</span>
    <span class="token comment">// è‡ªå®šä¹‰é…ç½®ï¼šniws.loadbalancer.&lt;c&gt;.connectionFailureCountThreshold</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CachedDynamicIntProperty</span> connectionFailureThreshold<span class="token punctuation">;</span>
    <span class="token comment">// æ–­è·¯å™¨è¶…æ—¶å› å­ï¼Œé»˜è®¤10ç§’</span>
    <span class="token comment">// é»˜è®¤é…ç½® niws.loadbalancer.default.circuitTripTimeoutFactorSeconds</span>
    <span class="token comment">// è‡ªå®šä¹‰é…ç½®ï¼š niws.loadbalancer.&lt;clientName&gt;.circuitTripTimeoutFactorSeconds</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CachedDynamicIntProperty</span> circuitTrippedTimeoutFactor<span class="token punctuation">;</span>
    <span class="token comment">// æ–­è·¯å™¨æœ€å¤§è¶…æ—¶ç§’æ•°ï¼Œ é»˜è®¤30s</span>
    <span class="token comment">// é»˜è®¤é…ç½®ï¼šniws.loadbalancer.default.circuitTripMaxTimeoutSeconds</span>
    <span class="token comment">// è‡ªå®šä¹‰é…ç½®ï¼šniws.loadbalancer.&lt;clientName&gt;.circuitTripMaxTimeoutSeconds </span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CachedDynamicIntProperty</span> maxCircuitTrippedTimeout<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">DynamicIntProperty</span> activeRequestsCountTimeout <span class="token operator">=</span> 
        <span class="token class-name">DynamicPropertyFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">getIntProperty</span><span class="token punctuation">(</span><span class="token string">&quot;niws.loadbalancer.serverStats.activeRequestsCount.effectiveWindowSeconds&quot;</span><span class="token punctuation">,</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">PERCENTS</span> <span class="token operator">=</span> <span class="token function">makePercentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token class-name">DataDistribution</span> dataDist <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataDistribution</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">PERCENTS</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// in case</span>
    <span class="token keyword">private</span> <span class="token class-name">DataPublisher</span> publisher <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Distribution</span> responseTimeDist <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Distribution</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">int</span> bufferSize <span class="token operator">=</span> <span class="token constant">DEFAULT_BUFFER_SIZE</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> publishInterval <span class="token operator">=</span> <span class="token constant">DEFAULT_PUBLISH_INTERVAL</span><span class="token punctuation">;</span>
    
    <span class="token comment">// å¤±è´¥æ¬¡æ•°ç»Ÿè®¡æ—¶é—´çª—ã€‚é»˜è®¤å€¼1000ms</span>
    <span class="token keyword">long</span> failureCountSlidingWindowInterval <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span> 
    <span class="token comment">// ä¸Šä¸€ç§’å¤±è´¥æ¬¡æ•°ï¼ˆä¸Šä¸€ç§’æ˜¯å› ä¸ºfailureCountSlidingWindowIntervalé»˜è®¤è‡ªæ˜¯1000ms)</span>
    <span class="token keyword">private</span> <span class="token class-name">MeasuredRate</span> serverFailureCounts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MeasuredRate</span><span class="token punctuation">(</span>failureCountSlidingWindowInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ä¸€ä¸ªçª—å£æœŸå†…çš„è¯·æ±‚æ€»æ•°ï¼Œçª—å£æœŸé»˜è®¤ä¸º5åˆ†é’Ÿï¼ˆ300ç§’ï¼‰ </span>
    <span class="token keyword">private</span> <span class="token class-name">MeasuredRate</span> requestCountInWindow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MeasuredRate</span><span class="token punctuation">(</span><span class="token number">300000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">Server</span> server<span class="token punctuation">;</span>
    <span class="token comment">// æ€»çš„è¯·æ±‚æ•°é‡ï¼Œæ¯æ¬¡è¯·æ±‚ç»“æŸ/é”™è¯¯æ—¶å°±ä¼š+1ã€‚</span>
    <span class="token class-name">AtomicLong</span> totalRequests <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¿ç»­ï¼ˆsuccessiveï¼‰è¯·æ±‚å¼‚å¸¸æ•°é‡ï¼ˆè¿™ä¸ªè¿ç»­å‘ç”Ÿåœ¨Retryé‡è¯•æœŸé—´ï¼‰ã€‚</span>
    <span class="token comment">// åœ¨é‡è¯•æœŸé—´ï¼Œä½†å‡¡æœ‰ä¸€æ¬¡æˆåŠŸäº†ï¼Œå°±ä¼šæŠŠæ­¤å‚æ•°ç½®ä¸º0ï¼ˆå¤±è´¥çš„è¯æ­¤å‚æ•°å°±ä¸€ç›´åŠ ï¼‰</span>
	<span class="token comment">// è¯´æ˜ï¼šåªæœ‰åœ¨å¼‚å¸¸ç±»å‹æ˜¯callErrorHandler.isCircuitTrippingException(e)çš„æ—¶å€™ï¼Œæ‰ä¼šç®—ä½œå¤±è´¥ï¼Œæ‰ä¼š+1 </span>
	<span class="token comment">// é»˜è®¤æƒ…å†µä¸‹åªæœ‰SocketException/SocketTimeoutExceptionè¿™ä¸¤ç§å¼‚å¸¸æ‰ç®—å¤±è´¥å“¦~</span>
    <span class="token annotation punctuation">@VisibleForTesting</span>
    <span class="token class-name">AtomicInteger</span> successiveConnectionFailureCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ´»è·ƒè¯·æ±‚æ•°é‡ï¼ˆæ­£åœ¨è¯·æ±‚çš„æ•°é‡ï¼Œå®ƒèƒ½ååº”è¯¥Serverçš„è´Ÿè½½ã€å‹åŠ›ï¼‰ã€‚ </span>
	<span class="token comment">// ä½†å‡¡åªè¦å¼€å§‹æ‰§è¡ŒSeveräº†ï¼Œå°±+1</span>
	<span class="token comment">// ä½†å‡¡åªè¦è¯·æ±‚å®Œæˆäº†/å‡ºé”™äº†ï¼Œå°±-1</span>
	<span class="token comment">// æ³¨æ„ï¼šå®ƒæœ‰æ—¶é—´çª—å£çš„æ¦‚å¿µï¼Œåé¢è®²å…·ä½“é€»è¾‘</span>
    <span class="token annotation punctuation">@VisibleForTesting</span>
    <span class="token class-name">AtomicInteger</span> activeRequestsCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@VisibleForTesting</span>
    <span class="token class-name">AtomicInteger</span> openConnectionsCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æœ€åä¸€æ¬¡å¤±è´¥çš„æ—¶é—´æˆ³ã€‚è‡³äºä»€ä¹ˆå«å¤±è´¥ï¼Œå‚è€ƒsuccessiveConnectionFailureCountå¯¹å¤±è´¥çš„åˆ¤æ–­é€»è¾‘</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> lastConnectionFailedTimestamp<span class="token punctuation">;</span>
	<span class="token comment">// ç®€å•çš„è¯´å°±æ˜¯activeRequestsCountçš„å€¼æœ€åå˜åŒ–çš„æ—¶é—´æˆ³</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> lastActiveRequestsCountChangeTimestamp<span class="token punctuation">;</span>
    <span class="token comment">// æ–­è·¯å™¨æ–­ç”µæ€»æ—¶é•¿ï¼ˆè¿ç»­å¤±è´¥&gt;=3æ¬¡ï¼Œå¢åŠ 20~30ç§’ã€‚å…·ä½“å¢åŠ å¤šå°‘ç§’ï¼Œåé¢æœ‰è®¡ç®—é€»è¾‘ï¼‰ã€‚</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicLong</span> totalCircuitBreakerBlackOutPeriod <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æœ€åè®¿é—®æ—¶é—´æˆ³ã€‚å’ŒlastActiveRequestsCountChangeTimestampçš„åŒºåˆ«æ˜¯ï¼Œå®ƒå¢/å‡éƒ½updateä¸€ä¸‹ï¼Œè€ŒlastAccessedTimestampåªæœ‰åœ¨å¢çš„æ—¶å€™æ‰ä¼šupdateä¸€ä¸‹ã€‚</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> lastAccessedTimestamp<span class="token punctuation">;</span>
    <span class="token comment">// é¦–æ¬¡è¿æ¥æ—¶é—´æˆ³ï¼Œåªä¼šè®°å½•é¦–æ¬¡è¯·æ±‚è¿›æ¥æ—¶çš„æ—¶é—´ã€‚</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> firstConnectionTimestamp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="loadbalancerstats" tabindex="-1"><a class="header-anchor" href="#loadbalancerstats" aria-hidden="true">#</a> LoadBalancerStats</h3><h2 id="spring-cloud-ribbon-é…ç½®æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ribbon-é…ç½®æ€»ç»“" aria-hidden="true">#</a> Spring Cloud Ribbon é…ç½®æ€»ç»“</h2><p>https://www.jianshu.com/p/f3db11f045cc</p></div><!----><footer class="page-meta"><!----><div class="meta-item update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="meta-item contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: 895252461@qq.com">xuliang</span>,<!--]--><!--[--><span class="contributor" title="email: 895252461@qq.com">è¯—äººéƒ½è—åœ¨æ°´åº•</span><!--]--><!--]--></div></footer><nav class="page-nav"><a href="/spring-cloud/spring-cloud-openfeign/spring-cloud-openfeign.html" class="nav-link prev" aria-label="Spring Cloud OpenFeign æºç è§£æ"><div class="hint"><span class="arrow left"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->Spring Cloud OpenFeign æºç è§£æ</div></a><!----></nav><!----><!----><!--]--></main><!--]--><!----><!--]--></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-c593f505.js" defer></script>
  </body>
</html>
